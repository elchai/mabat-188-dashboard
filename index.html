<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>מבט 188 | פלטפורמת מודיעין גזרתית</title>
<link rel="icon" type="image/jpeg" href="logo-188.jpg">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
/* ═══════════════════════════════════════
   MABAT 188 - CYBER DEFENSE DASHBOARD
   Futuristic Military Intelligence UI v2
   ═══════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

:root {
    --bg-primary: #040810;
    --bg-secondary: #0a1020;
    --bg-panel: rgba(8, 16, 35, 0.85);
    --bg-card: rgba(12, 22, 45, 0.9);
    --border-primary: #0f3460;
    --border-glow: #00d4ff;
    --cyan: #00d4ff;
    --cyan-dim: #00d4ff44;
    --green: #00ff88;
    --green-dim: #00ff8844;
    --red: #ff0040;
    --red-dim: #ff004044;
    --orange: #ff8800;
    --orange-dim: #ff880044;
    --yellow: #ffd000;
    --yellow-dim: #ffd00044;
    --blue: #4488ff;
    --purple: #a855f7;
    --purple-dim: #a855f744;
    --text-primary: #e0e8f0;
    --text-secondary: #9ab0c8;
    --text-dim: #6880a0;
    --font-display: 'Orbitron', 'Heebo', sans-serif;
    --font-body: 'Heebo', 'Rajdhani', sans-serif;
    --font-mono: 'Share Tech Mono', 'Heebo', monospace;
    --font-he: 'Heebo', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-weight: 400;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 100vh;
    width: 100vw;
}

/* ═══════ ANIMATED BACKGROUND ═══════ */
.bg-grid {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: 0;
    animation: gridPulse 4s ease-in-out infinite;
    pointer-events: none;
}

@keyframes gridPulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.scan-line {
    display: none;
}

/* ═══════ RADAR SONAR SWEEP ═══════ */
.radar-sweep {
    position: absolute;
    z-index: 999;
    pointer-events: none;
    border-radius: 50%;
    overflow: hidden;
}

.radar-sweep-line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent 5%, rgba(0, 212, 255, 0.5) 30%, rgba(0, 212, 255, 0.7) 50%, rgba(0, 212, 255, 0.5) 70%, transparent 95%);
    box-shadow: 0 0 12px rgba(0, 212, 255, 0.3), 0 0 25px rgba(0, 212, 255, 0.1);
    animation: sonarScanDown 4s ease-in-out infinite;
    z-index: 2;
}

.radar-sweep-trail {
    position: absolute;
    left: 0;
    width: 100%;
    height: 40px;
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.08), transparent);
    animation: sonarScanDown 4s ease-in-out infinite;
    z-index: 1;
}

@keyframes sonarScanDown {
    0% { top: 0%; }
    50% { top: 100%; }
    100% { top: 0%; }
}

.radar-crosshair {
    position: absolute;
    z-index: 998;
    pointer-events: none;
    border-radius: 50%;
    border: 1px solid rgba(0, 212, 255, 0.08);
}

.radar-ring-inner {
    position: absolute;
    z-index: 998;
    pointer-events: none;
    border-radius: 50%;
    border: 1px dashed rgba(0, 212, 255, 0.06);
}

.radar-center-dot {
    position: absolute;
    z-index: 998;
    pointer-events: none;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(0, 212, 255, 0.5);
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
}

/* ═══════ CORNER DECORATIONS ═══════ */
.corner-decor {
    position: fixed;
    width: 60px;
    height: 60px;
    z-index: 5;
    pointer-events: none;
}
.corner-decor::before, .corner-decor::after {
    content: '';
    position: absolute;
    background: var(--cyan);
    box-shadow: 0 0 10px var(--cyan);
}
.corner-tl { top: 10px; left: 10px; }
.corner-tl::before { width: 30px; height: 2px; top: 0; left: 0; }
.corner-tl::after { width: 2px; height: 30px; top: 0; left: 0; }
.corner-tr { top: 10px; right: 10px; }
.corner-tr::before { width: 30px; height: 2px; top: 0; right: 0; }
.corner-tr::after { width: 2px; height: 30px; top: 0; right: 0; }
.corner-bl { bottom: 10px; left: 10px; }
.corner-bl::before { width: 30px; height: 2px; bottom: 0; left: 0; }
.corner-bl::after { width: 2px; height: 30px; bottom: 0; left: 0; }
.corner-br { bottom: 10px; right: 10px; }
.corner-br::before { width: 30px; height: 2px; bottom: 0; right: 0; }
.corner-br::after { width: 2px; height: 30px; bottom: 0; right: 0; }

/* ═══════ MAIN LAYOUT ═══════ */
.dashboard {
    display: grid;
    grid-template-rows: 70px 420px 400px 480px;
    grid-template-columns: 280px 1fr 280px;
    min-height: 100vh;
    gap: 2px;
    padding: 8px;
    position: relative;
    z-index: 2;
}

/* ═══════ HEADER ═══════ */
.header {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    padding: 0 0;
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.08), transparent);
    border-bottom: 1px solid var(--border-primary);
    position: relative;
}

.header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 0 15px;
    justify-content: center;
}

.logo-hex {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: hexPulse 3s ease-in-out infinite;
    position: relative;
    filter: drop-shadow(0 0 8px var(--cyan-dim));
}

@keyframes hexPulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.4) drop-shadow(0 0 10px var(--cyan)); }
}

.system-title {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: 22px;
    letter-spacing: 4px;
    background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
}

.system-subtitle {
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 300;
    color: var(--text-secondary);
    text-align: center;
}

.hamburger-btn {
    display: none;
}

.header-center {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 0;
    padding: 0 10px;
    gap: 8px;
    flex-wrap: wrap;
}

.header-status-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-divider {
    width: 1px;
    height: 28px;
    background: var(--border-primary);
    flex-shrink: 0;
}

.header-actions-group {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 500;
}

.header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 5px 12px;
    min-width: auto;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 500;
    color: var(--cyan);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 1px;
    flex-shrink: 0;
}

.header-btn:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--cyan);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.header-btn .btn-icon {
    font-size: 14px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 10px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.status-dot.offline {
    background: var(--red);
    box-shadow: 0 0 10px var(--red);
}

@keyframes dotPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.header-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    font-family: var(--font-mono);
    padding: 0 25px;
    white-space: nowrap;
}

.clock {
    font-size: 17px;
    letter-spacing: 2px;
    color: var(--cyan);
    text-shadow: 0 0 10px var(--cyan-dim);
}

.date-display {
    font-size: 11px;
    color: var(--text-secondary);
}

/* ═══════ PANELS ═══════ */
.panel {
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
    opacity: 0.5;
    z-index: 1;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 212, 255, 0.03);
}

.panel-title {
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--cyan);
}

.panel-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.panel-body {
    padding: 12px;
    overflow-y: auto;
    height: calc(100% - 42px);
}

.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.panel-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 2px; }
.panel-body::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }

/* ═══════ LEFT PANEL ═══════ */
.left-panel {
    grid-row: 2 / 4;
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow: hidden;
    min-height: 0;
}

/* Threat Level */
.threat-container { flex: 0 0 230px; }
.threat-status-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 8px;
}

.threat-gauge {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    gap: 10px;
}

.threat-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid var(--border-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
    transition: all 0.5s ease;
}

.threat-circle::before {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-top-color: var(--cyan);
    animation: rotate 3s linear infinite;
}

.threat-circle::after {
    content: '';
    position: absolute;
    inset: -14px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-bottom-color: var(--cyan-dim);
    animation: rotate 5s linear infinite reverse;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.threat-circle.level-green { border-color: var(--green); box-shadow: 0 0 30px rgba(0, 255, 136, 0.2); }
.threat-circle.level-gray { border-color: #666; }
.threat-circle.level-blue { border-color: var(--blue); box-shadow: 0 0 30px rgba(68, 136, 255, 0.2); }
.threat-circle.level-yellow { border-color: var(--yellow); box-shadow: 0 0 30px rgba(255, 208, 0, 0.2); }
.threat-circle.level-orange { border-color: var(--orange); box-shadow: 0 0 30px rgba(255, 136, 0, 0.3); }
.threat-circle.level-red { border-color: var(--red); box-shadow: 0 0 40px rgba(255, 0, 64, 0.4); animation: threatPulse 1.5s ease-in-out infinite; }

@keyframes threatPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 64, 0.3); }
    50% { box-shadow: 0 0 60px rgba(255, 0, 64, 0.6); }
}

.threat-level-num {
    font-family: var(--font-display);
    font-size: 36px;
    font-weight: 900;
    line-height: 1;
}

.threat-level-label {
    font-family: var(--font-he);
    font-size: 11px;
    letter-spacing: 1px;
    font-weight: 500;
}

.threat-bars {
    display: flex;
    gap: 4px;
    width: 100%;
    height: 6px;
}

.threat-bar {
    flex: 1;
    border-radius: 2px;
    background: var(--bg-primary);
    transition: all 0.3s ease;
}

/* Stats */
.stats-container { flex: 0 0 auto; }

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.4);
}

.stat-label {
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 400;
    color: var(--text-secondary);
}

.stat-value {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    color: var(--cyan);
}

.stat-value.red { color: var(--red); }
.stat-value.orange { color: var(--orange); }
.stat-value.yellow { color: var(--yellow); }
.stat-value.green { color: var(--green); }

/* Sources */
.sources-container { flex: 0 0 auto; overflow: hidden; }
.sources-container .panel-header { cursor: pointer; user-select: none; }
.sources-container .panel-header:hover { background: rgba(0, 212, 255, 0.06); }
.sources-container .sources-toggle-icon { transition: transform 0.3s; font-size: 10px; color: var(--text-dim); }
.sources-container.expanded .sources-toggle-icon { transform: rotate(180deg); }
.sources-container .panel-body {
    height: 0;
    padding: 0 12px;
    overflow: hidden;
    transition: height 0.3s ease, padding 0.3s ease;
}
.sources-container.expanded .panel-body {
    height: 250px;
    padding: 12px;
    overflow-y: auto;
}

.source-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    font-family: var(--font-he);
    font-size: 11px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
}

.source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}

.source-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
.source-dot.inactive { background: #444; }

.source-name {
    flex: 1;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: var(--font-he);
    font-weight: 400;
}

.source-type {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 2px;
    border: 1px solid var(--border-primary);
}

.source-type.local { color: var(--green); border-color: var(--green-dim); }
.source-type.regional { color: var(--orange); border-color: var(--orange-dim); }
.source-type.national { color: var(--cyan); border-color: var(--cyan-dim); }
.source-type.news { color: var(--yellow); border-color: var(--yellow-dim); }

.source-count {
    color: var(--cyan);
    font-size: 10px;
}

/* ═══════ CENTER - MAP ═══════ */
.panel.map-panel { position: relative; transition: all 0.4s ease; overflow: hidden; }

.map-panel.fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    min-height: 100vh !important;
    max-height: none !important;
    z-index: 9999 !important;
    border-radius: 0 !important;
    grid-row: auto;
    grid-column: auto;
    margin: 0 !important;
    padding: 0 !important;
    order: -1 !important;
    border: none !important;
    background: #0a0a1a !important;
}
.map-panel.fullscreen #map {
    position: absolute !important;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100% !important;
    height: 100% !important;
}
.map-panel.fullscreen .map-legend {
    opacity: 0.8;
    bottom: 12px;
    right: 12px;
}

#map {
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
}

.leaflet-container {
    background: var(--bg-primary) !important;
    font-family: var(--font-mono) !important;
}

.map-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 1000;
    border: 1px solid var(--border-primary);
    box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.5);
}

.map-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: repeating-linear-gradient(90deg, transparent, transparent 4px, var(--cyan-dim) 4px, var(--cyan-dim) 5px);
}

.map-coords {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    z-index: 1001;
    pointer-events: none;
}

.map-label {
    position: absolute;
    top: 10px;
    right: 10px;
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 700;
    color: var(--cyan);
    z-index: 1001;
    pointer-events: none;
    text-shadow: 0 0 10px var(--cyan-dim);
}

.map-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1001;
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    color: var(--cyan);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-he);
    font-size: 12px;
    transition: all 0.3s ease;
}

.map-btn:hover {
    background: rgba(0, 212, 255, 0.15);
    border-color: var(--cyan);
    box-shadow: 0 0 10px var(--cyan-dim);
}

/* ═══════ RIGHT PANEL - AI SUMMARY ═══════ */
.right-panel {
    grid-row: 3 / 4;
    grid-column: 3 / 4;
    display: flex;
    flex-direction: column;
}

.summary-text {
    font-family: 'Heebo', var(--font-body);
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-primary);
    direction: rtl;
    white-space: pre-wrap;
    font-weight: 300;
}

.summary-meta {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-primary);
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    justify-content: space-between;
}

.ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 8px;
    border: 1px solid var(--cyan-dim);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--cyan);
    letter-spacing: 1px;
}

.ai-badge::before {
    content: '\25C6';
    font-size: 6px;
    animation: dotPulse 1.5s ease-in-out infinite;
}

/* Config Panel */
.config-panel {
    grid-row: 2 / 3;
    grid-column: 3 / 4;
}

.config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 400;
}

.config-key { color: var(--text-secondary); }
.config-val { color: var(--cyan); }

/* ═══════ SECTOR HISTORY PANEL ═══════ */
.sector-history-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #040810;
    z-index: 8000;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}
.sector-history-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: url('ops-room.jpg') center center / cover no-repeat;
    opacity: 0.1;
    z-index: -1;
    pointer-events: none;
}
.sector-history-overlay.visible { display: flex; }

.sh-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 15px 25px;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(180deg, rgba(168, 85, 247, 0.08), transparent);
    flex-shrink: 0;
}
.sh-title {
    font-family: var(--font-he);
    font-size: 18px;
    font-weight: 700;
    color: var(--purple);
}
.sh-tabs {
    display: flex;
    gap: 4px;
    flex: 1;
}
.sh-tab {
    padding: 6px 16px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: transparent;
    color: var(--text-secondary);
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}
.sh-tab:hover { border-color: var(--purple); color: var(--purple); }
.sh-tab.active {
    background: var(--purple);
    color: #fff;
    border-color: var(--purple);
}

.sh-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px 25px;
    direction: ltr;
}
.sh-content > * {
    direction: rtl;
}

.sh-summary-bar {
    display: flex;
    gap: 16px;
    padding: 12px 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border-primary);
    flex-wrap: wrap;
}
.sh-summary-stat {
    font-family: var(--font-he);
    font-size: 12px;
    color: var(--text-dim);
}
.sh-summary-stat strong {
    color: var(--cyan);
    font-family: var(--font-display);
    font-size: 16px;
    margin-left: 4px;
}

/* Location Cards */
.sh-locations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}
.sh-loc-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    padding: 14px;
    transition: border-color 0.2s;
    cursor: default;
}
.sh-loc-card:hover { border-color: var(--purple); }
.sh-loc-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.sh-loc-name {
    font-family: var(--font-he);
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
}
.sh-loc-count {
    font-family: var(--font-display);
    font-size: 20px;
    font-weight: 700;
    min-width: 36px;
    text-align: center;
    padding: 2px 8px;
    border-radius: 4px;
}
.sh-loc-bar {
    height: 6px;
    border-radius: 3px;
    background: var(--bg-primary);
    margin-bottom: 8px;
    overflow: hidden;
}
.sh-loc-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
}
.sh-loc-meta {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
}
.sh-loc-urgency-dots {
    display: flex;
    gap: 3px;
    margin-top: 6px;
}
.sh-loc-urgency-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
.sh-loc-last-event {
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(15, 52, 96, 0.3);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Zone Cards */
.sh-zones-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
}
.sh-zone-card {
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    overflow: hidden;
}
.sh-zone-header {
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
}
.sh-zone-name {
    font-family: var(--font-he);
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}
.sh-zone-count {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 700;
}
.sh-zone-body { padding: 12px 16px; }
.sh-zone-urgency-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}
.sh-zone-urg-badge {
    padding: 3px 10px;
    border-radius: 3px;
    font-family: var(--font-he);
    font-size: 10px;
    font-weight: 600;
}
.sh-zone-locations {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
}
.sh-zone-loc-tag {
    padding: 2px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-secondary);
}
.sh-zone-bar {
    height: 24px;
    border-radius: 4px;
    background: var(--bg-primary);
    display: flex;
    overflow: hidden;
    margin-bottom: 8px;
}
.sh-zone-bar-seg {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-mono);
    font-size: 9px;
    color: #000;
    font-weight: 700;
    min-width: 20px;
    transition: width 0.6s ease;
}

/* Timeline */
.sh-timeline-chart {
    margin-bottom: 20px;
}
.sh-timeline-months {
    display: flex;
    gap: 6px;
    align-items: flex-end;
    height: 200px;
    padding: 0 10px;
    border-bottom: 1px solid var(--border-primary);
}
.sh-month-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    height: 100%;
    cursor: pointer;
    transition: opacity 0.2s;
}
.sh-month-col:hover { opacity: 0.8; }
.sh-month-col.selected .sh-month-label { color: var(--purple); font-weight: 700; }
.sh-month-bar-stack {
    width: 100%;
    max-width: 40px;
    display: flex;
    flex-direction: column-reverse;
    border-radius: 3px 3px 0 0;
    overflow: hidden;
}
.sh-month-seg {
    width: 100%;
    transition: height 0.4s ease;
}
.sh-month-count {
    font-family: var(--font-display);
    font-size: 11px;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.sh-month-label {
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 8px;
    text-align: center;
}
.sh-timeline-details {
    padding: 10px 0;
}
.sh-timeline-detail-header {
    font-family: var(--font-he);
    font-size: 14px;
    font-weight: 600;
    color: var(--purple);
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-primary);
}
.sh-timeline-events {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.sh-timeline-event {
    display: flex;
    gap: 10px;
    padding: 8px 10px;
    background: var(--bg-card);
    border-radius: 4px;
    border-right: 3px solid;
    font-family: var(--font-he);
    font-size: 11px;
    color: var(--text-secondary);
    align-items: flex-start;
}
.sh-timeline-event-date {
    color: var(--text-dim);
    font-size: 10px;
    white-space: nowrap;
    min-width: 45px;
}
.sh-timeline-event-loc {
    color: var(--cyan);
    font-size: 10px;
    min-width: 80px;
}

@media (max-width: 900px) {
    .sh-header { flex-wrap: wrap; padding: 10px 15px; gap: 8px; }
    .sh-title { font-size: 14px; }
    .sh-tabs { width: 100%; }
    .sh-tab { flex: 1; text-align: center; font-size: 11px; padding: 6px 8px; }
    .sh-content { padding: 12px 15px; }
    .sh-locations-grid { grid-template-columns: 1fr; }
    .sh-zones-container { grid-template-columns: 1fr; }
    .sh-timeline-months { height: 150px; }
}

/* ═══════ WHATSAPP PANEL ═══════ */
.wa-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
}
.wa-overlay.visible { display: flex; }
.wa-panel {
    background: var(--bg-secondary);
    border: 1px solid #25D366;
    border-radius: 12px;
    width: 420px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 0 40px rgba(37, 211, 102, 0.15);
}
.wa-panel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(37, 211, 102, 0.05);
}
.wa-panel-title {
    flex: 1;
    font-family: var(--font-he);
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}
.wa-section {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
}
.wa-section-title {
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 600;
    color: #25D366;
    margin-bottom: 10px;
    letter-spacing: 0.5px;
}
.wa-status-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--font-he);
    font-size: 12px;
    color: var(--text-secondary);
}
.wa-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ff0040;
    box-shadow: 0 0 6px #ff004088;
}
.wa-status-dot.connected {
    background: #25D366;
    box-shadow: 0 0 6px #25D36688;
    animation: dotPulse 1.5s ease-in-out infinite;
}
.wa-field {
    margin-bottom: 8px;
}
.wa-field label {
    display: block;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 4px;
}
.wa-field input {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    transition: border-color 0.2s;
}
.wa-field input:focus { border-color: #25D366; }
.wa-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.wa-btn-connect {
    background: #25D366;
    color: #000;
}
.wa-btn-connect:hover { background: #20bd5a; }
.wa-btn-secondary {
    background: transparent;
    color: var(--cyan);
    border: 1px solid var(--border-primary);
}
.wa-btn-secondary:hover { border-color: var(--cyan); }
.wa-btn-stop {
    background: transparent;
    color: var(--red);
    border: 1px solid var(--red);
    width: 100%;
    margin-top: 10px;
}
.wa-btn-stop:hover { background: rgba(255, 0, 64, 0.1); }
.wa-groups-list {
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.wa-group-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    background: var(--bg-primary);
    border-radius: 4px;
    font-family: var(--font-he);
    font-size: 11px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: background 0.2s;
}
.wa-group-item:hover { background: rgba(37, 211, 102, 0.08); }
.wa-group-item.selected {
    background: rgba(37, 211, 102, 0.12);
    border: 1px solid rgba(37, 211, 102, 0.3);
    color: var(--text-primary);
}
.wa-group-item input[type="checkbox"] { accent-color: #25D366; }
.wa-monitor-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
}
.wa-stat-card {
    background: var(--bg-primary);
    border-radius: 4px;
    padding: 8px;
    text-align: center;
}
.wa-stat-card .wa-stat-num {
    font-family: var(--font-display);
    font-size: 18px;
    color: #25D366;
}
.wa-stat-card .wa-stat-label {
    font-family: var(--font-he);
    font-size: 9px;
    color: var(--text-dim);
}
.wa-recent-messages {
    max-height: 150px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.wa-msg-item {
    padding: 6px 8px;
    background: var(--bg-primary);
    border-radius: 4px;
    border-right: 2px solid #25D366;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-secondary);
}
.wa-msg-item .wa-msg-group { color: #25D366; font-size: 9px; font-weight: 600; }
.wa-msg-item .wa-msg-time { color: var(--text-dim); font-size: 9px; float: left; direction: ltr; }

/* ═══════ BOTTOM - ALERT FEED ═══════ */
.alert-feed { grid-column: 2 / 3; display: flex; flex-direction: column; }

.alert-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.filter-chip {
    padding: 3px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    font-family: var(--font-he);
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    color: var(--text-dim);
    letter-spacing: 1px;
}

.filter-chip:hover { border-color: var(--cyan-dim); color: var(--text-secondary); }
.filter-chip.active { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 212, 255, 0.08); }
.filter-chip.active.red { border-color: var(--red); color: var(--red); background: var(--red-dim); }
.filter-chip.active.orange { border-color: var(--orange); color: var(--orange); background: var(--orange-dim); }
.filter-chip.active.yellow { border-color: var(--yellow); color: var(--yellow); background: var(--yellow-dim); }
.filter-chip.active.blue { border-color: var(--blue); color: var(--blue); background: rgba(68,136,255,0.12); }
.filter-chip.active.purple { border-color: var(--purple); color: var(--purple); background: var(--purple-dim); }
.filter-chip.active.green { border-color: var(--green); color: var(--green); background: var(--green-dim); }

/* Anarchist toggle */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-he);
    font-size: 10px;
    font-weight: 500;
    color: var(--purple);
    padding: 0 8px;
}

.toggle-switch {
    position: relative;
    width: 32px;
    height: 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-switch.active {
    background: var(--purple-dim);
    border-color: var(--purple);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: all 0.3s ease;
}

.toggle-switch.active::after {
    left: 18px;
    background: var(--purple);
    box-shadow: 0 0 6px var(--purple);
}

.search-input {
    flex: 1;
    max-width: 220px;
    padding: 4px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 400;
    outline: none;
    direction: rtl;
    transition: border-color 0.3s ease;
}

.search-input::placeholder { color: var(--text-dim); }
.search-input:focus { border-color: var(--cyan); box-shadow: 0 0 8px var(--cyan-dim); }

.alert-feed .panel-body {
    padding: 0;
    flex: 1;
    overflow-y: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.alert-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 15px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    transition: background 0.3s ease;
    direction: rtl;
    cursor: pointer;
}

.alert-item:hover { background: rgba(0, 212, 255, 0.03); }

.alert-item.expanded {
    background: rgba(0, 212, 255, 0.05);
    flex-direction: column;
    gap: 8px;
}

.alert-item.new-alert { animation: alertFlash 2s ease; }
.alert-item.keyword-hit { border-right: 3px solid var(--yellow); background: rgba(255,208,0,0.06); }

@keyframes alertFlash {
    0% { background: rgba(0, 212, 255, 0.2); }
    100% { background: transparent; }
}

.alert-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    width: 100%;
}

.alert-time {
    font-family: var(--font-he);
    font-size: 10px;
    font-weight: 400;
    color: var(--text-dim);
    white-space: nowrap;
    min-width: 45px;
    padding-top: 2px;
}

.alert-urgency {
    width: 8px; min-width: 8px; height: 8px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
}

.alert-urgency.urgency-5 { background: var(--red); box-shadow: 0 0 10px var(--red); animation: dotPulse 1s ease-in-out infinite; }
.alert-urgency.urgency-4 { background: var(--orange); box-shadow: 0 0 8px var(--orange); }
.alert-urgency.urgency-3 { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
.alert-urgency.urgency-2 { background: var(--blue); box-shadow: 0 0 6px var(--blue); }
.alert-urgency.urgency-1 { background: #666; }
.alert-urgency.urgency-anarchist { background: var(--purple); box-shadow: 0 0 8px var(--purple); }
.alert-urgency.urgency-field { background: var(--green); box-shadow: 0 0 8px var(--green); }

.alert-content { flex: 1; min-width: 0; }

.alert-title {
    font-family: 'Heebo', var(--font-body);
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 3px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
}

/* ═══════ ALERT CHECKMARK ═══════ */
.alert-check {
    width: 22px;
    height: 22px;
    min-width: 22px;
    border: 1.5px solid var(--border-primary);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    color: transparent;
    transition: all 0.2s ease;
    margin-top: 2px;
    flex-shrink: 0;
}
.alert-check:hover {
    border-color: var(--cyan);
    background: rgba(0, 212, 255, 0.05);
}
.alert-check.checked {
    border-color: var(--green);
    color: var(--green);
    background: rgba(0, 255, 136, 0.1);
}
.alert-item.alert-checked {
    opacity: 0.5;
}
.alert-item.alert-checked .alert-title {
    text-decoration: line-through;
    text-decoration-color: var(--text-dim);
}

.alert-full-text {
    font-family: var(--font-he);
    font-size: 13px;
    font-weight: 300;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 8px 12px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.2);
    white-space: pre-wrap;
    direction: rtl;
}

.alert-meta-row {
    display: flex;
    gap: 10px;
    align-items: center;
    font-family: var(--font-he);
    font-size: 9px;
    font-weight: 400;
    color: var(--text-dim);
}

/* ═══════ VOTE BUTTONS ═══════ */
.vote-buttons { display:flex; gap:6px; align-items:center; margin-right:auto; }
.vote-btn { background:transparent; border:1px solid var(--border-primary); color:var(--text-dim); width:28px; height:28px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s ease; opacity:0.5; }
.vote-btn svg { width:14px; height:14px; fill:currentColor; }
.vote-btn:hover { opacity:1; }
.vote-btn.vote-like:hover { border-color:var(--cyan); color:var(--cyan); background:rgba(0,212,255,0.08); }
.vote-btn.vote-dislike:hover { border-color:var(--red); color:var(--red); background:rgba(255,0,64,0.08); }
.vote-btn.vote-like.active { border-color:var(--cyan); color:var(--cyan); background:rgba(0,212,255,0.12); opacity:1; }
.vote-btn.vote-dislike.active { border-color:var(--red); color:var(--red); background:rgba(255,0,64,0.12); opacity:1; }
.alert-item.alert-false { opacity:0.6; }
.alert-item.alert-false .alert-title { text-decoration:line-through; text-decoration-color:var(--red); }
.false-badge { display:inline-block; font-family:var(--font-he); font-size:9px; font-weight:700; color:var(--red); background:var(--red-dim); border:1px solid var(--red); border-radius:3px; padding:0px 5px; margin-left:6px; }
.verified-badge { display:inline-block; font-family:var(--font-he); font-size:9px; font-weight:700; color:var(--green); background:rgba(0,255,136,0.1); border:1px solid var(--green); border-radius:3px; padding:0px 5px; margin-left:6px; }

/* ═══════ PUBLISHER PROFILE OVERLAY ═══════ */
.publisher-overlay { position:fixed; top:0; left:0; right:0; bottom:0; z-index:8001; background:rgba(4,8,16,0.8); display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.publisher-overlay.visible { display:flex; }
.publisher-card { background:linear-gradient(180deg, rgba(10,20,45,0.95), rgba(4,8,16,0.98)); border:1px solid var(--border-primary); padding:25px; width:90%; max-width:460px; max-height:85vh; overflow-y:auto; direction:rtl; border-radius:6px; box-shadow:0 0 30px rgba(0,212,255,0.1), 0 8px 40px rgba(0,0,0,0.8); }
.publisher-card-header { display:flex; align-items:center; gap:15px; margin-bottom:18px; padding-bottom:12px; border-bottom:1px solid var(--border-primary); }
.publisher-photo { width:64px; height:64px; border-radius:50%; border:2px solid var(--cyan); object-fit:cover; background:var(--bg-secondary); flex-shrink:0; }
.publisher-photo-placeholder { width:64px; height:64px; border-radius:50%; border:2px solid var(--border-primary); background:var(--bg-secondary); display:flex; align-items:center; justify-content:center; font-size:24px; color:var(--text-dim); flex-shrink:0; }
.publisher-name { font-family:var(--font-he); font-size:18px; font-weight:700; color:var(--text-primary); }
.publisher-subtitle { font-family:var(--font-he); font-size:11px; color:var(--text-secondary); margin-top:2px; }
.publisher-info-grid { display:grid; grid-template-columns:auto 1fr; gap:8px 12px; margin-bottom:15px; }
.publisher-info-label { font-family:var(--font-he); font-size:11px; font-weight:500; color:var(--text-dim); white-space:nowrap; }
.publisher-info-value { font-family:var(--font-he); font-size:12px; color:var(--text-primary); }
.publisher-stats { display:flex; gap:12px; padding:10px 0; border-top:1px solid var(--border-primary); border-bottom:1px solid var(--border-primary); margin-bottom:12px; }
.publisher-stat-box { text-align:center; flex:1; }
.publisher-stat-value { font-family:var(--font-mono); font-size:16px; font-weight:700; color:var(--cyan); }
.publisher-stat-label { font-family:var(--font-he); font-size:9px; color:var(--text-dim); margin-top:2px; }
.publisher-actions { display:flex; gap:8px; justify-content:center; margin-top:12px; }
.publisher-btn { background:linear-gradient(180deg, rgba(10,20,50,0.6), rgba(4,8,20,0.8)); border:1px solid var(--border-primary); color:var(--text-secondary); font-family:var(--font-he); font-size:11px; padding:6px 14px; border-radius:4px; cursor:pointer; transition:all 0.2s ease; }
.publisher-btn:hover { border-color:var(--cyan); color:var(--cyan); }
.publisher-btn.primary { border-color:var(--cyan); color:var(--cyan); }
.publisher-edit-field { margin-bottom:8px; }
.publisher-edit-field label { display:block; font-family:var(--font-he); font-size:10px; color:var(--text-dim); margin-bottom:3px; }
.publisher-edit-field input, .publisher-edit-field textarea { width:100%; padding:6px 10px; border:1px solid var(--border-primary); background:rgba(0,0,0,0.3); color:var(--text-primary); font-family:var(--font-he); font-size:11px; border-radius:3px; outline:none; direction:rtl; }
.publisher-edit-field textarea { min-height:50px; resize:vertical; }
.source-link-clickable { cursor:pointer; transition:color 0.2s ease; }
.source-link-clickable:hover { color:var(--cyan) !important; text-decoration:underline; }

/* ═══════ ROW 4 - OSINT INTELLIGENCE PANELS ═══════ */
.osint-row {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);
    gap: 2px;
    min-height: 0;
}

.osint-panel {
    display: flex;
    flex-direction: column;
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    overflow: hidden;
    min-width: 0;
}

.osint-panel .panel-header {
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.06), transparent);
    flex-shrink: 0;
}

.osint-panel .panel-title {
    font-family: var(--font-he);
    font-size: 13px;
    font-weight: 700;
    color: var(--cyan);
    letter-spacing: 0.5px;
}

.osint-panel .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

/* WhatsApp Panel */
.wa-status-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(15,52,96,0.2);
    direction: rtl;
}
.wa-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    background: rgba(37,211,102,0.15);
    border: 1px solid rgba(37,211,102,0.3);
    flex-shrink: 0;
}
.wa-info { flex: 1; min-width: 0; }
.wa-name { font-family: var(--font-he); font-size: 12px; font-weight: 500; color: var(--text-primary); }
.wa-msg { font-family: var(--font-he); font-size: 10px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.wa-time { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); flex-shrink: 0; }
.wa-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 8px;
    font-weight: 700;
    color: #fff;
}
.wa-badge.hot { background: var(--red); }
.wa-badge.active { background: var(--orange); }
.wa-badge.normal { background: var(--blue); }
.wa-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    background: rgba(37,211,102,0.05);
    border-bottom: 1px solid rgba(37,211,102,0.15);
    font-family: var(--font-he);
    font-size: 10px;
    color: #25d366;
    direction: rtl;
}

/* Target Search Panel */
.target-search-box {
    display: flex;
    gap: 6px;
    padding: 8px 10px;
    border-bottom: 1px solid var(--border-primary);
    direction: rtl;
}
.target-search-box input {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid var(--border-primary);
    background: rgba(0,0,0,0.3);
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 11px;
    border-radius: 3px;
    outline: none;
    direction: rtl;
}
.target-search-box input:focus { border-color: var(--cyan); box-shadow: 0 0 8px var(--cyan-dim); }
.target-search-box button {
    padding: 6px 14px;
    border: 1px solid var(--cyan);
    background: rgba(0,212,255,0.08);
    color: var(--cyan);
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 500;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
}
.target-search-box button:hover { background: rgba(0,212,255,0.2); }
.target-result {
    padding: 10px;
    border-bottom: 1px solid rgba(15,52,96,0.2);
    direction: rtl;
}
.target-platform {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    margin: 2px;
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 9px;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
}
.target-platform.found { border-color: var(--green); color: var(--green); background: rgba(0,255,136,0.06); }
.target-platform.not-found { border-color: var(--border-primary); color: var(--text-dim); opacity: 0.5; }
.target-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}
.target-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--cyan);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    background: rgba(0,212,255,0.08);
}
.target-name { font-family: var(--font-he); font-size: 14px; font-weight: 700; color: var(--text-primary); }
.target-username { font-family: var(--font-mono); font-size: 10px; color: var(--cyan); }
.target-stats {
    display: flex;
    gap: 12px;
    margin: 8px 0;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
}
.target-stat-num { color: var(--cyan); font-weight: 700; font-size: 14px; display: block; }

/* Network Graph Panel */
.network-container {
    width: 100%;
    height: 100%;
    min-height: 350px;
    position: relative;
}
.network-controls {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 10;
    display: flex;
    gap: 4px;
}
.net-btn {
    padding: 4px 10px;
    border: 1px solid var(--border-primary);
    background: rgba(4,8,16,0.85);
    color: var(--text-secondary);
    font-family: var(--font-he);
    font-size: 9px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
}
.net-btn:hover, .net-btn.active { border-color: var(--cyan); color: var(--cyan); }
.net-legend {
    position: absolute;
    bottom: 8px;
    right: 8px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 3px;
    font-family: var(--font-mono);
    font-size: 8px;
    color: var(--text-dim);
    direction: rtl;
}
.net-legend-item { display: flex; align-items: center; gap: 5px; }
.net-legend-dot { width: 8px; height: 8px; border-radius: 50%; }

/* FIRMS layer toggle on map */
.firms-toggle {
    position: absolute;
    bottom: 50px;
    left: 10px;
    z-index: 1000;
    padding: 5px 10px;
    border: 1px solid var(--orange);
    background: rgba(4,8,16,0.85);
    color: var(--orange);
    font-family: var(--font-mono);
    font-size: 9px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
}
.firms-toggle:hover, .firms-toggle.active { background: rgba(255,136,0,0.2); }

/* ═══════ KEYWORDS OVERLAY ═══════ */
.keywords-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(4,8,16,0.97); z-index:8000; display:none; flex-direction:column; }
.keywords-overlay.visible { display:flex; }
.keywords-header { display:flex; align-items:center; justify-content:space-between; padding:15px 25px; background:linear-gradient(180deg, rgba(10,20,50,0.5), rgba(4,8,16,0.95)); border-bottom:1px solid var(--border-primary); }
.keywords-title { font-family:var(--font-he); font-size:18px; font-weight:700; color:var(--cyan); }
.keywords-body { flex:1; overflow-y:auto; padding:20px; }
.keyword-category { margin-bottom:12px; padding:12px; background:var(--bg-card); border:1px solid var(--border-primary); border-radius:4px; }
.keyword-category-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.keyword-category-name { font-family:var(--font-he); font-size:14px; font-weight:600; color:var(--text-primary); }
.keyword-category-count { font-family:var(--font-mono); font-size:10px; color:var(--text-dim); padding:2px 8px; border:1px solid var(--border-primary); border-radius:3px; }
.keyword-tags { display:flex; flex-wrap:wrap; gap:5px; direction:rtl; }
.keyword-tag { font-family:var(--font-he); font-size:11px; padding:3px 8px; background:rgba(0,212,255,0.05); border:1px solid var(--border-primary); border-radius:3px; color:var(--text-secondary); }
.keyword-urgency-badge { display:inline-block; font-family:var(--font-mono); font-size:8px; padding:0 4px; border-radius:2px; }
.keywords-stat-bar { display:flex; gap:12px; padding:8px 25px; flex-wrap:wrap; border-bottom:1px solid var(--border-primary); }
.keywords-stat { font-family:var(--font-he); font-size:11px; color:var(--text-secondary); }
.keywords-stat strong { font-family:var(--font-mono); font-size:13px; }

.alert-source {
    font-family: var(--font-he);
    font-size: 9px;
    font-weight: 400;
    color: var(--text-dim);
    white-space: nowrap;
    padding: 2px 6px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    margin-top: 2px;
}

/* ═══════ TIMELINE GRAPH ═══════ */
.timeline-graph {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.timeline-label {
    font-family: var(--font-he);
    font-size: 9px;
    color: var(--text-dim);
    margin-bottom: 4px;
    font-weight: 400;
}

.timeline-bars {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 35px;
}

.timeline-bar {
    flex: 1;
    min-width: 2px;
    background: var(--cyan-dim);
    border-radius: 1px 1px 0 0;
    transition: all 0.3s ease;
    position: relative;
}

.timeline-bar:hover {
    opacity: 0.8;
}

.timeline-bar.has-red { background: var(--red); box-shadow: 0 0 4px var(--red-dim); }
.timeline-bar.has-orange { background: var(--orange); }
.timeline-bar.has-yellow { background: var(--yellow); }
.timeline-bar.has-blue { background: var(--blue); }

.timeline-hours {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: 8px;
    color: var(--text-dim);
    margin-top: 2px;
}

/* ═══════ HISTORY OVERLAY ═══════ */
.history-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #040810;
    z-index: 8000;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}
.history-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: url('ops-room.jpg') center center / cover no-repeat;
    opacity: 0.15;
    z-index: -1;
    pointer-events: none;
}

.history-overlay.visible {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 25px;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.06), transparent);
}

.history-title {
    font-family: var(--font-he);
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--cyan);
}

.history-close {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.history-close:hover {
    border-color: var(--red);
    color: var(--red);
}

.history-filters {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 25px;
    border-bottom: 1px solid var(--border-primary);
    flex-wrap: wrap;
}

.history-search {
    flex: 1;
    max-width: 300px;
    padding: 6px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 400;
    outline: none;
    direction: rtl;
}

.history-search:focus { border-color: var(--cyan); }

.history-date-filter {
    padding: 5px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 11px;
}

.history-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px 25px;
}

.history-body::-webkit-scrollbar { width: 6px; }
.history-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.history-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }

.history-date-group {
    margin-bottom: 20px;
}

.history-date-header {
    font-family: var(--font-he);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--cyan);
    padding: 8px 0;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 8px;
    position: sticky;
    top: 0;
    background: rgba(4, 8, 16, 0.95);
    z-index: 1;
}

.history-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.2);
    border-radius: 4px;
    transition: background 0.2s ease;
    direction: rtl;
}

.history-item:hover {
    background: rgba(0, 212, 255, 0.03);
}

.history-item-time {
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 400;
    color: var(--text-dim);
    min-width: 50px;
    padding-top: 2px;
}

.history-item-urgency {
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-top: 4px;
    flex-shrink: 0;
}

.history-item-content {
    flex: 1;
}

.history-item-title {
    font-family: var(--font-he);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 4px;
}

.history-item-text {
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 300;
    color: var(--text-secondary);
    line-height: 1.5;
}

.history-item-source {
    font-family: var(--font-he);
    font-size: 10px;
    font-weight: 400;
    color: var(--text-dim);
    margin-top: 4px;
}

/* Journal notes */
.journal-note-btn {
    background: none;
    border: 1px solid var(--border-primary);
    color: var(--cyan);
    font-family: var(--font-he);
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.journal-note-btn:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--cyan);
}
.journal-note-form {
    margin-top: 8px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.journal-note-form input,
.journal-note-form textarea {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 11px;
    padding: 6px 8px;
    outline: none;
    direction: rtl;
}
.journal-note-form input:focus,
.journal-note-form textarea:focus {
    border-color: var(--cyan);
    box-shadow: 0 0 5px var(--cyan-dim);
}
.journal-note-form textarea {
    resize: vertical;
    min-height: 40px;
}
.journal-note-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
}
.journal-note-save {
    background: rgba(0, 255, 136, 0.15);
    border: 1px solid var(--green);
    color: var(--green);
    font-family: var(--font-he);
    font-size: 10px;
    padding: 4px 12px;
    border-radius: 3px;
    cursor: pointer;
}
.journal-note-cancel {
    background: none;
    border: 1px solid var(--border-primary);
    color: var(--text-dim);
    font-family: var(--font-he);
    font-size: 10px;
    padding: 4px 12px;
    border-radius: 3px;
    cursor: pointer;
}
.journal-saved-note {
    margin-top: 6px;
    padding: 6px 8px;
    background: rgba(0, 212, 255, 0.05);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-he);
    font-size: 11px;
    color: var(--text-secondary);
    direction: rtl;
}
.journal-saved-note strong {
    color: var(--cyan);
    font-weight: 500;
}

/* ═══════ FIELD REPORT FORM ═══════ */
.report-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 8000;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}
.report-overlay.visible { display: flex; }
.report-form {
    background: var(--bg-card);
    border: 1px solid var(--border-glow);
    border-radius: 8px;
    padding: 25px;
    width: 90%;
    max-width: 420px;
    direction: rtl;
    box-shadow: 0 0 40px rgba(0, 212, 255, 0.15);
}
.report-form-title {
    font-family: var(--font-he);
    font-size: 16px;
    font-weight: 700;
    color: var(--green);
    margin-bottom: 15px;
    text-align: center;
}
.report-field {
    margin-bottom: 10px;
}
.report-field label {
    display: block;
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 4px;
}
.report-field input,
.report-field textarea,
.report-field select {
    width: 100%;
    padding: 8px 10px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--text-primary);
    font-family: var(--font-he);
    font-size: 12px;
    outline: none;
    direction: rtl;
    box-sizing: border-box;
}
.report-field input:focus,
.report-field textarea:focus,
.report-field select:focus {
    border-color: var(--green);
    box-shadow: 0 0 8px var(--green-dim);
}
.report-field textarea { resize: vertical; min-height: 60px; }
.report-field select { cursor: pointer; }
.report-field select option { background: #0a1020; color: var(--text-primary); }
.report-urgency-row {
    display: flex;
    gap: 8px;
}
.report-urgency-btn {
    flex: 1;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--border-primary);
    background: none;
    color: var(--text-dim);
    font-family: var(--font-he);
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}
.report-urgency-btn.selected { font-weight: 700; }
.report-urgency-btn[data-urg="5"].selected { border-color: var(--red); color: var(--red); background: var(--red-dim); }
.report-urgency-btn[data-urg="4"].selected { border-color: var(--orange); color: var(--orange); background: var(--orange-dim); }
.report-urgency-btn[data-urg="3"].selected { border-color: var(--yellow); color: var(--yellow); background: var(--yellow-dim); }
.report-urgency-btn[data-urg="2"].selected { border-color: var(--blue); color: var(--blue); background: rgba(68,136,255,0.15); }
.report-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.report-submit {
    flex: 1;
    padding: 10px;
    background: rgba(0, 255, 136, 0.12);
    border: 1px solid var(--green);
    border-radius: 4px;
    color: var(--green);
    font-family: var(--font-he);
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
}
.report-cancel {
    padding: 10px 20px;
    background: none;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--text-dim);
    font-family: var(--font-he);
    font-size: 13px;
    cursor: pointer;
}

.history-stat-bar {
    display: flex;
    gap: 15px;
    padding: 10px 25px;
    border-bottom: 1px solid var(--border-primary);
    font-family: var(--font-he);
    font-size: 12px;
    font-weight: 400;
}

.history-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
}

.history-stat strong {
    color: var(--cyan);
    font-family: var(--font-he);
    font-weight: 700;
}

/* ═══════ RED ALERT FLASH ═══════ */
.red-alert-flash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
}

.red-alert-flash.active {
    animation: redFlash 3s ease-out;
}

@keyframes redFlash {
    0% { opacity: 1; background: rgba(255, 0, 64, 0.3); }
    10% { opacity: 0.8; background: rgba(255, 0, 64, 0.15); }
    20% { opacity: 1; background: rgba(255, 0, 64, 0.25); }
    30% { opacity: 0.5; background: rgba(255, 0, 64, 0.1); }
    100% { opacity: 0; }
}

/* ═══════ LOADING / EMPTY ═══════ */
.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 15px;
    color: var(--text-dim);
    font-family: var(--font-he);
    font-size: 12px;
}

.loading-spinner {
    width: 40px; height: 40px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-dim);
    font-family: var(--font-he);
    font-size: 12px;
}

/* ═══════ REFRESH BAR ═══════ */
.refresh-bar {
    position: fixed;
    bottom: 0; left: 0;
    height: 2px;
    background: var(--cyan);
    z-index: 1001;
    transition: width 1s linear;
    box-shadow: 0 0 10px var(--cyan);
}

/* ═══════ URGENCY TAG ═══════ */
.urgency-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 2px;
    font-family: var(--font-he);
    font-size: 9px;
    font-weight: 600;
}

.urgency-tag.red { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
.urgency-tag.orange { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange); }
.urgency-tag.yellow { background: var(--yellow-dim); color: var(--yellow); border: 1px solid var(--yellow); }
.urgency-tag.blue { background: rgba(68,136,255,0.15); color: var(--blue); border: 1px solid var(--blue); }

/* ═══════ RESPONSIVE ═══════ */
@media (max-width: 1200px) {
    .dashboard { grid-template-columns: 220px 1fr 220px; }
    .header { grid-template-columns: auto 1fr auto; }
    .osint-row { grid-template-columns: 1fr 1fr; }
    .osint-row .osint-panel:last-child { grid-column: 1 / -1; }
}

@media (max-width: 900px) {
    body { overflow-y: auto; overflow-x: hidden; }

    .dashboard {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding: 4px;
        gap: 4px;
    }

    /* ── HEADER: compact single row ── */
    .header {
        display: flex;
        flex-wrap: wrap;
        padding: 6px 10px;
        gap: 6px;
        min-height: auto;
        height: auto;
        justify-content: center;
        position: relative;
    }
    .logo-section {
        width: auto;
        gap: 8px;
        order: 1;
    }
    .system-title { font-size: 14px; letter-spacing: 2px; }
    .system-subtitle { display: none; }
    .logo-hex { width: 30px; height: 30px; }
    .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
        order: 2;
        padding: 0;
        margin-right: auto;
    }
    .header-right .clock { font-size: 13px; }
    .header-right .date-display { font-size: 8px; }
    .header-divider { display: none; }
    .hamburger-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        order: 2;
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--cyan);
        font-size: 20px;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: auto;
    }
    .header-center {
        display: none;
        width: 100%;
        order: 10;
        gap: 4px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 6px 0;
        border-top: 1px solid var(--border-primary);
    }
    .header-center.menu-open {
        display: flex;
    }
    .header-actions-group {
        gap: 6px;
        justify-content: center;
        width: 100%;
        flex-wrap: wrap;
        align-items: stretch;
    }
    .header-actions-group .header-btn {
        padding: 6px 12px;
        font-size: 11px;
        min-width: 0;
        flex: 1 1 auto;
        max-width: 160px;
        text-align: center;
        justify-content: center;
        height: 36px;
        box-sizing: border-box;
    }
    .header-actions-group .header-btn .btn-icon { font-size: 12px; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; }
    .logo-hex {
        width: 30px;
        height: 30px;
        overflow: hidden;
    }
    .logo-hex img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* ── CONTENT ORDER ── */
    .map-panel {
        height: 40vh;
        min-height: 250px;
        order: 1;
    }

    .left-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
        order: 2;
        overflow: visible;
    }
    .threat-container { flex: none; }
    .threat-container { grid-column: 1; }
    .stats-container { flex: none; grid-column: 2; }
    .sources-container { grid-column: 1 / -1; }
    .threat-gauge { padding: 8px; }
    .threat-circle { width: 80px; height: 80px; }
    .threat-level-num { font-size: 24px; }
    .threat-status-row { gap: 4px; }
    .threat-status-row .status-badge { padding: 2px 5px; font-size: 8px; }

    .alert-feed {
        min-height: 250px;
        max-height: 400px;
        order: 3;
    }
    .alert-toolbar { flex-wrap: wrap; gap: 3px; padding: 4px 8px; }
    .filter-chip { padding: 3px 6px; font-size: 9px; }
    .search-input { max-width: 100%; min-width: 100px; }
    .timeline-graph { padding: 4px 8px; }
    .timeline-bars { height: 20px; }
    .alert-item { padding: 8px 10px; gap: 6px; }
    .alert-title { font-size: 11px; -webkit-line-clamp: 2; }
    .alert-source { font-size: 8px; padding: 1px 4px; }

    .right-panel { order: 4; min-height: 150px; }
    .config-panel { order: 5; }

    .panel-title { font-size: 9px; letter-spacing: 1px; }
    .stat-label { font-size: 10px; }
    .stat-value { font-size: 13px; }

    .map-btn { font-size: 11px; padding: 6px 12px; z-index: 10000; }
    .map-panel.fullscreen { position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; min-height: 100vh !important; z-index: 9999 !important; }
    .map-panel.fullscreen .map-btn { top: 10px; left: 10px; font-size: 14px; padding: 10px 18px; }

    .history-header { padding: 8px 12px; }
    .history-title { font-size: 13px; }
    .history-filters { padding: 6px 12px; gap: 4px; }
    .history-body { padding: 8px 12px; }
    .history-item { padding: 6px; }
    .history-stat-bar { padding: 6px 12px; gap: 6px; font-size: 9px; flex-wrap: wrap; }

    .corner-decor { display: none; }

    .osint-row { display: flex; flex-direction: column; gap: 4px; order: 6; }
    .osint-panel { min-height: 55vh; }
    .osint-panel .panel-body { position: static !important; display: flex; flex-direction: column; }
    .network-controls {
        position: static;
        padding: 6px 8px;
        border-bottom: 1px solid var(--border-primary);
        background: rgba(0, 0, 0, 0.2);
        justify-content: center;
        flex-shrink: 0;
    }
    .network-container { min-height: 50vh; flex: 1; }
    .net-legend {
        position: static;
        padding: 6px 8px;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .logo-section { gap: 6px; }
    .system-title { font-size: 12px; }
    .header-right .clock { font-size: 11px; }
    .header-actions-group .header-btn { padding: 3px 6px; font-size: 8px; }
    .map-panel { height: 35vh; min-height: 200px; }
    .left-panel { grid-template-columns: 1fr 1fr; }
    .threat-circle { width: 65px; height: 65px; }
    .threat-level-num { font-size: 20px; }
    .alert-toolbar .toggle-container span:last-child { display: none; }
}

/* Dark tooltip */
.dark-tooltip {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    font-family: 'Rajdhani', 'Share Tech Mono', monospace !important;
    font-size: 11px !important;
    padding: 8px 12px !important;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.25) !important;
    max-width: 280px !important;
}
/* Tooltip arrows for all directions */
.dark-tooltip::before { border-top-color: #0f3460 !important; }
.leaflet-tooltip-right.dark-tooltip::before { border-right-color: #0f3460 !important; border-top-color: transparent !important; }
.leaflet-tooltip-left.dark-tooltip::before { border-left-color: #0f3460 !important; border-top-color: transparent !important; }
.leaflet-tooltip-bottom.dark-tooltip::before { border-bottom-color: #0f3460 !important; border-top-color: transparent !important; }

/* ═══════ MAP LEGEND ═══════ */
.map-legend {
    position: absolute;
    bottom: 8px;
    right: 8px;
    z-index: 10001;
    background: rgba(4, 8, 16, 0.9);
    border: 1px solid var(--cyan-dim);
    border-radius: 4px;
    padding: 6px 8px;
    font-family: var(--font-he);
    font-size: 9px;
    direction: rtl;
    pointer-events: auto;
    max-width: 120px;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
}
.legend-title {
    font-family: var(--font-he);
    font-size: 9px;
    font-weight: 700;
    color: var(--cyan);
    margin-bottom: 4px;
    text-align: center;
}
.legend-subtitle {
    font-size: 8px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 2px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 1px 0;
    color: var(--text-primary);
    font-size: 9px;
    font-weight: 400;
}
.legend-circle {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
}
.legend-ring {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    border: 2px solid;
    background: transparent;
    flex-shrink: 0;
}
.legend-divider {
    height: 1px;
    background: var(--border-primary);
    margin: 3px 0;
}

.threat-ring-pulse {
    animation: ringPulse 2s ease-in-out infinite;
}
@keyframes ringPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 0.3; }
}

.leaflet-popup-content-wrapper {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.2) !important;
}
.leaflet-popup-tip { background: rgba(8, 16, 35, 0.95) !important; }

/* ═══════ ROUTE LINES ═══════ */
.route-line {
    filter: drop-shadow(0 0 4px currentColor);
}

/* ═══════ 3D SECTOR CIRCLE ═══════ */
.sector-ring {
    filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.5)) drop-shadow(0 0 20px rgba(0, 212, 255, 0.2));
    animation: sectorPulse 3s ease-in-out infinite;
}
.sector-outer-glow {
    filter: drop-shadow(0 0 15px rgba(0, 212, 255, 0.3));
}
.sector-center-glow {
    filter: drop-shadow(0 0 12px rgba(0, 212, 255, 0.6));
    animation: centerGlow 2s ease-in-out infinite;
}
.sector-center-dot {
    filter: drop-shadow(0 0 6px rgba(0, 212, 255, 0.8));
}
@keyframes sectorPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}
@keyframes centerGlow {
    0%, 100% { opacity: 0.6; filter: drop-shadow(0 0 12px rgba(0, 212, 255, 0.6)); }
    50% { opacity: 1; filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.9)); }
}

/* ═══════ 3D MARKERS ═══════ */
.marker-3d {
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.6)) drop-shadow(0 0 6px currentColor);
    transition: filter 0.2s ease, opacity 0.2s ease;
}
.marker-3d:hover {
    filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.6)) drop-shadow(0 0 14px currentColor) brightness(1.4);
}
.marker-glow-ring {
    animation: markerGlowPulse 2.5s ease-in-out infinite;
}
@keyframes markerGlowPulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.8; }
}
.marker-key {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.7)) drop-shadow(0 0 8px rgba(255, 136, 0, 0.5));
}
.marker-outside {
    opacity: 0.6;
}
.marker-outside:hover {
    opacity: 1;
}
.marker-city {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)) drop-shadow(0 0 10px currentColor);
}

/* ═══════ LOGIN SCREEN ═══════ */
.login-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 99999;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.login-overlay .bg-grid-login {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        linear-gradient(rgba(0, 212, 255, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridPulse 4s ease-in-out infinite;
    pointer-events: none;
}

.login-overlay .scan-line-login {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    animation: scanDown 5s linear infinite;
    opacity: 0.3;
    pointer-events: none;
}

.login-box {
    position: relative;
    z-index: 10;
    text-align: center;
    padding: 50px 60px;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    background: rgba(8, 16, 35, 0.9);
    box-shadow: 0 0 60px rgba(0, 212, 255, 0.08), inset 0 0 40px rgba(0, 0, 0, 0.3);
    min-width: 380px;
    max-width: 450px;
}

.login-box::before {
    content: '';
    position: absolute;
    top: -1px; left: -1px; right: -1px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
}

.login-box::after {
    content: '';
    position: absolute;
    bottom: -1px; left: -1px; right: -1px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan-dim), transparent);
}

.login-hex {
    width: 100px;
    height: 100px;
    margin: 0 auto 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: hexPulse 3s ease-in-out infinite;
    filter: drop-shadow(0 0 15px var(--cyan-dim));
}

.login-title {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 900;
    letter-spacing: 6px;
    background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    margin-bottom: 8px;
}

.login-subtitle {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
    letter-spacing: 3px;
    margin-bottom: 35px;
}

.login-field {
    position: relative;
    margin-bottom: 20px;
}

.login-field label {
    display: block;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
    text-align: right;
    margin-bottom: 6px;
    font-weight: 400;
}

.login-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--cyan);
    font-family: var(--font-mono);
    font-size: 18px;
    letter-spacing: 8px;
    text-align: center;
    outline: none;
    transition: all 0.3s ease;
    direction: ltr;
}

.login-input:focus {
    border-color: var(--cyan);
    box-shadow: 0 0 20px var(--cyan-dim);
}

.login-input.error {
    border-color: var(--red);
    box-shadow: 0 0 20px var(--red-dim);
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
}

.login-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(68, 136, 255, 0.15));
    border: 1px solid var(--cyan-dim);
    border-radius: 4px;
    color: var(--cyan);
    font-family: var(--font-he);
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.25), rgba(68, 136, 255, 0.25));
    border-color: var(--cyan);
    box-shadow: 0 0 25px var(--cyan-dim);
}

.login-error {
    font-family: var(--font-he);
    font-size: 11px;
    color: var(--red);
    height: 16px;
    margin-top: 10px;
    letter-spacing: 1px;
}

.login-classification {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--red);
    z-index: 2;
    text-shadow: 0 0 10px var(--red-dim);
    pointer-events: none;
}

.login-footer {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    z-index: 2;
    pointer-events: none;
    white-space: nowrap;
}

/* ═══════ CREDIT FOOTER ═══════ */
.credit-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    text-align: center;
    padding: 4px 10px;
    font-family: var(--font-he);
    font-size: 10px;
    color: var(--text-dim);
    background: linear-gradient(0deg, rgba(4, 8, 16, 0.9), transparent);
    letter-spacing: 1px;
    pointer-events: auto;
}

.credit-footer a {
    color: var(--green);
    text-decoration: none;
    transition: color 0.3s ease;
}

.credit-footer a:hover {
    color: var(--cyan);
    text-shadow: 0 0 8px var(--cyan-dim);
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:#040810;display:flex;align-items:center;justify-content:center;flex-direction:column;">
    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(0,212,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;"></div>
    <div style="position:absolute;top:15px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:#ff0040;pointer-events:none;white-space:nowrap;">CLASSIFIED // RESTRICTED ACCESS</div>
    <div style="position:relative;z-index:10;text-align:center;padding:50px 60px;border:1px solid #0f3460;border-radius:8px;background:rgba(8,16,35,0.9);box-shadow:0 0 60px rgba(0,212,255,0.08);min-width:340px;">
        <div style="width:100px;height:100px;margin:0 auto 25px;display:flex;align-items:center;justify-content:center;">
            <img src="logo-188.jpg" alt="MABAT 188" width="100" height="100" style="border-radius:8px;filter:drop-shadow(0 0 15px rgba(0,212,255,0.4));"/>
        </div>
        <div style="font-family:'Orbitron',monospace;font-size:28px;font-weight:900;letter-spacing:6px;margin-bottom:8px;white-space:nowrap;background:linear-gradient(90deg,#00d4ff,#fff,#00d4ff);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">MABAT 188</div>
        <div style="font-family:'Heebo',sans-serif;font-size:13px;font-weight:300;color:#7088a0;letter-spacing:2px;margin-bottom:35px;">פלטפורמת מודיעין גזרתית</div>
        <div id="googleSignInBtn" style="display:flex;justify-content:center;margin-bottom:15px;"></div>
        <div id="loginError" style="font-family:'Heebo',sans-serif;font-size:12px;color:#ff0040;min-height:20px;margin-top:10px;letter-spacing:0.5px;"></div>
    </div>
    <div style="position:absolute;bottom:15px;font-family:'Heebo',sans-serif;font-size:11px;color:#6880a0;pointer-events:auto;"><a href="https://wa.me/972542012000" target="_blank" style="color:#00ff88;text-decoration:none;">נבנה ע"י אלחי פיין | 054-201-2000</a></div>
</div>
<script>
const GOOGLE_CLIENT_ID = '37806096141-2fsablk05orj28dqkftde501bq1rmcti.apps.googleusercontent.com';
const ALLOWED_EMAILS = [
    'shachar.mandel@gmail.com',
    'itaydardikman95@gmail.com',
    'elchaifinn@gmail.com',
    'elishav0028@gmail.com'
];

function handleGoogleCredential(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    const email = (payload.email || '').toLowerCase();
    if (ALLOWED_EMAILS.includes(email)) {
        sessionStorage.setItem('mabat188-auth', email);
        var ov = document.getElementById('loginOverlay');
        ov.style.transition = 'opacity 0.8s ease';
        ov.style.opacity = '0';
        setTimeout(function() { ov.style.display = 'none'; }, 800);
    } else {
        document.getElementById('loginError').textContent = 'אין לך הרשאת גישה למערכת // ACCESS DENIED';
        setTimeout(function() { document.getElementById('loginError').textContent = ''; }, 3000);
    }
}

function doLogout() {
    sessionStorage.removeItem('mabat188-auth');
    location.reload();
}

// Check existing session
(function() {
    var savedEmail = sessionStorage.getItem('mabat188-auth');
    if (savedEmail && ALLOWED_EMAILS.includes(savedEmail.toLowerCase())) {
        var ov = document.getElementById('loginOverlay');
        ov.style.display = 'none';
    }
})();

// Initialize Google Sign-In when library loads
window.addEventListener('load', function() {
    if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleCredential
        });
        google.accounts.id.renderButton(
            document.getElementById('googleSignInBtn'),
            { theme: 'filled_black', size: 'large', shape: 'rectangular', text: 'signin_with', locale: 'he' }
        );
    } else {
        document.getElementById('googleSignInBtn').innerHTML = '<div style="color:#ff0040;font-size:11px;">שגיאה בטעינת Google Sign-In</div>';
    }
});
</script>

<!-- Background Effects -->
<div class="bg-grid"></div>
<div class="scan-line"></div>
<div class="corner-decor corner-tl"></div>
<div class="corner-decor corner-tr"></div>
<div class="corner-decor corner-bl"></div>
<div class="corner-decor corner-br"></div>

<!-- Red Alert Flash -->
<div class="red-alert-flash" id="redAlertFlash"></div>

<!-- Dashboard Grid -->
<div class="dashboard" id="mainDashboard">

    <!-- HEADER -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-hex"><img src="logo-188.jpg" alt="MABAT 188" width="48" height="48" style="border-radius: 6px; filter: drop-shadow(0 0 6px rgba(0,212,255,0.4));"/></div>
            <div>
                <div class="system-title">MABAT 188</div>
                <div class="system-subtitle">פלטפורמת מודיעין גזרתית</div>
            </div>
        </div>

        <button class="hamburger-btn" onclick="toggleMobileMenu()">☰</button>

        <div class="header-center">
            <div class="header-actions-group">
                <button class="header-btn" onclick="loadDemoData()" style="color:var(--yellow);border-color:var(--yellow);">
                    <span class="btn-icon">&#9881;</span>
                    <span>הדגמה</span>
                </button>
                <button class="header-btn" onclick="toggleReportForm()" style="color:var(--green);border-color:var(--green);">
                    <span class="btn-icon">&#x2795;</span>
                    <span>דיווח שטח</span>
                </button>
                <button class="header-btn" onclick="toggleHistory()" style="color:var(--orange);border-color:var(--orange);">
                    <span class="btn-icon" id="alertCount" style="background:var(--orange);color:#000;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">0</span>
                    <span>יומן מבצעים</span>
                </button>
                <button class="header-btn" onclick="toggleSectorHistory()" style="color:var(--purple);border-color:var(--purple);">
                    <span class="btn-icon">&#x23F2;</span>
                    <span>היסטוריה גזרתית</span>
                </button>
                <button class="header-btn" onclick="toggleWhatsApp()" id="waBtn" style="color:#25D366;border-color:#25D366;">
                    <span class="btn-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align:middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></span>
                    <span>WhatsApp</span>
                </button>
            </div>
        </div>

        <div class="header-right">
            <div>
                <div class="clock" id="clock">00:00:00</div>
                <div class="date-display" id="dateDisplay"></div>
            </div>
            <div class="header-divider"></div>
            <button class="header-btn" onclick="doLogout()" style="color:var(--red);border-color:var(--red);font-size:10px;padding:4px 10px;">
                <span>יציאה</span>
            </button>
        </div>
    </header>

    <!-- LEFT PANEL -->
    <div class="left-panel">
        <div class="panel threat-container">
            <div class="panel-header">
                <span class="panel-title">רמת איום</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="threat-gauge">
                <div class="threat-circle level-gray" id="threatCircle">
                    <div class="threat-level-num" id="threatNum">0</div>
                    <div class="threat-level-label" id="threatLabel">CLEAR</div>
                </div>
                <div class="threat-bars" id="threatBars">
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                </div>
                <div class="threat-status-row">
                    <div class="status-badge">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">ONLINE</span>
                    </div>
                    <div class="status-badge">
                        <span>סריקה</span>
                        <span id="lastScan" style="color: var(--cyan);">--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel stats-container">
            <div class="panel-header">
                <span class="panel-title">נתונים</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="panel-body">
                <div class="stat-row">
                    <span class="stat-label">סה"כ</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ודאי</span>
                    <span class="stat-value red" id="statRed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">חזק</span>
                    <span class="stat-value orange" id="statOrange">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">בינוני</span>
                    <span class="stat-value yellow" id="statYellow">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">חלש</span>
                    <span class="stat-value" id="statBlue">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">מקורות</span>
                    <span class="stat-value green" id="statSources">0</span>
                </div>
            </div>
        </div>

        <div class="panel sources-container" id="sourcesContainer">
            <div class="panel-header" onclick="toggleSourcesDropdown()">
                <span class="panel-title">מקורות</span>
                <span class="sources-toggle-icon">&#9660;</span>
            </div>
            <div class="panel-body" id="sourcesList">
                <div class="loading-state"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- CENTER - MAP -->
    <div class="panel map-panel" id="mapPanel">
        <div id="map"></div>
        <div class="map-overlay"></div>
        <div class="map-coords">31.346N  34.306E</div>
        <div class="map-label">גזרה 188</div>
        <button class="map-btn" onclick="toggleMapFullscreen()" id="mapBtn" title="F = Fullscreen">&#x26F6; הרחב</button>
        <div class="map-legend" id="mapLegend">
            <div class="legend-title">מקרא</div>
            <div class="legend-item"><span class="legend-circle" style="background:#ff8800;"></span> כפר ערבי</div>
            <div class="legend-item"><span class="legend-circle" style="background:#4488ff;"></span> ישוב ישראלי</div>
            <div class="legend-item"><span class="legend-circle" style="background:#00ff88;"></span> ציר / מחסום</div>
            <div class="legend-divider"></div>
            <div class="legend-subtitle">טבעת איום:</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ff0040;"></span> ודאי</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ff8800;"></span> חזק</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ffd000;"></span> בינוני</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#4488ff;"></span> חלש</div>
            <div class="legend-divider"></div>
            <div class="legend-item"><span class="legend-circle" style="background:#ff4400;box-shadow:0 0 6px #ff4400;"></span> FIRMS (אש/פיצוץ)</div>
        </div>
        <div class="firms-toggle" id="firmsToggle" onclick="toggleFirmsLayer()" title="NASA FIRMS - Fires & Explosions">FIRMS</div>
    </div>

    <!-- RIGHT PANEL - AI SUMMARY -->
    <div class="panel right-panel">
        <div class="panel-header">
            <span class="panel-title">סקירה כללית</span>
            <span class="ai-badge">AI NEWS</span>
        </div>
        <div class="panel-body" id="summaryBody">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>ממתין לניתוח AI...</span>
            </div>
        </div>
    </div>

    <!-- BOTTOM - ALERT FEED -->
    <div class="panel alert-feed" id="alertFeedPanel">
        <div class="panel-header">
            <span class="panel-title">פיד חי</span>
        </div>
        <div class="alert-toolbar">
            <button class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">הכל</button>
            <button class="filter-chip red" data-filter="5" onclick="setFilter(5, this)">ודאי</button>
            <button class="filter-chip orange" data-filter="4" onclick="setFilter(4, this)">חזק</button>
            <button class="filter-chip yellow" data-filter="3" onclick="setFilter(3, this)">בינוני</button>
            <button class="filter-chip blue" data-filter="2" onclick="setFilter(2, this)">חלש</button>
            <button class="filter-chip purple" data-filter="anarchist" onclick="setFilter('anarchist', this)">חמאס/ג'האד</button>
            <button class="filter-chip green" data-filter="field" onclick="setFilter('field', this)">שטח</button>
            <button class="filter-chip" data-filter="false" onclick="setFilter('false', this)" style="border-color:#888;color:#888;">שגוי</button>
            <input type="text" class="search-input" id="searchInput" placeholder="חיפוש..." oninput="applyFilters()">
        </div>
        <div class="timeline-graph">
            <div class="timeline-label">פעילות 24 שעות</div>
            <div class="timeline-bars" id="timelineBars"></div>
            <div class="timeline-hours" id="timelineHours"></div>
        </div>
        <div class="panel-body" id="alertFeed">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>סורק ערוצים...</span>
            </div>
        </div>
    </div>

    <!-- CONFIG PANEL -->
    <div class="panel config-panel">
        <div class="panel-header">
            <span class="panel-title">מערכת</span>
            <div class="panel-indicator"></div>
        </div>
        <div class="panel-body">
            <div class="config-item"><span class="config-key">גזרה</span><span class="config-val">חאן יונס</span></div>
            <div class="config-item"><span class="config-key">רדיוס</span><span class="config-val">10 ק"מ</span></div>
            <div class="config-item"><span class="config-key">מרכז</span><span class="config-val">31.35N 34.31E</span></div>
            <div class="config-item"><span class="config-key">סריקה</span><span class="config-val">10 דק'</span></div>
            <div class="config-item"><span class="config-key">AI</span><span class="config-val">GEMINI 2.0</span></div>
            <div class="config-item"><span class="config-key">שמירה</span><span class="config-val">72 שעות</span></div>
            <div class="config-item"><span class="config-key">רענון</span><span class="config-val" id="nextRefresh">30s</span></div>
            <div class="config-item" style="cursor:pointer;" onclick="toggleKeywords()"><span class="config-key">מילות מפתח</span><span class="config-val" style="color:var(--cyan);">הצג &#9660;</span></div>
            <div style="border-top:1px solid var(--border-primary);margin-top:6px;padding-top:6px;">
                <div class="config-item"><span class="config-key" style="font-size:10px;letter-spacing:2px;color:var(--cyan);">INTEL LAYERS</span><span class="config-val" style="font-size:9px;">LIVE</span></div>
                <div class="config-item" id="weatherRow"><span class="config-key">מזג אוויר</span><span class="config-val" id="weatherVal">--</span></div>
                <div class="config-item" id="calendarRow"><span class="config-key">לוח תאריכים</span><span class="config-val" id="calendarVal" style="color:var(--green);">רגיל</span></div>
                <div class="config-item" id="sentimentRow"><span class="config-key">סנטימנט</span><span class="config-val" id="sentimentVal">--</span></div>
                <div class="config-item" id="trendsRow"><span class="config-key">מגמות</span><span class="config-val" id="trendsVal" style="color:var(--green);">0</span></div>
                <div class="config-item"><span class="config-key">מקורות</span><span class="config-val" style="font-size:9px;">TG+WA+RSS+FIRMS+OSINT</span></div>
                <div class="config-item" style="cursor:pointer;" onclick="toggleWhatsApp()"><span class="config-key">WhatsApp</span><span class="config-val" id="waConfigStatus" style="color:var(--text-dim);font-size:9px;">לא פעיל</span></div>
            </div>
        </div>
    </div>

    <!-- ═══════ ROW 4: OSINT INTELLIGENCE PANELS ═══════ -->
    <div class="osint-row">

        <!-- WHATSAPP INTELLIGENCE -->
        <div class="osint-panel">
            <div class="panel-header">
                <span class="panel-title" style="color:#25d366;">WA מודיעין קבוצות</span>
                <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);" id="waCount">0 קבוצות</span>
            </div>
            <div class="wa-group-header">
                <span>קבוצות מנוטרות</span>
                <span id="waLiveStatus" style="color:var(--green);font-size:9px;">LIVE</span>
            </div>
            <div class="panel-body" id="waFeed" style="padding:0;">
                <div style="padding:30px 15px;text-align:center;color:var(--text-dim);font-family:var(--font-he);font-size:11px;">
                    טוען נתוני WhatsApp...
                </div>
            </div>
        </div>

        <!-- TARGET SEARCH (DIGITAL FOOTPRINT) -->
        <div class="osint-panel">
            <div class="panel-header">
                <span class="panel-title">חיפוש יעד</span>
                <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);">OSINT</span>
            </div>
            <div class="target-search-box">
                <input type="text" id="targetSearchInput" placeholder="שם משתמש / טלפון / אימייל..." onkeydown="if(event.key==='Enter')searchTarget()">
                <button onclick="searchTarget()">חפש</button>
            </div>
            <div class="panel-body" id="targetResults">
                <div style="padding:30px 15px;text-align:center;color:var(--text-dim);font-family:var(--font-he);font-size:11px;">
                    הכנס שם משתמש, מספר טלפון או אימייל לסריקה ב-400+ פלטפורמות
                </div>
            </div>
        </div>

        <!-- NETWORK GRAPH -->
        <div class="osint-panel">
            <div class="panel-header">
                <span class="panel-title">מפת קשרים</span>
                <span style="font-family:var(--font-mono);font-size:9px;color:var(--text-dim);" id="graphNodeCount">0 צמתים</span>
            </div>
            <div class="panel-body" style="padding:0;position:relative;">
                <div class="network-container" id="networkGraph"></div>
                <div class="network-controls">
                    <button class="net-btn active" onclick="setGraphView('all')">הכל</button>
                    <button class="net-btn" onclick="setGraphView('telegram')">טלגרם</button>
                    <button class="net-btn" onclick="setGraphView('whatsapp')">WhatsApp</button>
                    <button class="net-btn" onclick="setGraphView('social')">רשתות</button>
                </div>
                <div class="net-legend">
                    <div class="net-legend-item"><div class="net-legend-dot" style="background:var(--cyan);"></div> ערוץ טלגרם</div>
                    <div class="net-legend-item"><div class="net-legend-dot" style="background:#25d366;"></div> קבוצת WhatsApp</div>
                    <div class="net-legend-item"><div class="net-legend-dot" style="background:var(--orange);"></div> דמות מפתח</div>
                    <div class="net-legend-item"><div class="net-legend-dot" style="background:var(--red);"></div> ישות מאוימת</div>
                    <div class="net-legend-item"><div class="net-legend-dot" style="background:var(--purple);"></div> רשת חברתית</div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- SECTOR HISTORY OVERLAY -->
<div class="sector-history-overlay" id="sectorHistoryOverlay">
    <div class="sh-header">
        <div class="sh-title">היסטוריה גזרתית</div>
        <div class="sh-tabs">
            <button class="sh-tab active" data-tab="locations" onclick="switchShTab('locations', this)">מיקומים</button>
            <button class="sh-tab" data-tab="zones" onclick="switchShTab('zones', this)">אזורים</button>
            <button class="sh-tab" data-tab="timeline" onclick="switchShTab('timeline', this)">ציר זמן</button>
        </div>
        <button class="history-close" onclick="toggleSectorHistory()">סגור ESC</button>
    </div>

    <!-- TAB: Locations Heatmap -->
    <div class="sh-content" id="shTabLocations">
        <div class="sh-summary-bar" id="shLocationSummary"></div>
        <div class="sh-locations-grid" id="shLocationsGrid">
            <div class="loading-state"><div class="loading-spinner"></div><span>טוען נתוני מיקום...</span></div>
        </div>
    </div>

    <!-- TAB: Zone Summary -->
    <div class="sh-content" id="shTabZones" style="display:none;">
        <div class="sh-zones-container" id="shZonesContainer">
            <div class="loading-state"><div class="loading-spinner"></div><span>טוען אזורים...</span></div>
        </div>
    </div>

    <!-- TAB: Monthly Timeline -->
    <div class="sh-content" id="shTabTimeline" style="display:none;">
        <div class="sh-timeline-chart" id="shTimelineChart"></div>
        <div class="sh-timeline-details" id="shTimelineDetails"></div>
    </div>
</div>

<!-- WHATSAPP OVERLAY -->
<div class="wa-overlay" id="waOverlay" onclick="if(event.target===this)toggleWhatsApp()">
    <div class="wa-panel">
        <div class="wa-panel-header">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="#25D366" style="vertical-align:middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            <span class="wa-panel-title">WhatsApp - מערכת איסוף</span>
            <button class="history-close" onclick="toggleWhatsApp()">סגור ESC</button>
        </div>

        <!-- Connection Status -->
        <div class="wa-section">
            <div class="wa-section-title">סטטוס חיבור</div>
            <div class="wa-status-row">
                <div class="wa-status-dot" id="waStatusDot"></div>
                <span id="waStatusText">לא מחובר</span>
            </div>
            <div id="waQrContainer" style="display:none;text-align:center;margin:10px 0;">
                <div style="color:var(--text-dim);font-size:11px;margin-bottom:8px;">סרוק את הקוד עם הטלפון</div>
                <img id="waQrImg" style="max-width:200px;border-radius:8px;border:2px solid var(--border-glow);">
            </div>
        </div>

        <!-- API Settings -->
        <div class="wa-section">
            <div class="wa-section-title">הגדרות Green API</div>
            <div class="wa-field">
                <label>Instance ID</label>
                <input type="text" id="waInstanceId" placeholder="1234567890" dir="ltr">
            </div>
            <div class="wa-field">
                <label>API Token</label>
                <input type="password" id="waApiToken" placeholder="API Token" dir="ltr">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
                <button class="wa-btn wa-btn-connect" onclick="connectWhatsApp()">התחבר</button>
                <button class="wa-btn wa-btn-secondary" onclick="checkWaStatus()">בדוק סטטוס</button>
            </div>
        </div>

        <!-- Group Selection -->
        <div class="wa-section" id="waGroupsSection" style="display:none;">
            <div class="wa-section-title">קבוצות לניטור</div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <button class="wa-btn wa-btn-secondary" onclick="loadWaGroups()">טען קבוצות</button>
                <span id="waGroupCount" style="color:var(--text-dim);font-size:11px;align-self:center;"></span>
            </div>
            <div id="waGroupsList" class="wa-groups-list"></div>
            <button class="wa-btn wa-btn-connect" onclick="saveWaSettings()" style="margin-top:10px;width:100%;">שמור והפעל ניטור</button>
        </div>

        <!-- Monitoring Status -->
        <div class="wa-section" id="waMonitorSection" style="display:none;">
            <div class="wa-section-title">ניטור פעיל</div>
            <div id="waMonitorStats" class="wa-monitor-stats"></div>
            <div id="waRecentMessages" class="wa-recent-messages"></div>
            <button class="wa-btn wa-btn-stop" onclick="stopWaMonitoring()">עצור ניטור</button>
        </div>
    </div>
</div>

<!-- FIELD REPORT OVERLAY -->
<div class="report-overlay" id="reportOverlay" onclick="if(event.target===this)toggleReportForm()">
    <div class="report-form">
        <div class="report-form-title">➕ דיווח שטח חדש</div>
        <div class="report-field">
            <label>כותרת</label>
            <input type="text" id="reportTitle" placeholder="תיאור קצר של האירוע">
        </div>
        <div class="report-field">
            <label>פרטים</label>
            <textarea id="reportDetails" placeholder="פרטים נוספים ואופן טיפול..."></textarea>
        </div>
        <div class="report-field">
            <label>רמת דחיפות</label>
            <div class="report-urgency-row">
                <button class="report-urgency-btn" data-urg="5" onclick="selectReportUrgency(this)">ודאי</button>
                <button class="report-urgency-btn" data-urg="4" onclick="selectReportUrgency(this)">חזק</button>
                <button class="report-urgency-btn selected" data-urg="3" onclick="selectReportUrgency(this)">בינוני</button>
                <button class="report-urgency-btn" data-urg="2" onclick="selectReportUrgency(this)">חלש</button>
            </div>
        </div>
        <div class="report-field">
            <label>מיקום</label>
            <select id="reportLocation">
                <option value="">-- בחר מיקום --</option>
            </select>
        </div>
        <div class="report-field">
            <label>שם מדווח</label>
            <input type="text" id="reportReporter" placeholder="שם המדווח">
        </div>
        <div class="report-actions">
            <button class="report-submit" onclick="submitFieldReport()">שלח דיווח</button>
            <button class="report-cancel" onclick="toggleReportForm()">ביטול</button>
        </div>
    </div>
</div>

<!-- KEYWORDS OVERLAY -->
<div class="keywords-overlay" id="keywordsOverlay">
    <div class="keywords-header">
        <div class="keywords-title">מילות מפתח סריקה</div>
        <button class="history-close" onclick="toggleKeywords()">סגור ESC</button>
    </div>
    <div class="keywords-stat-bar" id="keywordsStats"></div>
    <div class="keywords-body" id="keywordsBody">
        <div class="loading-state"><div class="loading-spinner"></div><span>טוען מילות מפתח...</span></div>
    </div>
</div>

<!-- PUBLISHER PROFILE OVERLAY -->
<div class="publisher-overlay" id="publisherOverlay" onclick="if(event.target===this)closePublisherProfile()">
    <div class="publisher-card" id="publisherCard"></div>
</div>

<!-- HISTORY OVERLAY -->
<div class="history-overlay" id="historyOverlay">
    <div class="history-header">
        <div class="history-title">יומן מבצעים</div>
        <button class="history-close" onclick="toggleHistory()">סגור ESC</button>
    </div>
    <div class="history-stat-bar" id="historyStats"></div>
    <div class="history-filters">
        <input type="text" class="history-search" id="historySearch" placeholder="חיפוש ביומן..." oninput="renderHistory()">
        <button class="filter-chip active" data-hfilter="all" onclick="setHistoryFilter('all', this)">הכל</button>
        <button class="filter-chip red" data-hfilter="5" onclick="setHistoryFilter(5, this)">ודאי</button>
        <button class="filter-chip orange" data-hfilter="4" onclick="setHistoryFilter(4, this)">חזק</button>
        <button class="filter-chip yellow" data-hfilter="3" onclick="setHistoryFilter(3, this)">בינוני</button>
        <button class="filter-chip blue" data-hfilter="2" onclick="setHistoryFilter(2, this)">חלש</button>
        <button class="filter-chip" data-hfilter="false" onclick="setHistoryFilter('false', this)" style="border-color:#888;color:#888;">שגוי</button>
    </div>
    <div class="history-body" id="historyBody">
        <div class="loading-state"><div class="loading-spinner"></div><span>טוען יומן מבצעים...</span></div>
    </div>
</div>

<!-- Refresh Bar -->
<div class="refresh-bar" id="refreshBar"></div>

<!-- Credit Footer -->
<div class="credit-footer" id="creditFooter">
    <a href="https://wa.me/972542012000" target="_blank">נבנה ע"י אלחי פיין | 054-201-2000</a>
</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
<script>
// ═══════════════════════════════════════
// MABAT 188 - DASHBOARD ENGINE v2
// ═══════════════════════════════════════

const FIREBASE_URL = 'https://mabat-188-default-rtdb.europe-west1.firebasedatabase.app';
const SECTOR_CENTER = { lat: 31.346, lng: 34.306 };
const SECTOR_FILTER_RADIUS_KM = 30;
const REFRESH_INTERVAL = 30000;

// Locations OUTSIDE the sector - filter these out
const OUT_OF_SECTOR = ['בית ליקיה','בית לקיה','ביר זית','רמאללה','אל-בירה','נבי סאלח','בלעין','נעלין','קדום','בית אל','עופרה','שילה','חברון','ג\'נין','טולכרם','שכם','נאבלוס','קלקיליה','טובאס','סלפית','בית ג\'אלה','בית לחם','בית סאחור','דיר איביע','ספא','בית סירא','כוכב יעקב','עטרת','חלמיש','בודרוס','קביה','שקבא','דיר קדיס','ני עלין','כפר נעמה','אבו דיס','עזריה','ענאתא','ראס אל-עמוד','סילוואן','עיסוויה','שועפאט','בית חנינא','קלנדיה','א-רם','ביתוניא','ליפתא','עין יברוד'];

// Locations INSIDE the sector - positive match
const IN_SECTOR = ['חאן יונס','עזה','רפיח','דיר אל-בלח','בני סוהילה','עבסאן','אבסאן','אל-קררה','קררה','ח\'וזאעה','חוזאעה','אל-מוואסי','מוואסי','אל-פוח\'ארי','פוח\'ארי','כרם אבו סאלם','כרם שלום','פילדלפי','נצרים','ציר סלאח','מעאן','כיסופים','ניר עוז','נחל עוז','זיכים','סופה','רעים','עוטף עזה','שג\'אעיה','זייתון','תופאח','תל אל-הווא','בית חאנון','בית לאהיא','ג\'באליה','מע\'אזי','בורייג\'','נוסייראת','מגדלים','יבנה','רצועת עזה','Gaza','Khan Younis'];

// Geographic filter - only show news relevant to this sector
function isInSector(item) {
    // Check coordinates first
    if (item.coordinates) {
        const lat = item.coordinates.lat || item.coordinates.latitude;
        const lon = item.coordinates.lon || item.coordinates.lng || item.coordinates.longitude;
        if (lat && lon) {
            const dLat = (lat - SECTOR_CENTER.lat) * 111.32;
            const dLon = (lon - SECTOR_CENTER.lng) * 111.32 * Math.cos(SECTOR_CENTER.lat * Math.PI / 180);
            const dist = Math.sqrt(dLat * dLat + dLon * dLon);
            return dist <= SECTOR_FILTER_RADIUS_KM;
        }
    }
    // Text-based filter for items without coordinates
    const text = [item.title, item.locationHe, item.snippet, item.fullText, item.description].filter(Boolean).join(' ');
    if (!text) return false;
    // Reject if mentions out-of-sector location
    for (const loc of OUT_OF_SECTOR) {
        if (text.includes(loc)) return false;
    }
    // Accept if mentions in-sector location
    for (const loc of IN_SECTOR) {
        if (text.includes(loc)) return true;
    }
    // Default: reject unknown items
    return false;
}
function filterSectorNews(news) {
    const filtered = {};
    Object.entries(news).forEach(([id, item]) => {
        if (isInSector(item)) filtered[id] = item;
    });
    return filtered;
}

// KEY VILLAGES - highlighted on map with larger markers + sector history
const KEY_VILLAGES = [
    { he: "חאן יונס", lat: 31.346, lng: 34.306, priority: 'P1', pop: '~400,000',
      history: 'העיר הגדולה בדרום הרצועה. מרכז פיקודי של חמאס בדרום. אזור לחימה אינטנסיבית.',
      threats: ['לחימה', 'מנהרות', 'נ"ט'] },
    { he: "בני סוהילה", lat: 31.347, lng: 34.338, priority: 'P1', pop: '~45,000',
      history: 'מזרחית לחאן יונס. אזור לחימה קשה. מרכז תשתיות מנהרות.',
      threats: ['מנהרות', 'מטענים', 'צלפים'] },
    { he: "עבסאן אל-כביר", lat: 31.327, lng: 34.348, priority: 'P1', pop: '~25,000',
      history: 'כפר מזרחי סמוך לגדר. נקודת חדירה מרכזית. לחימה קרקעית אינטנסיבית.',
      threats: ['חדירה', 'נ"ט', 'מטענים'] },
    { he: "אל-קררה", lat: 31.363, lng: 34.345, priority: 'P1', pop: '~30,000',
      history: 'צפונית-מזרחית לחאן יונס. סמוכה לגדר. אזור חדירות ופעילות צבאית.',
      threats: ['חדירה', 'ירי', 'רקטות'] },
    { he: "חוזעה", lat: 31.335, lng: 34.365, priority: 'P1', pop: '~12,000',
      history: 'סמוכה מאוד לגדר. נקודת מפתח בלחימה. מרכז תשתיות תת-קרקעיות.',
      threats: ['מנהרות', 'חדירה', 'צלפים'] },
    { he: "אל-מוואסי", lat: 31.370, lng: 34.265, priority: 'P2', pop: 'משתנה',
      history: 'אזור חוף מערבי. הוכרז כאזור הומניטרי. ריכוז אוכלוסייה ומאהלים.',
      threats: ['הומניטרי', 'עקורים'] },
    { he: "מען", lat: 31.310, lng: 34.290, priority: 'P2', pop: '~5,000',
      history: 'דרומית לחאן יונס. אזור לחימה פעיל.',
      threats: ['לחימה', 'מטענים'] },
    { he: "אל-פוח\'ארי", lat: 31.310, lng: 34.335, priority: 'P2', pop: '~8,000',
      history: 'דרומית-מזרחית. סמוך לגדר. אזור תצפיות ופעילות צבאית.',
      threats: ['תצפיות', 'חדירה'] },
];

const P1_LOCATIONS = [
    { name: "Khan Younis", he: "חאן יונס", lat: 31.346, lng: 34.306 },
    { name: "Bani Suheila", he: "בני סוהילה", lat: 31.347, lng: 34.338 },
    { name: "Abasan al-Kabira", he: "עבסאן אל-כביר", lat: 31.327, lng: 34.348 },
    { name: "Abasan al-Saghira", he: "עבסאן א-סגירה", lat: 31.335, lng: 34.355 },
    { name: "Al Qarara", he: "אל-קררה", lat: 31.363, lng: 34.345 },
    { name: "Khuza'a", he: "חוזעה", lat: 31.335, lng: 34.365 },
    { name: "Al Mawasi", he: "אל-מוואסי", lat: 31.370, lng: 34.265 },
    { name: "Ma'an", he: "מען", lat: 31.310, lng: 34.290 },
];

const P2_LOCATIONS = [
    { name: "Al Fukhari", he: "אל-פוח'ארי", lat: 31.310, lng: 34.335 },
    { name: "Hamad City", he: "חמד (חאן יונס)", lat: 31.358, lng: 34.290 },
    { name: "Juhr al-Dik", he: "ג'וחר א-דיכ", lat: 31.380, lng: 34.355 },
    { name: "Rafah North", he: "רפיח צפון", lat: 31.305, lng: 34.260 },
    { name: "Deir al-Balah", he: "דיר אל-בלח", lat: 31.418, lng: 34.350 },
];

const P3_LOCATIONS = [
    { name: "Salah ad-Din Road", he: "כביש סלאח א-דין", lat: 31.346, lng: 34.340, type: 'route' },
    { name: "Netzarim Corridor", he: "ציר נצרים", lat: 31.430, lng: 34.380, type: 'route' },
    { name: "Philadelphi Corridor", he: "ציר פילדלפי", lat: 31.250, lng: 34.270, type: 'route' },
    { name: "Kerem Abu Salem", he: "מעבר כרם אבו סאלם", lat: 31.228, lng: 34.288, type: 'checkpoint' },
];

const ISRAELI_LOCATIONS = [
    // ישובי עוטף עזה
    { name: "Nir Oz", he: "ניר עוז", lat: 31.382, lng: 34.396 },
    { name: "Nirim", he: "נירים", lat: 31.385, lng: 34.390 },
    { name: "Ein HaShlosha", he: "עין השלושה", lat: 31.400, lng: 34.415 },
    { name: "Kissufim", he: "כיסופים", lat: 31.375, lng: 34.400 },
    { name: "Magen", he: "מגן", lat: 31.350, lng: 34.405 },
    { name: "Tkuma", he: "תקומה", lat: 31.403, lng: 34.428 },
    // מחוץ לגזרה
    { name: "Sderot", he: "שדרות", lat: 31.525, lng: 34.596, outside: true },
    { name: "Netivot", he: "נתיבות", lat: 31.422, lng: 34.587, outside: true },
    { name: "Ofakim", he: "אופקים", lat: 31.312, lng: 34.622, outside: true },
    { name: "Be'eri", he: "בארי", lat: 31.430, lng: 34.485, outside: true },
    { name: "Re'im", he: "רעים", lat: 31.378, lng: 34.451, outside: true },
    { name: "Kerem Shalom", he: "כרם שלום", lat: 31.228, lng: 34.288, outside: true },
];

// ערים מחוץ לגזרה
const CITIES_OUTSIDE = [
    { name: "Gaza City", he: "עיר עזה", lat: 31.502, lng: 34.467, type: 'city' },
    { name: "Rafah", he: "רפיח", lat: 31.295, lng: 34.255, type: 'city' },
    { name: "Deir al-Balah", he: "דיר אל-בלח", lat: 31.418, lng: 34.350, type: 'city' },
];

// ישובים/שכונות ברצועה מחוץ לגזרה
const ARAB_OUTSIDE = [
    { name: "Nuseirat", he: "א-נוצייראת", lat: 31.441, lng: 34.395 },
    { name: "Bureij", he: "אל-בורייג'", lat: 31.457, lng: 34.410 },
    { name: "Maghazi", he: "מע'אזי", lat: 31.435, lng: 34.388 },
    { name: "Zawayda", he: "א-זוואידה", lat: 31.423, lng: 34.368 },
];

const מקורות = [
    // ── LOCAL - Khan Younis / Gaza South ──
    { id: 'gazaalannet', name: 'Gaza Now', type: 'local', tg: 'gazaalannet' },
    { id: 'GazaNewsNow', name: 'أخبار غزة', type: 'local', tg: 'GazaNewsNow' },
    { id: 'gazala7zapal1', name: 'עזה רגע ברגע', type: 'local', tg: 'gazala7zapal1' },
    { id: 'KhanYounisNews', name: 'اخبار خان يونس', type: 'local', tg: 'KhanYounisNews' },
    { id: 'Khan_Younis_Now', name: 'خانيونس الان', type: 'local', tg: 'Khan_Younis_Now' },
    { id: 'RafahNow', name: 'رفح الان', type: 'local', tg: 'RafahNow' },
    { id: 'daboragaza', name: 'الضابورة غزة', type: 'local', tg: 'daboragaza' },
    { id: 'GazaAlanOfficial', name: 'غزة الان الرسمي', type: 'local', tg: 'GazaAlanOfficial' },
    { id: 'gazaurgent', name: 'غزة عاجل', type: 'local', tg: 'gazaurgent' },
    // ── REGIONAL ──
    { id: 'akh_bar_gaza', name: 'חדשות עזה', type: 'regional', tg: 'akh_bar_gaza' },
    { id: 'GazaAlYawm', name: 'غزة اليوم', type: 'regional', tg: 'GazaAlYawm' },
    { id: 'Gaza_Interior', name: 'داخلية غزة', type: 'regional', tg: 'Gaza_Interior' },
    { id: 'GazaHealthMin', name: 'وزارة الصحة', type: 'regional', tg: 'GazaHealthMin' },
    { id: 'GazaBN', name: 'غزة شبكة الأخبار', type: 'regional', tg: 'GazaBN' },
    { id: 'ShehabAgency', name: 'وكالة شهاب', type: 'regional', tg: 'ShehabAgency' },
    // ── NATIONAL - Palestinian ──
    { id: 'QudsN', name: 'רשת קודס', type: 'national', tg: 'QudsN' },
    { id: 'palinfo', name: 'מרכז תקשורת', type: 'national', tg: 'palinfo' },
    { id: 'PalestineResist', name: 'Resistance News', type: 'national', tg: 'PalestineResist' },
    { id: 'eyeonpal', name: 'Eye on Palestine', type: 'national', tg: 'eyeonpal' },
    { id: 'QudsNEN', name: 'Quds News EN', type: 'national', tg: 'QudsNEN' },
    { id: 'paboranews', name: 'شبكة الامة', type: 'national', tg: 'paboranews' },
    { id: 'almanaboranews', name: 'قناة المنبر', type: 'national', tg: 'almanaboranews' },
    { id: 'haaboranews', name: 'شبكة حبارى', type: 'national', tg: 'haaboranews' },
    { id: 'SarayaAlQuds', name: 'סראיא אל-קודס', type: 'national', tg: 'SarayaAlQuds' },
    { id: 'qaboranews', name: 'كتائب القسام', type: 'national', tg: 'qaboranews' },
    { id: 'AJABreaking', name: 'Al Jazeera عاجل', type: 'national', tg: 'AJABreaking' },
    // ── ISRAELI MILITARY/NEWS ──
    { id: 'abu_ali_en', name: 'Abu Ali Express EN', type: 'national', tg: 'abu_ali_en' },
    { id: 'aaboranews', name: 'עכשיו 14', type: 'news', tg: 'aaboranews' },
    // ── OTHER SOURCES ──
    { id: 'google-news', name: 'Google News', type: 'news', url: 'https://news.google.com' },
    { id: 'firms-nasa', name: 'NASA FIRMS', type: 'geo', url: 'https://firms.modaps.eosdis.nasa.gov' },
    // ── WHATSAPP (Firebase endpoint) ──
    { id: 'whatsapp-groups', name: 'קבוצות WhatsApp', type: 'whatsapp', icon: 'WA' },
];

// ═══════ STATE ═══════
let map;
let alertMarkers = [];
let newsData = {};
let allNewsData = {};
let summaryData = null;
let metaData = null;
let activeFilter = 'all';
let historyFilter = 'all';
let knownIds = new Set();
let isFirstLoad = true;
let mapIsFullscreen = false;
let showAnarchists = true;
let checkedAlerts = new Set(JSON.parse(localStorage.getItem('mabat188-checked') || '[]'));
let journalNotes = {};
let alertVotes = {};
let firmsVisible = false;
let waData = {};
let networkGraph = null;
let networkNodes = null;
let networkEdges = null;
let currentGraphView = 'all';

// Load alert votes from Firebase
async function loadAlertVotes() {
    try {
        const res = await fetch(`${FIREBASE_URL}/alert-votes.json`);
        const data = await res.json();
        if (data && !data.error) alertVotes = data;
    } catch (e) {
        console.error('Error loading alert votes:', e);
    }
}

// Toggle vote on an alert
async function toggleVote(alertId, voteType, event) {
    event.stopPropagation();
    const current = alertVotes[alertId];
    if (current && current.vote === voteType) {
        delete alertVotes[alertId];
        try { await fetch(`${FIREBASE_URL}/alert-votes/${alertId}.json`, { method: 'DELETE' }); } catch (e) { console.error('Error removing vote:', e); }
    } else {
        const voteData = { vote: voteType, votedAt: Date.now() };
        alertVotes[alertId] = voteData;
        try { await fetch(`${FIREBASE_URL}/alert-votes/${alertId}.json`, { method: 'PUT', body: JSON.stringify(voteData) }); } catch (e) { console.error('Error saving vote:', e); }
    }
    renderAlerts();
}

// Load journal notes from Firebase
async function loadJournalNotes() {
    try {
        const res = await fetch(`${FIREBASE_URL}/journal-notes.json`);
        const data = await res.json();
        if (data && !data.error) journalNotes = data;
    } catch (e) {
        console.error('Error loading journal notes:', e);
    }
}

async function saveJournalNote(itemId) {
    const form = document.getElementById('note-form-' + itemId);
    if (!form) return;
    const reporter = form.querySelector('[name="reporter"]').value.trim();
    const details = form.querySelector('[name="details"]').value.trim();
    if (!reporter && !details) return;
    const note = { reporter, details, savedAt: Date.now() };
    journalNotes[itemId] = note;
    try {
        await fetch(`${FIREBASE_URL}/journal-notes/${itemId}.json`, {
            method: 'PUT',
            body: JSON.stringify(note)
        });
    } catch (e) { console.error('Error saving note:', e); }
    renderHistory();
}

async function deleteJournalNote(itemId) {
    delete journalNotes[itemId];
    try {
        await fetch(`${FIREBASE_URL}/journal-notes/${itemId}.json`, { method: 'DELETE' });
    } catch (e) { console.error('Error deleting note:', e); }
    renderHistory();
}

function toggleNoteForm(itemId) {
    const form = document.getElementById('note-form-' + itemId);
    if (form) { form.style.display = form.style.display === 'none' ? 'flex' : 'none'; }
}

// ═══════ FIELD REPORT ═══════
let reportUrgency = 3;

function toggleMobileMenu() {
    document.querySelector('.header-center').classList.toggle('menu-open');
}

function toggleReportForm() {
    const overlay = document.getElementById('reportOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        populateLocationDropdown();
    }
}

function populateLocationDropdown() {
    const sel = document.getElementById('reportLocation');
    if (sel.options.length > 1) return; // already populated
    const allLocs = [...KEY_VILLAGES, ...P1_LOCATIONS, ...P2_LOCATIONS, ...P3_LOCATIONS, ...ISRAELI_LOCATIONS];
    const seen = new Set();
    allLocs.forEach(loc => {
        if (seen.has(loc.he)) return;
        seen.add(loc.he);
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ he: loc.he, lat: loc.lat, lng: loc.lng });
        opt.textContent = loc.he;
        sel.appendChild(opt);
    });
}

function selectReportUrgency(btn) {
    document.querySelectorAll('.report-urgency-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    reportUrgency = parseInt(btn.dataset.urg);
}

async function submitFieldReport() {
    const title = document.getElementById('reportTitle').value.trim();
    const details = document.getElementById('reportDetails').value.trim();
    const locVal = document.getElementById('reportLocation').value;
    const reporter = document.getElementById('reportReporter').value.trim();

    if (!title) { alert('נא להזין כותרת'); return; }

    let locationHe = '';
    let coordinates = null;
    if (locVal) {
        const loc = JSON.parse(locVal);
        locationHe = loc.he;
        coordinates = { lat: loc.lat, lng: loc.lng };
    }

    const report = {
        title: title,
        fullText: details,
        snippet: details,
        source: 'דיווח שטח',
        sourceUrl: '',
        urgencyScore: reportUrgency,
        urgency: reportUrgency,
        locationHe: locationHe,
        coordinates: coordinates,
        publishedAt: Date.now(),
        fetchedAt: Date.now(),
        timestamp: Date.now(),
        isFieldReport: true,
        reporter: reporter || 'לא צוין'
    };

    const reportId = 'field_' + Date.now();

    try {
        await fetch(`${FIREBASE_URL}/auto-news/${reportId}.json`, {
            method: 'PUT',
            body: JSON.stringify(report)
        });

        // Add to local data immediately
        newsData[reportId] = report;
        allNewsData[reportId] = report;
        renderAll();

        // Reset form
        document.getElementById('reportTitle').value = '';
        document.getElementById('reportDetails').value = '';
        document.getElementById('reportLocation').value = '';
        document.getElementById('reportReporter').value = '';
        reportUrgency = 3;
        document.querySelectorAll('.report-urgency-btn').forEach(b => b.classList.remove('selected'));
        document.querySelector('.report-urgency-btn[data-urg="3"]').classList.add('selected');

        toggleReportForm();
    } catch (e) {
        console.error('Error submitting field report:', e);
        alert('שגיאה בשליחת הדיווח');
    }
}

// Hamas/Jihad militant keywords
const ANARCHIST_KEYWORDS = [
    'hamas', 'jihad', 'qassam', 'saraya', 'resistance', 'mujahideen',
    'armed', 'militant', 'tunnel', 'rocket', 'mortar', 'IED',
    'حماس', 'جهاد', 'قسام', 'سرايا', 'مقاومة', 'مسلح', 'مسلحين',
    'نفق', 'صاروخ', 'هاون', 'عبوة', 'ناسفة',
    'חמאס', 'ג\'האד', 'קסאם', 'סראיא', 'חמושים',
    'מנהרה', 'רקטה', 'רקטות', 'מרגמה', 'מטען',
    'נ"ט', 'נגד טנקים', 'שיגור', 'צלפים',
    'כתיבות', 'זרוע צבאית', 'נוח\'בה',
];

// ═══════ CLOCK ═══════
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('clock').textContent = `${h}:${m}:${s}`;

    const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
    document.getElementById('dateDisplay').textContent = `יום ${days[now.getDay()]} | ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
}

// ═══════ LOCATION COORDS LOOKUP ═══════
function lookupCoords(item) {
    // If item already has coordinates, use them
    if (item.coordinates && (item.coordinates.lat)) {
        return { lat: item.coordinates.lat, lng: item.coordinates.lon || item.coordinates.lng };
    }
    // Lookup by locationHe or matchedLocations
    const locName = (item.locationHe || '').toLowerCase();
    const matchedLocs = (item.matchedLocations || []).map(l => l.toLowerCase());
    const allLocs = [...KEY_VILLAGES, ...P1_LOCATIONS, ...P2_LOCATIONS, ...ISRAELI_LOCATIONS, ...P3_LOCATIONS];
    for (const loc of allLocs) {
        const names = [loc.he, loc.name, loc.altHe].filter(Boolean).map(n => n.toLowerCase());
        if (names.some(n => locName.includes(n) || n.includes(locName)) && locName) {
            return { lat: loc.lat, lng: loc.lng };
        }
        if (matchedLocs.some(ml => names.some(n => ml.includes(n) || n.includes(ml)))) {
            return { lat: loc.lat, lng: loc.lng };
        }
    }
    return null;
}

// ═══════ SOURCE URL HELPER ═══════
function getSourceUrl(sourceName) {
    if (!sourceName) return '';
    const sourceMap = {};
    מקורות.forEach(src => {
        sourceMap[src.id] = src.tg ? `https://t.me/${src.tg}` : (src.url || '');
        sourceMap[src.name] = src.tg ? `https://t.me/${src.tg}` : (src.url || '');
    });
    return sourceMap[sourceName] || '';
}

// ═══════ LOCATION POPUP BUILDER ═══════
function buildLocationPopup(loc, priority, color) {
    const mapsLink = `https://www.google.com/maps?q=${loc.lat},${loc.lng}`;
    return `<div style="direction:rtl;text-align:right;min-width:160px;">` +
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">` +
            `<b style="color:${color};font-size:13px;">${loc.he}</b>` +
            `<span style="font-size:9px;padding:1px 6px;border:1px solid ${color};border-radius:3px;color:${color};letter-spacing:1px;">${priority}</span>` +
        `</div>` +
        `<div style="color:#9ab0c8;font-size:10px;margin-bottom:4px;">${loc.lat.toFixed(3)}N, ${loc.lng.toFixed(3)}E</div>` +
        `<div style="text-align:center;margin-top:4px;">` +
            `<a href="${mapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 פתח במפות Google</a>` +
        `</div>` +
    `</div>`;
}

// ═══════ MAP ═══════
function initMap() {
    map = L.map('map', {
        center: [SECTOR_CENTER.lat, SECTOR_CENTER.lng],
        zoom: 12,
        zoomControl: false,
        attributionControl: false
    });

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19
    }).addTo(map);

    // Roads overlay - transparent road names on top of satellite
    L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        opacity: 0.5,
        pane: 'overlayPane'
    }).addTo(map);

    // ═══════ GAZA STRIP FULL BOUNDARY (OpenStreetMap relation 1473938) ═══════
    // Complete perimeter: coast + Egypt border + Israel fence
    const GAZA_OUTLINE = [
        [31.5633,34.5364],[31.5681,34.5298],[31.5723,34.5241],[31.5760,34.5185],[31.5818,34.5106],
        [31.5836,34.5077],[31.5891,34.4993],[31.5913,34.4966],[31.5950,34.4910],[31.5959,34.4898],
        [31.5969,34.4879],[31.5605,34.4607],[31.5487,34.4511],[31.5319,34.4370],[31.5182,34.4236],
        [31.4902,34.3962],[31.4657,34.3728],[31.4510,34.3583],[31.4351,34.3425],[31.4043,34.3082],
        [31.3458,34.2398],[31.3264,34.2159],[31.3233,34.2188],[31.3066,34.2268],[31.2936,34.2325],
        [31.2812,34.2395],[31.2705,34.2460],[31.2602,34.2519],[31.2508,34.2563],[31.2391,34.2612],
        [31.2347,34.2632],[31.2291,34.2650],[31.2262,34.2659],[31.2201,34.2675],
        [31.2206,34.2684],[31.2231,34.2716],[31.2255,34.2744],[31.2285,34.2784],[31.2296,34.2797],
        [31.2306,34.2809],[31.2344,34.2852],[31.2360,34.2867],[31.2378,34.2884],[31.2401,34.2906],
        [31.2412,34.2919],[31.2421,34.2935],[31.2434,34.2962],[31.2444,34.2989],[31.2456,34.3014],
        [31.2468,34.3042],[31.2482,34.3067],[31.2490,34.3086],[31.2503,34.3124],[31.2517,34.3162],
        [31.2526,34.3179],[31.2536,34.3194],[31.2567,34.3240],[31.2580,34.3258],[31.2603,34.3287],
        [31.2619,34.3305],[31.2629,34.3316],[31.2643,34.3329],[31.2665,34.3348],[31.2684,34.3364],
        [31.2708,34.3378],[31.2726,34.3391],[31.2746,34.3403],[31.2765,34.3414],[31.2783,34.3422],
        [31.2792,34.3437],[31.2800,34.3452],[31.2810,34.3473],[31.2822,34.3497],[31.2849,34.3550],
        [31.2905,34.3665],[31.2955,34.3693],[31.3000,34.3710],[31.3062,34.3733],[31.3079,34.3730],
        [31.3144,34.3720],[31.3235,34.3705],[31.3342,34.3687],[31.3476,34.3667],[31.3558,34.3672],
        [31.3596,34.3689],[31.3630,34.3712],[31.3644,34.3651],[31.3657,34.3656],[31.3685,34.3659],
        [31.3696,34.3667],[31.3693,34.3680],[31.3693,34.3689],[31.3697,34.3701],[31.3702,34.3714],
        [31.3710,34.3719],[31.3720,34.3719],[31.3723,34.3715],[31.3730,34.3722],[31.3737,34.3729],
        [31.3738,34.3730],[31.3760,34.3732],[31.3788,34.3740],[31.3804,34.3748],[31.3825,34.3765],
        [31.3858,34.3791],[31.3870,34.3797],[31.3876,34.3803],[31.3891,34.3803],[31.3906,34.3803],
        [31.3919,34.3811],[31.3932,34.3832],[31.3950,34.3855],[31.3969,34.3880],[31.3982,34.3895],
        [31.3993,34.3916],[31.3995,34.3917],[31.4019,34.3950],[31.4046,34.3975],[31.4073,34.4001],
        [31.4103,34.4026],[31.4115,34.4048],[31.4148,34.4111],[31.4185,34.4159],[31.4219,34.4206],
        [31.4272,34.4267],[31.4354,34.4353],[31.4410,34.4419],[31.4490,34.4509],[31.4548,34.4567],
        [31.4594,34.4625],[31.4647,34.4673],[31.4695,34.4728],[31.4748,34.4792],[31.4825,34.4887],
        [31.4892,34.4964],[31.4952,34.5052],[31.5017,34.5181],[31.5016,34.5217],[31.5099,34.5381],
        [31.5051,34.5282],[31.5167,34.5449],[31.5187,34.5494],[31.5274,34.5542],[31.5288,34.5559],
        [31.5319,34.5646],[31.5332,34.5654],[31.5362,34.5663],[31.5401,34.5673],[31.5415,34.5667],
        [31.5427,34.5650],[31.5468,34.5588],[31.5472,34.5581],[31.5487,34.5559],[31.5515,34.5526],
        [31.5527,34.5511],[31.5538,34.5493],[31.5545,34.5482],[31.5566,34.5452],[31.5568,34.5450],
        [31.5574,34.5440],[31.5582,34.5434],[31.5582,34.5434],[31.5583,34.5433],[31.5587,34.5427],
        [31.5604,34.5404],[31.5622,34.5378],[31.5633,34.5364]
    ];
    // Full outline as polygon with subtle fill
    L.polygon(GAZA_OUTLINE, {
        color: '#ffd000', weight: 2.5, opacity: 0.8, dashArray: '8, 5',
        fillColor: '#ffd000', fillOpacity: 0.04,
        className: 'route-line'
    }).bindTooltip('רצועת עזה', { permanent: false, className: 'dark-tooltip', direction: 'center' }).addTo(map);

    // Israel-Gaza fence (eastern border) - highlighted thicker
    const ISRAEL_GAZA_FENCE = [
        [31.2201,34.2675],[31.2206,34.2684],[31.2231,34.2716],[31.2285,34.2784],[31.2344,34.2852],
        [31.2401,34.2906],[31.2434,34.2962],[31.2468,34.3042],[31.2503,34.3124],[31.2536,34.3194],
        [31.2580,34.3258],[31.2619,34.3305],[31.2665,34.3348],[31.2708,34.3378],[31.2765,34.3414],
        [31.2822,34.3497],[31.2905,34.3665],[31.2955,34.3693],[31.3062,34.3733],[31.3144,34.3720],
        [31.3342,34.3687],[31.3476,34.3667],[31.3596,34.3689],[31.3697,34.3714],[31.3738,34.3730],
        [31.3825,34.3765],[31.3891,34.3803],[31.3950,34.3855],[31.4019,34.3950],[31.4103,34.4026],
        [31.4148,34.4111],[31.4272,34.4267],[31.4490,34.4509],[31.4594,34.4625],[31.4647,34.4673],
        [31.4825,34.4887],[31.5017,34.5181],[31.5099,34.5381],[31.5288,34.5559],[31.5401,34.5673],
        [31.5538,34.5493],[31.5633,34.5364],[31.5723,34.5241],[31.5950,34.4910],[31.5969,34.4879]
    ];
    L.polyline(ISRAEL_GAZA_FENCE, {
        color: '#ff4444', weight: 3, opacity: 0.9, dashArray: '12, 4',
    }).bindTooltip('גדר ישראל-עזה', { permanent: false, className: 'dark-tooltip', direction: 'center' }).addTo(map);

    // Egypt-Gaza border (Philadelphi corridor)
    const EGYPT_GAZA_BORDER = [
        [31.2201,34.2675],[31.2262,34.2659],[31.2347,34.2632],[31.2508,34.2563],[31.2705,34.2460],
        [31.2936,34.2325],[31.3066,34.2268],[31.3233,34.2188],[31.3264,34.2159],[31.3458,34.2398],
        [31.4043,34.3082],[31.4351,34.3425],[31.4657,34.3728],[31.4902,34.3962],[31.5487,34.4511],
        [31.5605,34.4607],[31.5969,34.4879]
    ];
    L.polyline(EGYPT_GAZA_BORDER, {
        color: '#ff8800', weight: 2, opacity: 0.7, dashArray: '6, 8',
    }).bindTooltip('גבול מצרים-עזה (פילדלפי)', { permanent: false, className: 'dark-tooltip', direction: 'center' }).addTo(map);

    // ═══════ SECTOR CIRCLE - 3D GLOW ═══════
    // Outer glow ring
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 10500, color: '#00d4ff', fillColor: 'transparent',
        fillOpacity: 0, weight: 1, opacity: 0.15, className: 'sector-outer-glow'
    }).addTo(map);
    // Main sector boundary
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 10000, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.06, weight: 2.5, dashArray: '12, 6', opacity: 0.7,
        className: 'sector-ring'
    }).addTo(map);
    // Inner glow ring
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 9500, color: '#00d4ff', fillColor: 'transparent',
        fillOpacity: 0, weight: 1, dashArray: '4, 8', opacity: 0.2
    }).addTo(map);
    // Mid-range ring for depth
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 5000, color: '#00d4ff', fillColor: 'transparent',
        fillOpacity: 0, weight: 0.5, dashArray: '3, 12', opacity: 0.15
    }).addTo(map);
    // Center marker with glow
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 400, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.15, weight: 1.5, className: 'sector-center-glow'
    }).addTo(map);
    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 150, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.5, weight: 2, className: 'sector-center-dot'
    }).addTo(map);

    // ═══════ OUTSIDE SECTOR - CITIES ═══════
    CITIES_OUTSIDE.forEach(loc => {
        const isArab = ['עזה', 'רפיח', 'דיר אל-בלח'].includes(loc.he);
        const color = isArab ? '#ff6644' : '#ffffff';
        L.circleMarker([loc.lat, loc.lng], {
            radius: 9, color: color, fillColor: color, fillOpacity: 0.2, weight: 2,
            className: 'marker-3d marker-city'
        }).bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] })
          .addTo(map);
    });

    // ═══════ OUTSIDE SECTOR - ARAB VILLAGES ═══════
    ARAB_OUTSIDE.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 5, color: '#ff6644', fillColor: '#ff6644', fillOpacity: 0.25, weight: 1,
            className: 'marker-3d marker-outside'
        }).bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] })
          .bindPopup(buildLocationPopup(loc, 'כפר (מחוץ לגזרה)', '#ff6644'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // Collect all KEY_VILLAGE coords to avoid duplicates from P1/P2
    const keyVillageCoords = new Set(KEY_VILLAGES.map(v => `${v.lat},${v.lng}`));

    // ═══════ IN-SECTOR ARAB VILLAGES (P1/P2) - orange with 3D ═══════
    [...P1_LOCATIONS, ...P2_LOCATIONS].forEach(loc => {
        if (keyVillageCoords.has(`${loc.lat},${loc.lng}`)) return;
        // Outer glow ring
        L.circleMarker([loc.lat, loc.lng], {
            radius: 10, color: '#ff8800', fillColor: '#ff8800', fillOpacity: 0.08, weight: 0,
            className: 'marker-glow-ring', interactive: false
        }).addTo(map);
        L.circleMarker([loc.lat, loc.lng], {
            radius: 6, color: '#ff8800', fillColor: '#ff8800', fillOpacity: 0.5, weight: 2,
            className: 'marker-3d'
        }).bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] })
          .bindPopup(buildLocationPopup(loc, 'כפר', '#ff8800'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // ═══════ ROUTES & CHECKPOINTS - green with 3D ═══════
    P3_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 5, color: '#00ff88', fillColor: '#00ff88', fillOpacity: 0.4, weight: 1.5,
            className: 'marker-3d'
        }).bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] })
          .bindPopup(buildLocationPopup(loc, 'ציר', '#00ff88'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // ═══════ ISRAELI SETTLEMENTS - blue with 3D ═══════
    ISRAELI_LOCATIONS.forEach(loc => {
        const isOutside = loc.outside;
        const opacity = isOutside ? 0.25 : 0.5;
        const radius = isOutside ? 5 : 6;
        const weight = isOutside ? 1 : 2;
        // Glow ring for in-sector
        if (!isOutside) {
            L.circleMarker([loc.lat, loc.lng], {
                radius: 10, color: '#4488ff', fillColor: '#4488ff', fillOpacity: 0.08, weight: 0,
                className: 'marker-glow-ring', interactive: false
            }).addTo(map);
        }
        L.circleMarker([loc.lat, loc.lng], {
            radius: radius, color: '#4488ff', fillColor: '#4488ff', fillOpacity: opacity, weight: weight,
            className: isOutside ? 'marker-3d marker-outside' : 'marker-3d'
        }).bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] })
          .bindPopup(buildLocationPopup(loc, isOutside ? 'ישוב (מחוץ לגזרה)' : 'ישוב', '#4488ff'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // KEY VILLAGES - orange with 3D glow, rich popups on click
    KEY_VILLAGES.forEach(loc => {
        const pColor = '#ff8800';
        // Outer glow ring
        L.circleMarker([loc.lat, loc.lng], {
            radius: 12, color: pColor, fillColor: pColor, fillOpacity: 0.1, weight: 0,
            className: 'marker-glow-ring', interactive: false
        }).addTo(map);
        const marker = L.circleMarker([loc.lat, loc.lng], {
            radius: 7,
            color: pColor,
            fillColor: pColor,
            fillOpacity: 0.55,
            weight: 2,
            className: 'marker-3d marker-key'
        }).addTo(map);

        marker.bindTooltip(loc.he, { className: 'dark-tooltip', direction: 'right', offset: [8, 0] });

        // Rich popup on click with sector history + live data
        marker.on('click', function() {
            const count24h = getVillageReportCount(loc, 24);
            const count72h = getVillageReportCount(loc, 72);
            const lastEvent = getVillageLastEvent(loc);
            const threatTags = (loc.threats || []).map(t =>
                `<span style="display:inline-block;padding:1px 5px;margin:1px;border-radius:3px;background:rgba(255,0,64,0.15);border:1px solid rgba(255,0,64,0.3);font-size:9px;color:#ff8800;">${t}</span>`
            ).join('');
            const mapsLink = `https://www.google.com/maps?q=${loc.lat},${loc.lng}`;

            const popupHtml = `<div style="direction:rtl;text-align:right;min-width:200px;max-width:260px;">` +
                `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">` +
                    `<b style="color:${pColor};font-size:14px;">${loc.he}</b>` +
                    `<span style="font-size:9px;padding:1px 6px;border:1px solid ${pColor};border-radius:3px;color:${pColor};letter-spacing:1px;">${loc.priority}</span>` +
                `</div>` +
                (loc.pop ? `<div style="color:#9ab0c8;font-size:10px;margin-bottom:4px;">אוכלוסייה: ${loc.pop}</div>` : '') +
                `<div style="color:#e0e8f0;font-size:11px;line-height:1.4;margin-bottom:6px;border-right:2px solid ${pColor};padding-right:6px;">${loc.history || ''}</div>` +
                `<div style="margin-bottom:5px;">${threatTags}</div>` +
                `<div style="border-top:1px solid #0f3460;padding-top:4px;display:flex;gap:12px;">` +
                    `<div style="text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">24 שע'</div>` +
                        `<b style="color:${count24h > 0 ? '#ff8800' : '#00ff88'};font-size:14px;">${count24h}</b>` +
                    `</div>` +
                    `<div style="text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">72 שע'</div>` +
                        `<b style="color:${count72h > 0 ? '#ffd000' : '#00ff88'};font-size:14px;">${count72h}</b>` +
                    `</div>` +
                    `<div style="flex:1;text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">אחרון</div>` +
                        `<span style="color:#e0e8f0;font-size:10px;">${lastEvent}</span>` +
                    `</div>` +
                `</div>` +
                `<div style="border-top:1px solid #0f3460;margin-top:6px;padding-top:6px;text-align:center;">` +
                    `<a href="${mapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 פתח במפות Google</a>` +
                `</div>` +
            `</div>`;
            this.unbindPopup();
            this.bindPopup(popupHtml, { className: 'dark-tooltip', maxWidth: 280 }).openPopup();
        });

    });


    // ═══════ RADAR SONAR SWEEP (vertical scan) ═══════
    const mapContainer = document.getElementById('map');

    const radarSweep = document.createElement('div');
    radarSweep.className = 'radar-sweep';
    mapContainer.appendChild(radarSweep);

    const scanLine = document.createElement('div');
    scanLine.className = 'radar-sweep-line';
    radarSweep.appendChild(scanLine);

    const scanTrail = document.createElement('div');
    scanTrail.className = 'radar-sweep-trail';
    radarSweep.appendChild(scanTrail);

    const radarCrosshair = document.createElement('div');
    radarCrosshair.className = 'radar-crosshair';
    mapContainer.appendChild(radarCrosshair);

    const radarRingInner = document.createElement('div');
    radarRingInner.className = 'radar-ring-inner';
    mapContainer.appendChild(radarRingInner);

    const radarDot = document.createElement('div');
    radarDot.className = 'radar-center-dot';
    mapContainer.appendChild(radarDot);

    function updateRadarPosition() {
        const center = map.latLngToContainerPoint([SECTOR_CENTER.lat, SECTOR_CENTER.lng]);
        const metersPerDeg = 111320;
        const edgeLat = SECTOR_CENTER.lat + (10000 / metersPerDeg);
        const edgePoint = map.latLngToContainerPoint([edgeLat, SECTOR_CENTER.lng]);
        const radiusPx = Math.abs(center.y - edgePoint.y);

        radarSweep.style.width = radiusPx * 2 + 'px';
        radarSweep.style.height = radiusPx * 2 + 'px';
        radarSweep.style.left = (center.x - radiusPx) + 'px';
        radarSweep.style.top = (center.y - radiusPx) + 'px';

        const r2 = radiusPx * 0.66;
        radarCrosshair.style.width = r2 * 2 + 'px';
        radarCrosshair.style.height = r2 * 2 + 'px';
        radarCrosshair.style.left = (center.x - r2) + 'px';
        radarCrosshair.style.top = (center.y - r2) + 'px';

        const r3 = radiusPx * 0.33;
        radarRingInner.style.width = r3 * 2 + 'px';
        radarRingInner.style.height = r3 * 2 + 'px';
        radarRingInner.style.left = (center.x - r3) + 'px';
        radarRingInner.style.top = (center.y - r3) + 'px';

        radarDot.style.left = (center.x - 3) + 'px';
        radarDot.style.top = (center.y - 3) + 'px';
    }

    map.on('move zoom moveend zoomend resize', updateRadarPosition);
    updateRadarPosition();
}

function toggleMapFullscreen() {
    const panel = document.getElementById('mapPanel');
    const btn = document.getElementById('mapBtn');
    mapIsFullscreen = !mapIsFullscreen;

    if (mapIsFullscreen) {
        panel.classList.add('fullscreen');
        btn.innerHTML = '&#x2716; סגור';
        btn.style.background = 'rgba(255,0,64,0.25)';
        btn.style.borderColor = '#ff0040';
        btn.style.color = '#ff4466';
        btn.style.fontSize = '13px';
        btn.style.padding = '8px 14px';
        // Prevent body scroll on mobile
        document.body.style.overflow = 'hidden';
    } else {
        panel.classList.remove('fullscreen');
        btn.innerHTML = '&#x26F6; הרחב';
        btn.style.background = '';
        btn.style.borderColor = '';
        btn.style.color = '';
        btn.style.fontSize = '';
        btn.style.padding = '';
        document.body.style.overflow = '';
    }
    setTimeout(() => {
        map.invalidateSize();
        if (mapIsFullscreen && window.innerWidth <= 900) {
            map.setZoom(Math.max(map.getZoom(), 12));
        }
    }, 100);
    setTimeout(() => { map.invalidateSize(); }, 500);
}

function updateMapMarkers(news) {
    alertMarkers.forEach(m => map.removeLayer(m));
    alertMarkers = [];

    // Build threat level per village (highest urgency near each village)
    const allVillages = [...KEY_VILLAGES, ...P1_LOCATIONS.map(l => ({...l, he: l.he})), ...P2_LOCATIONS.map(l => ({...l, he: l.he}))];
    const villageThreat = {};
    Object.values(news).forEach(item => {
        if (!item.coordinates) return;
        allVillages.forEach(v => {
            const dlat = Math.abs((item.coordinates.lat || 0) - v.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - v.lng);
            if (dlat < 0.015 && dlng < 0.015) {
                const key = `${v.lat},${v.lng}`;
                if (!villageThreat[key] || item.urgency > villageThreat[key]) {
                    villageThreat[key] = item.urgency;
                }
            }
        });
    });

    // Add threat rings around villages
    Object.entries(villageThreat).forEach(([key, urgency]) => {
        const [lat, lng] = key.split(',').map(Number);
        const threatColors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#666' };
        const ringColor = threatColors[urgency] || '#666';
        const ring = L.circleMarker([lat, lng], {
            radius: 16, color: ringColor, fillColor: 'transparent',
            fillOpacity: 0, weight: 2.5, opacity: 0.7,
            dashArray: urgency >= 4 ? '' : '6,4',
            className: urgency >= 4 ? 'threat-ring-pulse' : ''
        }).addTo(map);
        alertMarkers.push(ring);
    });

    Object.values(news).forEach(item => {
        if (!item.coordinates) return;
        const colors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#666' };
        const color = colors[item.urgency] || '#666';
        const size = item.urgency >= 4 ? 12 : item.urgency >= 3 ? 9 : 7;

        const marker = L.circleMarker(
            [item.coordinates.lat, item.coordinates.lon || item.coordinates.lng],
            { radius: size, color, fillColor: color, fillOpacity: 0.6, weight: 2 }
        ).bindPopup(`
            <div style="direction:rtl; font-family: 'Rajdhani', sans-serif; max-width: 250px;">
                <b style="color:${color};">[${item.urgencyLabel || 'ALERT'}]</b><br>
                <b>${escapeHtml(item.title || '')}</b><br>
                <small>${escapeHtml(item.snippet || '')}</small><br>
                <small style="color:#888;">${escapeHtml(item.source)} | ${formatTime(item.timestamp)}</small>
            </div>
        `, { className: 'dark-tooltip', maxWidth: 280 }).addTo(map);

        alertMarkers.push(marker);
    });
}

// ═══════ FETCH DATA ═══════
async function fetchData() {
    if (isDemoMode) return; // Don't overwrite demo data
    try {
        const [newsRes, summaryRes, metaRes, weatherRes, calendarRes, sentimentRes, trendsRes] = await Promise.all([
            fetch(`${FIREBASE_URL}/auto-news.json`),
            fetch(`${FIREBASE_URL}/world-news-summary/current.json`),
            fetch(`${FIREBASE_URL}/metadata.json`),
            fetch(`${FIREBASE_URL}/weather/current.json`).catch(() => ({ json: () => null })),
            fetch(`${FIREBASE_URL}/calendar/current.json`).catch(() => ({ json: () => null })),
            fetch(`${FIREBASE_URL}/sentiment/current.json`).catch(() => ({ json: () => null })),
            fetch(`${FIREBASE_URL}/trends/current.json`).catch(() => ({ json: () => null })),
        ]);

        const news = await newsRes.json();
        const summary = await summaryRes.json();
        const meta = await metaRes.json();
        const weather = await weatherRes.json();
        const calendar = await calendarRes.json();
        const sentimentData = await sentimentRes.json();
        const trendsData = await trendsRes.json();

        // Update intel layers
        updateIntelLayers(weather, calendar, sentimentData, trendsData);

        // Skip Firebase error responses
        if (news && !news.error) {
            // Normalize urgencyScore → urgency, and ensure timestamp
            Object.values(news).forEach(item => {
                if (!item.urgency && item.urgencyScore) item.urgency = item.urgencyScore;
                if (!item.timestamp) {
                    if (item.publishedAt) item.timestamp = typeof item.publishedAt === 'number' ? item.publishedAt : new Date(item.publishedAt).getTime();
                    else if (item.date) item.timestamp = new Date(item.date).getTime();
                    else if (item.fetchedAt) item.timestamp = typeof item.fetchedAt === 'number' ? item.fetchedAt : new Date(item.fetchedAt).getTime();
                }
                if (item.timestamp && item.timestamp < 1000000000000) item.timestamp = item.timestamp * 1000;
                if (!item.locationHe && item.matchedLocations) item.locationHe = item.matchedLocations.join(', ');
            });
            const filteredNews = filterSectorNews(news);
            // Detect new alerts for flash
            if (!isFirstLoad) {
                const newIds = Object.keys(filteredNews);
                let hasNewRed = false;
                newIds.forEach(id => {
                    if (!knownIds.has(id) && filteredNews[id].urgency >= 5) hasNewRed = true;
                });
                if (hasNewRed) triggerRedAlert();
            }
            newsData = filteredNews;
            allNewsData = { ...allNewsData, ...filteredNews };
            Object.keys(filteredNews).forEach(id => knownIds.add(id));
        }
        if (summary && !summary.error) summaryData = summary;
        if (meta && !meta.error) metaData = meta;

        isFirstLoad = false;
        document.getElementById('statusDot').className = 'status-dot';
        document.getElementById('statusText').textContent = 'ONLINE';
        renderAll();
    } catch (error) {
        console.error('Fetch error:', error);
        document.getElementById('statusDot').className = 'status-dot offline';
        document.getElementById('statusText').textContent = 'שגיאה';
    }
}

// ═══════ RED ALERT ═══════
function triggerRedAlert() {
    const flash = document.getElementById('redAlertFlash');
    flash.classList.remove('active');
    void flash.offsetWidth; // reflow
    flash.classList.add('active');

    // Audio beep
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'square';
        gain.gain.value = 0.15;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        osc.stop(ctx.currentTime + 0.5);
    } catch (e) {}
}

// ═══════ RENDER ALL ═══════
function renderAll() {
    renderAlerts();
    renderSummary();
    renderStats();
    renderSources();
    renderThreatLevel();
    renderMeta();
    renderTimeline();
    updateMapMarkers(newsData);
    try { renderWhatsApp(); } catch(e) {}
}

// ═══════ FILTERS ═══════
function setFilter(level, btn) {
    activeFilter = level;
    document.querySelectorAll('.alert-toolbar .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderAlerts();
}

function applyFilters() {
    renderAlerts();
}

function toggleAnarchist() {
    showAnarchists = !showAnarchists;
    const toggle = document.getElementById('anarchistToggle');
    toggle.classList.toggle('active', showAnarchists);
    renderAlerts();
}

function isAnarchistEvent(item) {
    const text = ((item.title || '') + ' ' + (item.snippet || '') + ' ' + (item.fullText || '')).toLowerCase();
    return ANARCHIST_KEYWORDS.some(kw => text.includes(kw.toLowerCase()));
}

function setHistoryFilter(level, btn) {
    historyFilter = level;
    document.querySelectorAll('.history-filters .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderHistory();
}

// ═══════ RENDER ALERTS ═══════
function renderAlerts() {
    const feed = document.getElementById('alertFeed');
    let items = Object.values(newsData);
    const searchText = (document.getElementById('searchInput').value || '').toLowerCase();

    // Tag anarchist events
    items.forEach(i => { i._isAnarchist = isAnarchistEvent(i); });

    // Filter by anarchist toggle
    if (!showAnarchists) {
        items = items.filter(i => !i._isAnarchist);
    }

    if (activeFilter === 'anarchist') {
        items = items.filter(i => i._isAnarchist);
    } else if (activeFilter === 'field') {
        items = items.filter(i => i.isFieldReport);
    } else if (activeFilter === 'false') {
        items = items.filter(i => { const aid = i.id || i.timestamp; return aid && alertVotes[aid] && alertVotes[aid].vote === 'dislike'; });
    } else if (activeFilter !== 'all') {
        items = items.filter(i => i.urgency === activeFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    if (items.length === 0) {
        const scanTime = metaData && metaData.lastRun ? formatTime(metaData.lastRun) : '--:--';
        feed.innerHTML = `<div class="empty-state" style="padding:40px;">
            <div style="font-size:28px;margin-bottom:10px;opacity:0.3;">&#x2714;</div>
            ${searchText || activeFilter !== 'all'
                ? '<span>אין התראות תואמות</span><br><small style="color:var(--text-dim);">' + (searchText ? 'נסה חיפוש אחר' : 'נסה פילטר אחר') + '</small>'
                : '<span style="color:var(--green);font-size:14px;font-weight:600;">הגזרה שקטה</span><br><small style="color:var(--text-dim);line-height:2;">המערכת סורקת 25+ ערוצי טלגרם + Google News כל 10 דקות<br>סריקה אחרונה: ' + scanTime + '<br>לחץ <b style="color:var(--yellow);">הדגמה</b> לתצוגת נתונים לדוגמה</small>'
            }
        </div>`;
        return;
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    feed.innerHTML = items.map((item, idx) => {
        const locationName = item.locationHe || (item.matchedLocations ? item.matchedLocations.join(', ') : '') || '';
        const coords = lookupCoords(item);
        const locationTag = locationName
            ? (coords
                ? `<a href="javascript:void(0)" onclick="flyToAlertLocation(${coords.lat},${coords.lng},event)" style="color:#00d4ff;font-size:10px;text-decoration:none;display:inline-flex;align-items:center;gap:3px;margin-top:2px;cursor:pointer;">📍 ${escapeHtml(locationName)}</a>`
                : `<span style="color:#00d4ff;font-size:10px;display:inline-flex;align-items:center;gap:3px;margin-top:2px;">📍 ${escapeHtml(locationName)}</span>`)
            : '';
        const sourceUrl = item.sourceUrl || getSourceUrl(item.source);
        const srcObj = מקורות.find(s => s.id === item.source || s.name === item.source);
        const srcIdForProfile = srcObj ? srcObj.id : (item.source || '');
        const alertId = item.id || item.timestamp || idx;
        const isChecked = checkedAlerts.has(String(alertId));
        const vote = alertVotes[alertId];
        const isDisliked = vote && vote.vote === 'dislike';
        const isLiked = vote && vote.vote === 'like';
        return `
        <div class="alert-item${isChecked ? ' alert-checked' : ''}${isDisliked ? ' alert-false' : ''}${item.keywordHit ? ' keyword-hit' : ''}" onclick="toggleAlertExpand(this)">
            <div class="alert-row">
                <div class="alert-check${isChecked ? ' checked' : ''}" onclick="toggleAlertCheck(this,'${alertId}',event)" title="סמן כנקרא">
                    ${isChecked ? '✓' : ''}
                </div>
                <span class="alert-time">${formatTimeWithDate(item.timestamp)}</span>
                <div class="alert-urgency ${item.isFieldReport ? 'urgency-field' : item._isAnarchist ? 'urgency-anarchist' : 'urgency-' + (item.urgency || 1)}"></div>
                <div class="alert-content">
                    <div class="alert-title">${isDisliked ? '<span class="false-badge">שגוי</span>' : ''}${isLiked ? '<span class="verified-badge">אומת</span>' : ''}${escapeHtml(
                        (item.title && (item.title.endsWith(':') || item.title.length < 20) && item.summary)
                            ? item.summary.substring(0, 120)
                            : (item.title || item.summary || 'N/A')
                    )}</div>
                    ${locationTag}
                </div>
            </div>
            ${(() => {
                const expandText = item.fullText || item.snippet || item.summary || '';
                if (!expandText) return '';
                const lines = expandText.split('\n').map(l => l.trim()).filter(Boolean);
                const unique = lines.filter((line, i) => lines.findIndex(l => l === line || l.replace(/[-,]/g, '') === line.replace(/[-,]/g, '')) === i);
                const deduped = unique.join('\n');
                return '<div class="alert-full-text" style="display:none;">' + escapeHtml(deduped) + '</div>';
            })()}
            <div class="alert-meta-row" style="display:none;">
                <a href="javascript:void(0)" onclick="openPublisherProfile('${escapeHtml(srcIdForProfile)}',event)" class="source-link-clickable" style="color:#00d4ff;font-size:10px;text-decoration:none;">&#128225; ${escapeHtml(item.source || 'N/A')}</a>
                ${sourceUrl ? '<a href="' + escapeHtml(sourceUrl) + '" target="_blank" onclick="event.stopPropagation();" style="color:var(--text-dim);font-size:10px;text-decoration:none;">&#128279; מקור</a>' : ''}
                ${item.matchedKeywords ? '<span>KW: ' + escapeHtml(item.matchedKeywords.join(', ')) + '</span>' : ''}
                <div class="vote-buttons">
                    <button class="vote-btn vote-like${isLiked ? ' active' : ''}" onclick="toggleVote('${alertId}','like',event)" title="אמין"><svg viewBox="0 0 24 24"><path d="M2 20h2V8H2v12zm20-11a2 2 0 0 0-2-2h-6.31l.95-4.57.03-.32a1.49 1.49 0 0 0-.44-1.06L13.17 0 6.59 6.59A1.98 1.98 0 0 0 6 8v10a2 2 0 0 0 2 2h9a2 2 0 0 0 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73V9z"/></svg></button>
                    <button class="vote-btn vote-dislike${isDisliked ? ' active' : ''}" onclick="toggleVote('${alertId}','dislike',event)" title="שגוי"><svg viewBox="0 0 24 24"><path d="M22 4h-2v12h2V4zM2 15a2 2 0 0 0 2 2h6.31l-.95 4.57-.03.32c0 .4.17.77.44 1.06L10.83 24l6.58-6.59A1.98 1.98 0 0 0 18 16V6a2 2 0 0 0-2-2H7a2 2 0 0 0-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2z"/></svg></button>
                </div>
            </div>
        </div>
    `}).join('');
}

function toggleAlertExpand(el) {
    const fullText = el.querySelector('.alert-full-text');
    const metaRow = el.querySelector('.alert-meta-row');
    const isExpanded = el.classList.contains('expanded');

    // Close all others
    document.querySelectorAll('.alert-item.expanded').forEach(item => {
        if (item !== el) {
            item.classList.remove('expanded');
            const ft = item.querySelector('.alert-full-text');
            if (ft) ft.style.display = 'none';
            const mr = item.querySelector('.alert-meta-row');
            if (mr) mr.style.display = 'none';
        }
    });

    if (isExpanded) {
        el.classList.remove('expanded');
        if (fullText) fullText.style.display = 'none';
        metaRow.style.display = 'none';
    } else {
        el.classList.add('expanded');
        if (fullText) fullText.style.display = 'block';
        metaRow.style.display = 'flex';
    }
}

function toggleAlertCheck(el, alertId, event) {
    event.stopPropagation();
    const item = el.closest('.alert-item');
    if (checkedAlerts.has(String(alertId))) {
        checkedAlerts.delete(String(alertId));
        el.classList.remove('checked');
        el.textContent = '';
        item.classList.remove('alert-checked');
    } else {
        checkedAlerts.add(String(alertId));
        el.classList.add('checked');
        el.textContent = '✓';
        item.classList.add('alert-checked');
    }
    localStorage.setItem('mabat188-checked', JSON.stringify([...checkedAlerts]));
}

function flyToAlertLocation(lat, lng, event) {
    event.stopPropagation();
    if (mapIsFullscreen) toggleMapFullscreen();
    const mapEl = document.getElementById('mapPanel');
    mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
        map.flyTo([lat, lng], 15, { duration: 1 });
        // Flash a temporary marker
        const pulse = L.circleMarker([lat, lng], {
            radius: 20, color: '#00d4ff', fillColor: '#00d4ff',
            fillOpacity: 0.3, weight: 2
        }).addTo(map);
        setTimeout(() => map.removeLayer(pulse), 3000);
    }, 400);
}

// ═══════ RENDER TIMELINE ═══════
function renderTimeline() {
    const container = document.getElementById('timelineBars');
    const hoursContainer = document.getElementById('timelineHours');
    const items = Object.values(newsData);
    const now = Date.now();
    const hours = 24;
    const buckets = Array.from({ length: hours }, () => ({ count: 0, maxUrg: 0 }));

    items.forEach(item => {
        const age = (now - (item.timestamp || 0)) / (1000 * 60 * 60);
        const bucket = Math.min(hours - 1, Math.max(0, Math.floor(age)));
        buckets[bucket].count++;
        buckets[bucket].maxUrg = Math.max(buckets[bucket].maxUrg, item.urgency || 1);
    });

    const maxCount = Math.max(1, ...buckets.map(b => b.count));

    // Reverse so newest is on the right
    const reversed = [...buckets].reverse();

    container.innerHTML = reversed.map((b, i) => {
        const h = Math.max(2, (b.count / maxCount) * 35);
        const urgClass = b.maxUrg >= 5 ? 'has-red' : b.maxUrg >= 4 ? 'has-orange' : b.maxUrg >= 3 ? 'has-yellow' : b.count > 0 ? 'has-blue' : '';
        return `<div class="timeline-bar ${urgClass}" style="height:${h}px;" title="${b.count} alerts"></div>`;
    }).join('');

    // Hour labels
    const nowHour = new Date().getHours();
    hoursContainer.innerHTML = '';
    for (let i = 0; i < hours; i += 6) {
        const label = String((nowHour - hours + 1 + i + 24) % 24).padStart(2, '0') + ':00';
        const span = document.createElement('span');
        span.textContent = label;
        hoursContainer.appendChild(span);
    }
}

// ═══════ RENDER SUMMARY ═══════
function renderSummary() {
    const body = document.getElementById('summaryBody');
    if (!summaryData || !summaryData.summary) {
        body.innerHTML = '<div class="empty-state">ממתין לניתוח AI<br><small>מתעדכן כל שעה</small></div>';
        return;
    }
    body.innerHTML = `
        <div class="summary-text">${escapeHtml(summaryData.summary)}</div>
        <div class="summary-meta">
            <span>${summaryData.aiProvider || 'Gemini'} AI</span>
            <span>${formatDateTime(summaryData.generatedAt)}</span>
        </div>
    `;
}

// ═══════ RENDER STATS ═══════
function renderStats() {
    const items = Object.values(newsData);
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    const sources = new Set();

    items.forEach(item => {
        counts[item.urgency || 1]++;
        if (item.source) sources.add(item.source);
    });

    document.getElementById('statTotal').textContent = items.length;
    document.getElementById('statRed').textContent = counts[5];
    document.getElementById('statOrange').textContent = counts[4];
    document.getElementById('statYellow').textContent = counts[3];
    document.getElementById('statBlue').textContent = counts[2] + counts[1];
    document.getElementById('statSources').textContent = sources.size;
    document.getElementById('alertCount').textContent = items.length;
}

// ═══════ RENDER רמת איום ═══════
function renderThreatLevel() {
    const items = Object.values(newsData);
    let maxUrgency = 0;
    const recentCutoff = Date.now() - (6 * 60 * 60 * 1000);

    items.forEach(item => {
        if (item.timestamp > recentCutoff && item.urgency > maxUrgency) {
            maxUrgency = item.urgency;
        }
    });

    const circle = document.getElementById('threatCircle');
    const num = document.getElementById('threatNum');
    const label = document.getElementById('threatLabel');

    const levels = {
        0: { class: 'level-green', label: 'תקין', color: '#00ff88' },
        1: { class: 'level-gray', label: 'מינימלי', color: '#666' },
        2: { class: 'level-blue', label: 'חלש', color: '#4488ff' },
        3: { class: 'level-yellow', label: 'בינוני', color: '#ffd000' },
        4: { class: 'level-orange', label: 'חזק', color: '#ff8800' },
        5: { class: 'level-red', label: 'ודאי', color: '#ff0040' }
    };

    const level = levels[maxUrgency] || levels[0];
    circle.className = `threat-circle ${level.class}`;
    num.textContent = maxUrgency;
    num.style.color = level.color;
    label.textContent = level.label;
    label.style.color = level.color;

    const bars = document.querySelectorAll('.threat-bar');
    bars.forEach((bar, i) => {
        if (i < maxUrgency) {
            bar.style.background = level.color;
            bar.style.boxShadow = `0 0 8px ${level.color}`;
        } else {
            bar.style.background = 'var(--bg-primary)';
            bar.style.boxShadow = 'none';
        }
    });
}

// ═══════ RENDER מקורות ═══════
function toggleSourcesDropdown() {
    document.getElementById('sourcesContainer').classList.toggle('expanded');
}

function renderSources() {
    const items = Object.values(newsData);
    const sourceCounts = {};
    items.forEach(item => {
        if (item.source) sourceCounts[item.source] = (sourceCounts[item.source] || 0) + 1;
    });

    const list = document.getElementById('sourcesList');
    list.innerHTML = מקורות.map(src => {
        const count = sourceCounts[src.id] || sourceCounts[src.name] || 0;
        const isActive = count > 0;
        const typeLabels = { local: 'LOCAL', regional: 'AREA', national: 'NATL', news: 'NEWS' };
        return `
            <div class="source-item" style="cursor:pointer;" onclick="openPublisherProfile('${escapeHtml(src.id)}',event)">
                <div class="source-dot ${isActive ? 'active' : 'inactive'}"></div>
                <span class="source-name source-link-clickable">${src.name}</span>
                <span class="source-type ${src.type}">${typeLabels[src.type]}</span>
                <span class="source-count">${count > 0 ? count : ''}</span>
            </div>
        `;
    }).join('');
}

function renderMeta() {
    if (metaData && metaData.lastRun) {
        document.getElementById('lastScan').textContent = formatTime(metaData.lastRun);
    }
}

// ═══════ INTEL LAYERS ═══════
async function fetchWeatherDirect() {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${SECTOR_CENTER.lat}&lon=${SECTOR_CENTER.lng}&appid=4a4f2b3c8e9d4f6a8b2c1d0e3f5a7b9c&units=metric&lang=he`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.main) {
            const wEl = document.getElementById('weatherVal');
            if (wEl) wEl.textContent = `${Math.round(data.main.temp)}°C ${data.weather?.[0]?.description || ''}`;
        }
    } catch (e) { /* silent */ }
}

function checkCalendarLocal() {
    const now = new Date();
    const m = now.getMonth() + 1, d = now.getDate();
    const md = `${m}-${d}`;
    const dates = { '1-1': 'יום פתח', '3-30': 'יום האדמה', '4-17': 'יום האסיר', '5-15': 'יום הנכבה', '6-5': 'יום הנכסה', '11-15': 'יום עצמאות פלסטיני', '11-29': 'יום סולידריות' };
    const isFriday = now.getDay() === 5;
    const cEl = document.getElementById('calendarVal');
    if (!cEl) return;
    const parts = [];
    if (dates[md]) parts.push(dates[md]);
    if (isFriday) parts.push('יום שישי');
    if (parts.length > 0) {
        cEl.textContent = parts.join(' | ');
        cEl.style.color = dates[md] ? 'var(--orange)' : 'var(--yellow)';
    }
}

function updateIntelLayers(weather, calendar, sentiment, trends) {
    // Weather - from Firebase (backend), fallback handled by fetchWeatherDirect
    const wEl = document.getElementById('weatherVal');
    if (wEl && weather && !weather.error && weather.temp) {
        wEl.textContent = `${weather.temp}°C ${weather.description}`;
    }

    // Calendar
    const cEl = document.getElementById('calendarVal');
    if (cEl && calendar && !calendar.error) {
        if (calendar.urgencyBoost > 0) {
            const parts = [];
            if (calendar.specificEvent) parts.push(calendar.specificEvent.name);
            if (calendar.isRamadan) parts.push('רמדאן');
            if (calendar.isFriday) parts.push('יום שישי');
            cEl.textContent = parts.join(' | ') + ` (+${calendar.urgencyBoost})`;
            cEl.style.color = calendar.urgencyBoost >= 3 ? 'var(--red)' : calendar.urgencyBoost >= 2 ? 'var(--orange)' : 'var(--yellow)';
        } else {
            cEl.textContent = 'רגיל';
            cEl.style.color = 'var(--green)';
        }
    }

    // Sentiment
    const sEl = document.getElementById('sentimentVal');
    if (sEl && sentiment && !sentiment.error && sentiment.level) {
        const colors = { low: 'var(--green)', moderate: 'var(--yellow)', high: 'var(--orange)', critical: 'var(--red)' };
        const labels = { low: 'נמוך', moderate: 'בינוני', high: 'גבוה', critical: 'קריטי' };
        sEl.textContent = `${labels[sentiment.level] || sentiment.level} (${sentiment.score}/10)`;
        sEl.style.color = colors[sentiment.level] || 'var(--cyan)';
    }

    // Trends
    const tEl = document.getElementById('trendsVal');
    if (tEl && trends && !trends.error) {
        const count = Array.isArray(trends) ? trends.length : 0;
        tEl.textContent = count > 0 ? `${count} פעילות` : '0';
        tEl.style.color = count > 0 ? 'var(--orange)' : 'var(--green)';
        if (count > 0) tEl.title = trends.map(t => `${t.location}: ${t.reportCount} דיווחים`).join('\n');
    }
}

// ═══════ HISTORY ═══════
function toggleHistory() {
    const overlay = document.getElementById('historyOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        loadJournalNotes().then(() => fetchHistory());
    }
}

async function fetchHistory() {
    try {
        const res = await fetch(`${FIREBASE_URL}/auto-news.json`);
        const data = await res.json();
        if (data) {
            // Normalize all items
            Object.values(data).forEach(item => {
                if (!item.urgency && item.urgencyScore) item.urgency = item.urgencyScore;
                if (!item.timestamp) {
                    if (item.publishedAt) item.timestamp = typeof item.publishedAt === 'number' ? item.publishedAt : new Date(item.publishedAt).getTime();
                    else if (item.date) item.timestamp = new Date(item.date).getTime();
                    else if (item.fetchedAt) item.timestamp = typeof item.fetchedAt === 'number' ? item.fetchedAt : new Date(item.fetchedAt).getTime();
                }
                // Handle seconds vs milliseconds (if timestamp < year 2000 in ms, it's probably seconds)
                if (item.timestamp && item.timestamp < 1000000000000) item.timestamp = item.timestamp * 1000;
                if (!item.locationHe && item.matchedLocations) item.locationHe = item.matchedLocations.join(', ');
            });
            allNewsData = filterSectorNews(data);
        }
        renderHistory();
    } catch (e) {
        document.getElementById('historyBody').innerHTML = '<div class="empty-state">שגיאה בטעינת יומן</div>';
    }
}

function renderHistory() {
    const body = document.getElementById('historyBody');
    const searchText = (document.getElementById('historySearch').value || '').toLowerCase();
    let items = Object.values(allNewsData);

    if (historyFilter === 'false') {
        items = items.filter(i => { const aid = i.id || i.timestamp; return aid && alertVotes[aid] && alertVotes[aid].vote === 'dislike'; });
    } else if (historyFilter !== 'all') {
        items = items.filter(i => i.urgency === historyFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    // Stats
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    items.forEach(i => counts[i.urgency || 1]++);
    document.getElementById('historyStats').innerHTML = `
        <div class="history-stat"><strong>${items.length}</strong> סה"כ</div>
        <div class="history-stat"><strong style="color:var(--red)">${counts[5]}</strong> ודאי</div>
        <div class="history-stat"><strong style="color:var(--orange)">${counts[4]}</strong> חזק</div>
        <div class="history-stat"><strong style="color:var(--yellow)">${counts[3]}</strong> בינוני</div>
        <div class="history-stat"><strong style="color:var(--blue)">${counts[2] + counts[1]}</strong> חלש</div>
    `;

    // Group by date
    const groups = {};
    items.forEach(item => {
        const d = new Date(item.timestamp || 0);
        const key = d.toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        if (!groups[key]) groups[key] = [];
        groups[key].push(item);
    });

    if (Object.keys(groups).length === 0) {
        body.innerHTML = '<div class="empty-state">אין רשומות תואמות</div>';
        return;
    }

    const colors = { 5: 'var(--red)', 4: 'var(--orange)', 3: 'var(--yellow)', 2: 'var(--blue)', 1: '#666' };

    const urgLabels = { 5: 'ודאי', 4: 'חזק', 3: 'בינוני', 2: 'חלש', 1: 'מידע' };

    body.innerHTML = Object.entries(groups).map(([date, dateItems]) => `
        <div class="history-date-group">
            <div class="history-date-header">${date} <span style="color:var(--text-dim);">(${dateItems.length} דיווחים)</span></div>
            ${dateItems.map(item => {
                const hLocName = item.locationHe || (item.matchedLocations ? item.matchedLocations.join(', ') : '') || '';
                const hCoords = lookupCoords(item);
                const urgColor = colors[item.urgency] || '#666';
                const urgLabel = urgLabels[item.urgency] || '';
                const sourceUrl = item.sourceUrl || getSourceUrl(item.source);
                const hSrcObj = מקורות.find(s => s.id === item.source || s.name === item.source);
                const hSrcId = hSrcObj ? hSrcObj.id : (item.source || '');
                const sourceTag = `<a href="javascript:void(0)" onclick="event.stopPropagation();openPublisherProfile('${escapeHtml(hSrcId)}',event)" class="source-link-clickable" style="color:#00d4ff;font-size:10px;text-decoration:none;">📡 ${escapeHtml(item.source || '')}</a>`;
                const locTag = hLocName
                    ? (hCoords
                        ? `<a href="javascript:void(0)" onclick="toggleHistory();setTimeout(()=>{map.flyTo([${hCoords.lat},${hCoords.lng}],15,{duration:1})},300)" style="color:#00d4ff;font-size:10px;text-decoration:none;cursor:pointer;">📍 ${escapeHtml(hLocName)}</a>`
                        : `<span style="color:#00d4ff;font-size:10px;">📍 ${escapeHtml(hLocName)}</span>`)
                    : '';
                const noteId = item.id || item.timestamp || '';
                const note = journalNotes[noteId];
                const hVote = alertVotes[noteId];
                const hIsDisliked = hVote && hVote.vote === 'dislike';
                const hIsLiked = hVote && hVote.vote === 'like';
                const voteBadge = hIsDisliked ? '<span class="false-badge">שגוי</span>' : hIsLiked ? '<span class="verified-badge">אומת</span>' : '';
                const noteHtml = note
                    ? `<div class="journal-saved-note">
                        <div><strong>מדווח:</strong> ${escapeHtml(note.reporter || '-')}</div>
                        ${note.details ? '<div><strong>פרטים:</strong> ' + escapeHtml(note.details) + '</div>' : ''}
                        <div style="display:flex;gap:6px;margin-top:4px;">
                            <button class="journal-note-btn" onclick="toggleNoteForm('${noteId}')">ערוך</button>
                            <button class="journal-note-btn" style="color:var(--red);border-color:var(--red-dim);" onclick="deleteJournalNote('${noteId}')">מחק</button>
                        </div>
                       </div>`
                    : '';
                return `
                <div class="history-item${hIsDisliked ? ' alert-false' : ''}" style="border-right:3px solid ${urgColor};">
                    <span class="history-item-time">${formatTime(item.timestamp)}</span>
                    <div class="history-item-urgency" style="background:${urgColor}; box-shadow: 0 0 6px ${urgColor};"></div>
                    <div class="history-item-content">
                        <div class="history-item-title">${voteBadge}${escapeHtml(item.title || 'N/A')}</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:3px;">
                            <span style="font-size:9px;padding:1px 6px;border-radius:3px;background:${urgColor}22;border:1px solid ${urgColor};color:${urgColor};">${urgLabel}</span>
                            ${locTag}
                            ${sourceTag}
                            <div class="vote-buttons" style="margin-right:4px;">
                                <button class="vote-btn vote-like${hIsLiked ? ' active' : ''}" onclick="event.stopPropagation();toggleVote('${noteId}','like',event).then(()=>renderHistory())" title="אמין" style="width:24px;height:24px;"><svg viewBox="0 0 24 24"><path d="M2 20h2V8H2v12zm20-11a2 2 0 0 0-2-2h-6.31l.95-4.57.03-.32a1.49 1.49 0 0 0-.44-1.06L13.17 0 6.59 6.59A1.98 1.98 0 0 0 6 8v10a2 2 0 0 0 2 2h9a2 2 0 0 0 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73V9z"/></svg></button>
                                <button class="vote-btn vote-dislike${hIsDisliked ? ' active' : ''}" onclick="event.stopPropagation();toggleVote('${noteId}','dislike',event).then(()=>renderHistory())" title="שגוי" style="width:24px;height:24px;"><svg viewBox="0 0 24 24"><path d="M22 4h-2v12h2V4zM2 15a2 2 0 0 0 2 2h6.31l-.95 4.57-.03.32c0 .4.17.77.44 1.06L10.83 24l6.58-6.59A1.98 1.98 0 0 0 18 16V6a2 2 0 0 0-2-2H7a2 2 0 0 0-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2z"/></svg></button>
                            </div>
                            <button class="journal-note-btn" onclick="event.stopPropagation();toggleNoteForm('${noteId}')">${note ? '📝' : '➕ הוסף מידע'}</button>
                        </div>
                        ${noteHtml}
                        <div class="journal-note-form" id="note-form-${noteId}" style="display:none;">
                            <input name="reporter" placeholder="שם המדווח" value="${note ? escapeHtml(note.reporter || '') : ''}">
                            <textarea name="details" placeholder="פרטים ואופן טיפול">${note ? escapeHtml(note.details || '') : ''}</textarea>
                            <div class="journal-note-actions">
                                <button class="journal-note-cancel" onclick="event.stopPropagation();toggleNoteForm('${noteId}')">ביטול</button>
                                <button class="journal-note-save" onclick="event.stopPropagation();saveJournalNote('${noteId}')">שמור</button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('')}
        </div>
    `).join('');
}

// ═══════ VILLAGE REPORT COUNT ═══════
function getVillageReportCount(village, hours) {
    const cutoff = Date.now() - (hours * 60 * 60 * 1000);
    const items = Object.values(newsData);
    let count = 0;
    items.forEach(item => {
        if ((item.timestamp || 0) < cutoff) return;
        // Check by coordinates proximity (within ~2km)
        if (item.coordinates) {
            const dlat = Math.abs((item.coordinates.lat || 0) - village.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - village.lng);
            if (dlat < 0.02 && dlng < 0.02) { count++; return; }
        }
        // Check by matched location name
        if (item.matchedLocations) {
            const names = item.matchedLocations.join(' ').toLowerCase();
            const heName = village.he.toLowerCase();
            if (names.includes(heName)) { count++; }
        }
    });
    return count;
}

// ═══════ VILLAGE LAST EVENT ═══════
function getVillageLastEvent(village) {
    const items = Object.values(newsData);
    let latest = null;
    items.forEach(item => {
        let match = false;
        if (item.coordinates) {
            const dlat = Math.abs((item.coordinates.lat || 0) - village.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - village.lng);
            if (dlat < 0.02 && dlng < 0.02) match = true;
        }
        if (!match && item.matchedLocations) {
            const names = item.matchedLocations.join(' ').toLowerCase();
            if (names.includes(village.he.toLowerCase())) match = true;
        }
        if (match && (!latest || (item.timestamp || 0) > (latest.timestamp || 0))) {
            latest = item;
        }
    });
    if (!latest) return 'אין';
    return formatTime(latest.timestamp);
}

// ═══════ UTILITIES ═══════
function formatTime(ts) {
    if (!ts) return '--:--';
    const d = new Date(ts);
    return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
}

function formatTimeWithDate(ts) {
    if (!ts) return '--:--';
    const d = new Date(ts);
    const now = new Date();
    const isToday = d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    const time = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    if (isToday) return time;
    return d.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' }) + ' ' + time;
}

function formatDateTime(ts) {
    if (!ts) return '--';
    const d = new Date(ts);
    return d.toLocaleDateString('he-IL') + ' ' + formatTime(ts);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ═══════ PUBLISHER PROFILE ═══════
const DEFAULT_PROFILES = {
    gazaalannet: { name:"غزة الآن - עזה עכשיו", location:"עזה, פלסטין", notes:"ערוץ חדשות מקומי מרכזי מרצועת עזה. סיקור בזמן אמת." },
    GazaNewsNow: { name:"أخبار غزة الحدث - חדשות עזה", location:"עזה, פלסטין", notes:"ערוץ חדשות מעודכן מרצועת עזה" },
    gazala7zapal1: { name:"غزة الأحزاب - עזה מפלגות", location:"עזה, פלסטין", notes:"ערוץ חדשות פוליטי וביטחוני מעזה" },
    akh_bar_gaza: { name:"أخبار غزة - חדשות עזה", location:"עזה, פלסטין", notes:"ערוץ חדשות כללי מרצועת עזה" },
    mtqdmon: { name:"المتقدمون - המתקדמים", location:"עזה, פלסטין", notes:"ערוץ חדשות וניתוח מפלסטין" },
    QudsN: { name:"شبكة قدس الإخبارية - רשת קודס", location:"פלסטין", subscribers:"699,392", notes:"רשת מדיה פלסטינית עצמאית. בוט: @QudsNN_bot" },
    SamaNewsAgency: { name:"وكالة سما الإخبارية - סוכנות סמא", location:"עזה, פלסטין", notes:"סוכנות ידיעות פלסטינית מעזה" },
    palinfo: { name:"المركز الفلسطيني للإعلام - מרכז תקשורת", location:"פלסטין", notes:"מרכז תקשורת פלסטיני" },
    PalestineResist: { name:"Resistance News Network", location:"פלסטין", subscribers:"142,177", notes:"The pulse of the resistance. גיבוי: @RNN_Backup" },
    eyeonpal: { name:"عين على فلسطين - עין על פלסטין", location:"פלסטין", notes:"סיקור ומעקב אירועים בפלסטין" },
    "google-news": { name:"Google News", location:"גלובלי", notes:"מנוע חדשות גוגל - חיפוש בערבית ועברית" },
    haitham_alsid: { name:"הית'ם אלסיד", location:"עזה, פלסטין", notes:"פרשן ומקור מקומי מרצועת עזה" },
    ismail_abuamr: { name:"העיתנאי אסמאעיל אבו-עמר - דיונים", location:"עזה, פלסטין", notes:"עיתנאי מקומי, דיונים וניתוחים מעזה" },
    hamza_almasr: { name:"דיונים - הפעיל חמזה אלמצר", location:"עזה, פלסטין", notes:"פעיל מקומי, דיונים מרצועת עזה" },
    maman_miqdad: { name:"מא'מן מקדאד, תגובות", location:"עזה, פלסטין", notes:"תגובות ודיונים מקומיים" },
    dopek_gaza: { name:"הדופק של הרחוב העזתי", location:"עזה, פלסטין", notes:"ערוץ קהילתי - דופק הרחוב בעזה" },
    diyunim_gaza: { name:"דיונים בעזה #תפיסה_משת\"פ", location:"עזה, פלסטין", notes:"דיונים על אירועי ביטחון בעזה, תפיסות משתפים" },
    solar_gaza: { name:"האנרגיה הסולארית ותחזוקתה ברצועת עזה", location:"עזה, פלסטין", notes:"קבוצה טכנית - תשתיות אנרגיה ברצועה" },
    ihud_gaza: { name:"דיוני האיחוד בעזה", location:"עזה, פלסטין", notes:"דיונים פוליטיים ואיחוד פלגים" },
    albayouk: { name:"התכנסות משפחת אלביוק", location:"ח'אן יונס, פלסטין", notes:"קבוצת משפחת אלביוק - ח'אן יונס" },
    alqarara_news: { name:"חדשות אלקרארה - מדיניות מקומית בידור", location:"אל-קררה, פלסטין", notes:"חדשות מקומיות מאל-קררה, פוליטיקה ובידור" },
    gaza_now2: { name:"עזה עכשיו 2", location:"עזה, פלסטין", notes:"ערוץ חדשות משני מרצועת עזה" },
    thawra_neshama: { name:"תגובות מהפכת הנשמה", location:"עזה, פלסטין", notes:"קבוצת דיון ותגובות" },
    mustafa_school: { name:"בית הספר היסודי מצטפא חאפט'", location:"ח'אן יונס, פלסטין", notes:"קבוצת בית ספר מקומי - חאן יונס" },
    qarib_shana: { name:"קרוב לשנה של האזור", location:"עזה, פלסטין", notes:"קבוצת סקירה שנתית ואירועי אזור" },
    masjid_saladin: { name:"משפחת מסגד צלאח אלדין", location:"ח'אן יונס, פלסטין", notes:"קבוצה קהילתית - מסגד צלאח א-דין בחאן יונס" },
    death_tracker_ky: { name:"מעקב אחר מקר המוות בעיר ח'אן יונס", location:"ח'אן יונס, פלסטין", notes:"מעקב נפגעים ואירועים בח'אן יונס" },
    had_albalad: { name:"הד אלבלד", location:"עזה, פלסטין", notes:"ערוץ חדשות מקומי - הד העיר" },
    gas_tracker: { name:"חוליית מעקב אחר הגז - מחמד פרחאנה", location:"ח'אן יונס, פלסטין", notes:"מעקב הפצת גז בח'אן יונס" },
    melek_hatzaot: { name:"מלך ההצעות", location:"עזה, פלסטין", notes:"קבוצת מסחר ושירותים מקומית" },
    siua_news_gaza: { name:"דיווי חדשות הסיוע - עזה", location:"עזה, פלסטין", notes:"מעקב אחר חלוקת סיוע הומניטרי ברצועה" }
};

let publisherProfiles = {};
let currentPublisherId = null;

async function loadPublisherProfiles() {
    // Start with defaults
    publisherProfiles = JSON.parse(JSON.stringify(DEFAULT_PROFILES));
    try {
        const res = await fetch(`${FIREBASE_URL}/publisher-profiles.json`);
        const data = await res.json();
        if (data && !data.error) {
            // Merge Firebase data over defaults
            Object.keys(data).forEach(k => { publisherProfiles[k] = { ...publisherProfiles[k], ...data[k] }; });
        }
    } catch (e) {
        console.error('Error loading publisher profiles:', e);
    }
}

function openPublisherProfile(sourceId, event) {
    if (event) event.stopPropagation();
    currentPublisherId = sourceId;
    const srcObj = מקורות.find(s => s.id === sourceId);
    const profile = publisherProfiles[sourceId] || {};
    const card = document.getElementById('publisherCard');

    // Compute stats from allNewsData
    const allItems = Object.values(allNewsData);
    const srcItems = allItems.filter(i => i.source === sourceId || i.source === (srcObj ? srcObj.name : ''));
    const totalReports = srcItems.length;
    const lastReport = srcItems.length > 0 ? Math.max(...srcItems.map(i => i.timestamp || 0)) : 0;
    const locCounts = {};
    srcItems.forEach(i => {
        const loc = i.locationHe || (i.matchedLocations ? i.matchedLocations.join(', ') : '');
        if (loc) locCounts[loc] = (locCounts[loc] || 0) + 1;
    });
    const topLocations = Object.entries(locCounts).sort((a,b) => b[1]-a[1]).slice(0,3).map(e => e[0]);

    const srcName = profile.name || (srcObj ? srcObj.name : sourceId);
    const srcType = srcObj ? ({ local:'מקומי', regional:'אזורי', national:'ארצי', news:'חדשות' }[srcObj.type] || srcObj.type) : '';
    const tgLink = srcObj && srcObj.tg ? `https://t.me/${srcObj.tg}` : '';

    card.innerHTML = `
        <div class="publisher-card-header">
            ${profile.photo
                ? `<img src="${escapeHtml(profile.photo)}" class="publisher-photo" onerror="this.outerHTML='<div class=\\'publisher-photo-placeholder\\'>📡</div>'">`
                : '<div class="publisher-photo-placeholder">📡</div>'}
            <div>
                <div class="publisher-name">${escapeHtml(srcName)}</div>
                <div class="publisher-subtitle">${escapeHtml(srcType)}${tgLink ? ' | <a href="' + escapeHtml(tgLink) + '" target="_blank" style="color:var(--cyan);text-decoration:none;" onclick="event.stopPropagation();">Telegram ↗</a>' : ''}</div>
            </div>
        </div>
        <div class="publisher-stats">
            <div class="publisher-stat-box">
                <div class="publisher-stat-value">${totalReports}</div>
                <div class="publisher-stat-label">דיווחים</div>
            </div>
            <div class="publisher-stat-box">
                <div class="publisher-stat-value">${lastReport ? formatTimeWithDate(lastReport) : '--'}</div>
                <div class="publisher-stat-label">דיווח אחרון</div>
            </div>
            <div class="publisher-stat-box">
                <div class="publisher-stat-value">${profile.subscribers || '--'}</div>
                <div class="publisher-stat-label">מנויים</div>
            </div>
        </div>
        ${topLocations.length > 0 ? `<div style="margin-bottom:12px;"><span style="font-family:var(--font-he);font-size:10px;color:var(--text-dim);">מיקומים עיקריים:</span> <span style="font-family:var(--font-he);font-size:11px;color:var(--cyan);">${topLocations.map(l => escapeHtml(l)).join(' | ')}</span></div>` : ''}
        <div class="publisher-info-grid" id="publisherInfoGrid">
            <span class="publisher-info-label">מיקום</span><span class="publisher-info-value">${escapeHtml(profile.location || '--')}</span>
            <span class="publisher-info-label">גיל</span><span class="publisher-info-value">${escapeHtml(profile.age || '--')}</span>
            <span class="publisher-info-label">עיסוק</span><span class="publisher-info-value">${escapeHtml(profile.occupation || '--')}</span>
            <span class="publisher-info-label">בן/בת זוג</span><span class="publisher-info-value">${escapeHtml(profile.partner || '--')}</span>
            <span class="publisher-info-label">תחביבים</span><span class="publisher-info-value">${escapeHtml(profile.hobbies || '--')}</span>
            <span class="publisher-info-label">הערות</span><span class="publisher-info-value">${escapeHtml(profile.notes || '--')}</span>
        </div>
        <div id="publisherEditForm" style="display:none;">
            <div class="publisher-edit-field"><label>שם</label><input id="pe_name" value="${escapeHtml(profile.name || srcName)}"></div>
            <div class="publisher-edit-field"><label>תמונה</label><div style="display:flex;gap:6px;align-items:center;"><input id="pe_photo" value="${escapeHtml(profile.photo || '')}" placeholder="URL תמונה" style="flex:1;"><label style="cursor:pointer;padding:5px 10px;border:1px solid var(--cyan);border-radius:3px;color:var(--cyan);font-size:10px;white-space:nowrap;">📷 העלה<input type="file" id="pe_photo_file" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)"></label></div></div>
            <div class="publisher-edit-field"><label>מיקום</label><input id="pe_location" value="${escapeHtml(profile.location || '')}"></div>
            <div class="publisher-edit-field"><label>גיל</label><input id="pe_age" value="${escapeHtml(profile.age || '')}"></div>
            <div class="publisher-edit-field"><label>עיסוק</label><input id="pe_occupation" value="${escapeHtml(profile.occupation || '')}"></div>
            <div class="publisher-edit-field"><label>בן/בת זוג</label><input id="pe_partner" value="${escapeHtml(profile.partner || '')}"></div>
            <div class="publisher-edit-field"><label>תחביבים</label><input id="pe_hobbies" value="${escapeHtml(profile.hobbies || '')}"></div>
            <div class="publisher-edit-field"><label>מנויים</label><input id="pe_subscribers" value="${escapeHtml(profile.subscribers || '')}"></div>
            <div class="publisher-edit-field"><label>הערות</label><textarea id="pe_notes">${escapeHtml(profile.notes || '')}</textarea></div>
        </div>
        <div class="publisher-actions">
            <button class="publisher-btn" id="publisherEditBtn" onclick="togglePublisherEdit()">✏️ עריכה</button>
            <button class="publisher-btn primary" id="publisherSaveBtn" onclick="savePublisherProfile()" style="display:none;">💾 שמור</button>
            <button class="publisher-btn" onclick="closePublisherProfile()">סגור</button>
        </div>
    `;

    document.getElementById('publisherOverlay').classList.add('visible');
}

function togglePublisherEdit() {
    const form = document.getElementById('publisherEditForm');
    const grid = document.getElementById('publisherInfoGrid');
    const editBtn = document.getElementById('publisherEditBtn');
    const saveBtn = document.getElementById('publisherSaveBtn');
    const isEditing = form.style.display !== 'none';
    form.style.display = isEditing ? 'none' : 'block';
    grid.style.display = isEditing ? 'grid' : 'none';
    editBtn.textContent = isEditing ? '✏️ עריכה' : '❌ ביטול';
    saveBtn.style.display = isEditing ? 'none' : 'inline-block';
}

async function savePublisherProfile() {
    if (!currentPublisherId) return;
    const profileData = {
        name: document.getElementById('pe_name').value.trim(),
        photo: document.getElementById('pe_photo').value.trim(),
        location: document.getElementById('pe_location').value.trim(),
        age: document.getElementById('pe_age').value.trim(),
        occupation: document.getElementById('pe_occupation').value.trim(),
        partner: document.getElementById('pe_partner').value.trim(),
        hobbies: document.getElementById('pe_hobbies').value.trim(),
        subscribers: document.getElementById('pe_subscribers').value.trim(),
        notes: document.getElementById('pe_notes').value.trim(),
        lastUpdated: Date.now()
    };
    publisherProfiles[currentPublisherId] = profileData;
    try {
        await fetch(`${FIREBASE_URL}/publisher-profiles/${currentPublisherId}.json`, {
            method: 'PUT',
            body: JSON.stringify(profileData)
        });
    } catch (e) { console.error('Error saving publisher profile:', e); }
    // Refresh the card
    openPublisherProfile(currentPublisherId);
}

function handlePhotoUpload(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 500000) { alert('תמונה גדולה מדי (מקסימום 500KB)'); return; }
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('pe_photo').value = e.target.result;
    };
    reader.readAsDataURL(file);
}

function closePublisherProfile() {
    document.getElementById('publisherOverlay').classList.remove('visible');
    currentPublisherId = null;
}

// ═══════ KEYWORDS OVERLAY ═══════
let systemKeywords = null;

async function loadSystemKeywords() {
    try {
        const res = await fetch(`${FIREBASE_URL}/system-keywords.json`);
        const data = await res.json();
        if (data && !data.error) systemKeywords = data;
    } catch (e) {
        console.error('Error loading system keywords:', e);
    }
}

function toggleKeywords() {
    const overlay = document.getElementById('keywordsOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible') && !systemKeywords) {
        loadSystemKeywords().then(() => renderKeywords());
    } else if (overlay.classList.contains('visible')) {
        renderKeywords();
    }
}

function renderKeywords() {
    const body = document.getElementById('keywordsBody');
    const statsBar = document.getElementById('keywordsStats');
    if (!systemKeywords) {
        body.innerHTML = '<div class="empty-state">לא נמצאו מילות מפתח<br><small style="color:var(--text-dim);">המידע מסונכרן מהשרת</small></div>';
        statsBar.innerHTML = '';
        return;
    }

    // Count totals
    let eventCount = 0, peopleCount = 0, violenceCount = 0, noiseCount = 0, locationCount = 0, persianCount = 0;
    if (systemKeywords.eventKeywords) systemKeywords.eventKeywords.forEach(cat => eventCount += (cat.keywords || []).length);
    peopleCount = (systemKeywords.peopleKeywords || []).length;
    violenceCount = (systemKeywords.violenceKeywords || []).length;
    noiseCount = (systemKeywords.ignoreKeywords || []).length + (systemKeywords.globalNoiseKeywords || []).length + (systemKeywords.ignorePhrases || []).length;
    locationCount = (systemKeywords.locationFilterKeywords || []).length;
    persianCount = (systemKeywords.persianKeywords || []).length;

    statsBar.innerHTML = `
        <span class="keywords-stat"><strong style="color:var(--red);">${eventCount}</strong> אירועים</span>
        <span class="keywords-stat"><strong style="color:var(--orange);">${peopleCount}</strong> אנשים</span>
        <span class="keywords-stat"><strong style="color:var(--yellow);">${violenceCount}</strong> אלימות</span>
        <span class="keywords-stat"><strong style="color:#888;">${noiseCount}</strong> מסננים</span>
        <span class="keywords-stat"><strong style="color:var(--blue);">${locationCount}</strong> מיקומים</span>
        <span class="keywords-stat"><strong style="color:#c084fc;">${persianCount}</strong> פרסית</span>
    `;

    let html = '';

    // Event keywords
    if (systemKeywords.eventKeywords) {
        html += '<div style="font-family:var(--font-he);font-size:15px;font-weight:700;color:var(--red);margin-bottom:10px;">קטגוריות אירועים</div>';
        systemKeywords.eventKeywords.forEach(cat => {
            const urgColors = { 1:'#666', 2:'var(--blue)', 3:'var(--yellow)', 4:'var(--orange)', 5:'var(--red)' };
            const urgColor = urgColors[cat.urgencyBoost] || '#666';
            html += `<div class="keyword-category">
                <div class="keyword-category-header">
                    <span class="keyword-category-name">${escapeHtml(cat.nameHe || cat.id)}</span>
                    <span>
                        <span class="keyword-urgency-badge" style="background:${urgColor}22;color:${urgColor};border:1px solid ${urgColor};">+${cat.urgencyBoost}</span>
                        <span class="keyword-category-count">${(cat.keywords || []).length}</span>
                    </span>
                </div>
                <div class="keyword-tags">${(cat.keywords || []).map(kw => `<span class="keyword-tag" style="border-color:${urgColor}44;">${escapeHtml(kw)}</span>`).join('')}</div>
            </div>`;
        });
    }

    // People keywords
    if (systemKeywords.peopleKeywords && systemKeywords.peopleKeywords.length) {
        html += `<div class="keyword-category">
            <div class="keyword-category-header">
                <span class="keyword-category-name" style="color:var(--orange);">מילות אנשים</span>
                <span class="keyword-category-count">${systemKeywords.peopleKeywords.length}</span>
            </div>
            <div class="keyword-tags">${systemKeywords.peopleKeywords.map(kw => `<span class="keyword-tag" style="border-color:var(--orange)44;">${escapeHtml(kw)}</span>`).join('')}</div>
        </div>`;
    }

    // Violence keywords
    if (systemKeywords.violenceKeywords && systemKeywords.violenceKeywords.length) {
        html += `<div class="keyword-category">
            <div class="keyword-category-header">
                <span class="keyword-category-name" style="color:var(--yellow);">מילות אלימות</span>
                <span class="keyword-category-count">${systemKeywords.violenceKeywords.length}</span>
            </div>
            <div class="keyword-tags">${systemKeywords.violenceKeywords.map(kw => `<span class="keyword-tag" style="border-color:var(--yellow)44;">${escapeHtml(kw)}</span>`).join('')}</div>
        </div>`;
    }

    // Ignore / noise keywords
    const noiseTypes = [
        { key: 'ignoreKeywords', label: 'מילות סינון', color: '#888' },
        { key: 'globalNoiseKeywords', label: 'רעש גלובלי', color: '#888' },
        { key: 'ignorePhrases', label: 'ביטויי סינון', color: '#888' }
    ];
    noiseTypes.forEach(nt => {
        const arr = systemKeywords[nt.key];
        if (arr && arr.length) {
            html += `<div class="keyword-category">
                <div class="keyword-category-header">
                    <span class="keyword-category-name" style="color:${nt.color};">${nt.label}</span>
                    <span class="keyword-category-count">${arr.length}</span>
                </div>
                <div class="keyword-tags">${arr.map(kw => `<span class="keyword-tag" style="border-color:#88888844;">${escapeHtml(kw)}</span>`).join('')}</div>
            </div>`;
        }
    });

    // Location filter keywords
    if (systemKeywords.locationFilterKeywords && systemKeywords.locationFilterKeywords.length) {
        html += `<div class="keyword-category">
            <div class="keyword-category-header">
                <span class="keyword-category-name" style="color:var(--blue);">מסנני מיקום</span>
                <span class="keyword-category-count">${systemKeywords.locationFilterKeywords.length}</span>
            </div>
            <div class="keyword-tags">${systemKeywords.locationFilterKeywords.map(kw => `<span class="keyword-tag" style="border-color:var(--blue)44;">${escapeHtml(kw)}</span>`).join('')}</div>
        </div>`;
    }

    // Persian keywords
    if (systemKeywords.persianKeywords && systemKeywords.persianKeywords.length) {
        html += `<div class="keyword-category">
            <div class="keyword-category-header">
                <span class="keyword-category-name" style="color:#c084fc;">מילות פרסית (סינון)</span>
                <span class="keyword-category-count">${systemKeywords.persianKeywords.length}</span>
            </div>
            <div class="keyword-tags">${systemKeywords.persianKeywords.map(kw => `<span class="keyword-tag" style="border-color:#c084fc44;">${escapeHtml(kw)}</span>`).join('')}</div>
        </div>`;
    }

    body.innerHTML = html;
}

// ═══════ KEYBOARD SHORTCUTS ═══════
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (mapIsFullscreen) toggleMapFullscreen();
        const history = document.getElementById('historyOverlay');
        if (history.classList.contains('visible')) toggleHistory();
        const keywords = document.getElementById('keywordsOverlay');
        if (keywords.classList.contains('visible')) toggleKeywords();
        const publisher = document.getElementById('publisherOverlay');
        if (publisher.classList.contains('visible')) closePublisherProfile();
    }
    if (e.key === 'f' || e.key === 'F') {
        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') toggleMapFullscreen();
    }
    if (e.key === 'h' || e.key === 'H') {
        if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') toggleHistory();
    }
});

// ═══════ REFRESH CYCLE ═══════
function startRefreshCycle() {
    const bar = document.getElementById('refreshBar');
    const nextEl = document.getElementById('nextRefresh');
    let elapsed = 0;

    setInterval(() => {
        elapsed += 1000;
        const remaining = Math.max(0, Math.ceil((REFRESH_INTERVAL - elapsed) / 1000));
        nextEl.textContent = `${remaining}s`;
        bar.style.width = `${(elapsed / REFRESH_INTERVAL) * 100}%`;

        if (elapsed >= REFRESH_INTERVAL) {
            elapsed = 0;
            bar.style.width = '0%';
            fetchData();
        }
    }, 1000);
}

// ═══════ LOGIN (handled by inline script above) ═══════

// ═══════ DEMO DATA ═══════
let isDemoMode = false;
let demoTimer = null;
let demoCountdown = 0;
let realNewsData = {};
let realAllNewsData = {};
let realSummaryData = null;
let realMetaData = null;

function loadDemoData() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');

    // Toggle off
    if (isDemoMode) {
        exitDemoMode();
        return;
    }

    // Save real data before overwriting
    realNewsData = { ...newsData };
    realAllNewsData = { ...allNewsData };
    realSummaryData = summaryData;
    realMetaData = metaData;
    isDemoMode = true;

    const now = Date.now();
    const hour = 3600000;

    const demoItems = [
        {
            title: 'ירי נ"ט לעבר כוח צה"ל במזרח חאן יונס',
            snippet: 'דווח על ירי נ"ט לעבר כוח צבאי שפעל מזרחית לחאן יונס. אין נפגעים.',
            fullText: 'דווח על ירי נגד טנקים לעבר כוח שריון שפעל מזרחית לחאן יונס באזור בני סוהילה. הכוח החזיר אש. אין נפגעים מצד כוחותינו. כוחות נוספים הוזנקו.',
            source: 'gazaalannet',
            urgency: 5,
            urgencyLabel: 'ודאי',
            timestamp: now - (0.5 * hour),
            coordinates: { lat: 31.344, lon: 34.320 },
            matchedLocations: ['Bani Suheila'],
            matchedKeywords: ['ירי', 'נ"ט', 'שריון']
        },
        {
            title: 'מטען חבלה בציר סלאח א-דין',
            snippet: 'אותר מטען חבלה בציר סלאח א-דין באזור אל-קררה',
            fullText: 'כוח הנדסה איתר וטיפל במטען חבלה שהונח בציר סלאח א-דין באזור אל-קררה. הציר נחסם זמנית לתנועה.',
            source: 'GazaNewsNow',
            urgency: 5,
            urgencyLabel: 'ודאי',
            timestamp: now - (1.2 * hour),
            coordinates: { lat: 31.370, lon: 34.340 },
            matchedLocations: ['Al Qarara', 'Salah ad-Din Road'],
            matchedKeywords: ['מטען', 'חבלה']
        },
        {
            title: 'תנועת חמושים בח\'וזאעה',
            snippet: 'נצפתה תנועה של מחבלים חמושים באזור ח\'וזאעה',
            fullText: 'מקורות מקומיים דיווחו על תנועת חמושים של הזרוע הצבאית של חמאס באזור ח\'וזאעה. נצפו כלי רכב חשודים.',
            source: 'QudsN',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (2.5 * hour),
            coordinates: { lat: 31.364, lon: 34.335 },
            matchedLocations: ['Khuza\'a'],
            matchedKeywords: ['חמושים', 'חמאס']
        },
        {
            title: 'הפצצה אווירית מערבית לחאן יונס',
            snippet: 'דווח על תקיפה אווירית באזור אל-מוואסי מערבית לחאן יונס',
            fullText: 'דווחים על תקיפה אווירית של חיל האוויר באזור אל-מוואסי מערבית לחאן יונס. דיווחים סותרים על נפגעים.',
            source: 'gazala7zapal1',
            urgency: 5,
            urgencyLabel: 'ודאי',
            timestamp: now - (3.8 * hour),
            coordinates: { lat: 31.340, lon: 34.270 },
            matchedLocations: ['Al Mawasi'],
            matchedKeywords: ['תקיפה', 'הפצצה']
        },
        {
            title: 'סריקה צבאית באבסאן אל-כבירה',
            snippet: 'כוח צבאי ביצע סריקה באבסאן אל-כבירה בעקבות מידע מודיעיני',
            fullText: 'כוח צבאי נכנס לאבסאן אל-כבירה לביצוע סריקה בעקבות מידע מודיעיני על מחסן נשק. הסריקה בעיצומה.',
            source: 'akh_bar_gaza',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (5 * hour),
            coordinates: { lat: 31.355, lon: 34.340 },
            matchedLocations: ['Abasan al-Kabira'],
            matchedKeywords: ['סריקה', 'מחסן נשק']
        },
        {
            title: 'שיגור רקטות מאזור אל-פוח\'ארי',
            snippet: 'זוהה שיגור רקטות מאזור אל-פוח\'ארי לעבר עוטף עזה',
            fullText: 'מערכת ההתרעה זיהתה שיגור רקטות מאזור אל-פוח\'ארי דרומית-מזרחית לחאן יונס. יירוט מוצלח דווח.',
            source: 'SamaNewsAgency',
            urgency: 5,
            urgencyLabel: 'ודאי',
            timestamp: now - (6.5 * hour),
            coordinates: { lat: 31.320, lon: 34.340 },
            matchedLocations: ['Al Fukhari'],
            matchedKeywords: ['רקטות', 'שיגור']
        },
        {
            title: 'דיווח על רחפן מעל ניר עוז',
            snippet: 'תושבים דיווחו על רחפן חשוד שנצפה מעל קיבוץ ניר עוז',
            fullText: 'תושבי קיבוץ ניר עוז דיווחו על רחפן חשוד שנצפה מעל הקיבוץ בשעות הבוקר. מערכות ההגנה הופעלו.',
            source: 'google-news',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (8 * hour),
            coordinates: { lat: 31.330, lon: 34.395 },
            matchedLocations: ['Nir Oz'],
            matchedKeywords: ['רחפן']
        },
        {
            title: 'פעילות הברחה בציר פילדלפי',
            snippet: 'נצפתה פעילות חשודה בציר פילדלפי - חשד להברחת אמצעי לחימה',
            fullText: 'כוחות שפעלו בציר פילדלפי זיהו פעילות חשודה של הברחה. כוחות נוספים הוזנקו לאזור לסריקה.',
            source: 'palinfo',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (10 * hour),
            coordinates: { lat: 31.250, lon: 34.270 },
            matchedLocations: ['Philadelphi Corridor'],
            matchedKeywords: ['הברחה', 'פילדלפי']
        },
        {
            title: 'פעילות הומניטרית במעבר כרם אבו סאלם',
            snippet: 'משאיות סיוע הומניטרי נכנסו דרך מעבר כרם אבו סאלם',
            fullText: 'עשרות משאיות סיוע הומניטרי נכנסו לרצועה דרך מעבר כרם אבו סאלם. דווח על עומס ותורים באזור.',
            source: 'google-news',
            urgency: 2,
            urgencyLabel: 'חלש',
            timestamp: now - (14 * hour),
            coordinates: { lat: 31.225, lon: 34.290 },
            matchedLocations: ['Kerem Abu Salem'],
            matchedKeywords: ['סיוע', 'מעבר']
        },
        {
            title: 'תנועת אזרחים בציר נצרים',
            snippet: 'נצפתה תנועת אזרחים לאורך ציר נצרים לכיוון צפון',
            fullText: 'נצפתה תנועת אזרחים מרובה לאורך ציר נצרים בכיוון צפון. מעקב אחר התנועה להבחנה בין אזרחים לחמושים.',
            source: 'mtqdmon',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (18 * hour),
            coordinates: { lat: 31.430, lon: 34.380 },
            matchedLocations: ['Netzarim Corridor'],
            matchedKeywords: ['תנועה', 'נצרים']
        },
    ];

    // Load demo data
    const demoNews = {};
    demoItems.forEach((item, i) => {
        demoNews['demo-' + i] = item;
    });

    newsData = demoNews;
    allNewsData = { ...allNewsData, ...demoNews };

    // Load default profiles for demo
    if (Object.keys(publisherProfiles).length === 0) {
        publisherProfiles = JSON.parse(JSON.stringify(DEFAULT_PROFILES));
    }

    // Demo summary
    summaryData = {
        summary: 'בשעות האחרונות נרשמה פעילות משמעותית בגזרת חאן יונס. אירועים עיקריים: ירי נ"ט לעבר כוח שריון באזור בני סוהילה, מטען חבלה בציר סלאח א-דין, ושיגור רקטות מאל-פוח\'ארי.\n\nפעילות מודיעינית: תנועת חמושים בח\'וזאעה, סריקה באבסאן אל-כבירה.\n\nהמלצות:\n• הגברת כוננות באזור בני סוהילה-ח\'וזאעה\n• סריקות מוגברות בציר סלאח א-דין\n• מעקב אחר פעילות הברחה בציר פילדלפי',
        aiProvider: 'Gemini',
        generatedAt: now - (15 * 60000)
    };

    // Demo metadata
    metaData = { lastRun: now - (3 * 60000) };

    renderAll();

    // Load demo WhatsApp data
    renderWhatsAppDemo();

    // Start telegram feed simulation in demo mode
    simulateTelegramFeed();

    // Start 60s countdown
    demoCountdown = 60;
    updateDemoButton();
    demoTimer = setInterval(() => {
        demoCountdown--;
        updateDemoButton();
        if (demoCountdown <= 0) {
            exitDemoMode();
        }
    }, 1000);
}

function updateDemoButton() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');
    if (!btn) return;
    btn.style.color = 'var(--green)';
    btn.style.borderColor = 'var(--green)';
    btn.innerHTML = `<span class="btn-icon">&#10003;</span><span>הדגמה פעילה ${demoCountdown}s</span>`;
}

function exitDemoMode() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');
    isDemoMode = false;
    if (demoTimer) { clearInterval(demoTimer); demoTimer = null; }
    if (tgFeedTimer) { clearInterval(tgFeedTimer); tgFeedTimer = null; }
    newsData = realNewsData;
    allNewsData = realAllNewsData;
    summaryData = realSummaryData;
    metaData = realMetaData;
    renderAll();
    // Restore WhatsApp to real data (re-fetch from Firebase)
    fetchWhatsAppData();
    // Clear OSINT search results
    const targetResults = document.getElementById('targetResults');
    if (targetResults) {
        targetResults.innerHTML = '<div style="padding:30px 15px;text-align:center;color:var(--text-dim);font-family:var(--font-he);font-size:11px;">הכנס שם משתמש, מספר טלפון או אימייל לסריקה</div>';
    }
    if (btn) {
        btn.style.color = 'var(--yellow)';
        btn.style.borderColor = 'var(--yellow-dim)';
        btn.innerHTML = '<span class="btn-icon">&#9881;</span><span>הדגמה</span>';
    }
}

// ═══════ TELEGRAM FEED SIMULATION ═══════
const mockTelegramChannels = [
    { name: 'غزة الآن', messages: [
        { text: 'ירי נ"ט לעבר כוח צה"ל מזרחית לחאן יונס', location: 'חאן יונס', urgency: 5 },
        { text: 'שיירה צבאית בציר סלאח א-דין לכיוון דרום', location: 'אל-קררה', urgency: 3 },
        { text: 'הפצצה אווירית באזור אל-מוואסי', location: 'אל-מוואסי', urgency: 5 },
        { text: 'שקט יחסי במרכז חאן יונס', location: 'חאן יונס', urgency: 1 },
    ]},
    { name: 'أخبار غزة الحدث', messages: [
        { text: 'סריקה צבאית באבסאן אל-כבירה, מעצרים', location: 'אבסאן אל-כבירה', urgency: 5 },
        { text: 'תנועת חמושים נצפתה בח\'וזאעה', location: 'ח\'וזאעה', urgency: 4 },
        { text: 'פיצוץ חשוד נשמע באזור בני סוהילה', location: 'בני סוהילה', urgency: 4 },
        { text: 'חלוקת סיוע הומניטרי במרכז העיר', location: 'חאן יונס', urgency: 1 },
    ]},
    { name: 'القدس - أخبار', messages: [
        { text: 'שיגור רקטות מדרום הרצועה לעבר עוטף עזה', location: 'אל-פוח\'ארי', urgency: 5 },
        { text: 'פעילות הברחה נצפתה בציר פילדלפי', location: 'ציר פילדלפי', urgency: 4 },
        { text: 'מטען צד אותר בציר סלאח א-דין', location: 'אל-קררה', urgency: 5 },
        { text: 'תנועת אזרחים שגרתית באזור', location: null, urgency: 1 },
    ]},
    { name: 'سما نيوز', messages: [
        { text: 'רחפן חשוד נצפה מעל ניר עוז', location: 'ניר עוז', urgency: 3 },
        { text: 'כוחות צבאיים פורשים באזור מעאן', location: 'מעאן', urgency: 4 },
        { text: 'פעילות בציר נצרים, חסימת תנועה', location: 'ציר נצרים', urgency: 3 },
        { text: 'שגרה באזור כרם אבו סאלם', location: 'כרם אבו סאלם', urgency: 1 },
    ]},
    { name: 'فلسطين المقاومة', messages: [
        { text: 'כוח מסתערבים נכנס למזרח חאן יונס', location: 'בני סוהילה', urgency: 5 },
        { text: 'ירי צלפים באזור אבסאן א-סע\'ירה', location: 'אבסאן א-סע\'ירה', urgency: 4 },
        { text: 'תנועת כלי רכב צבאיים לאורך הגדר', location: 'כיסופים', urgency: 3 },
        { text: 'בנייה מחודשת של מנהרה שנחשפה', location: null, urgency: 4 },
    ]},
    { name: 'הדופק של הרחוב העזתי', messages: [
        { text: 'תושבים מדווחים על ירי כבד מכיוון מזרח', location: 'ח\'אן יונס', urgency: 4 },
        { text: 'נפילות בשכונת אמל - נזק למבנים', location: 'ח\'אן יונס', urgency: 5 },
        { text: 'שוק אל-קייסריה נפתח מחדש לאחר הפסקה', location: 'ח\'אן יונס', urgency: 1 },
    ]},
    { name: 'הד אלבלד', messages: [
        { text: 'גלי הדף מפיצוצים הורגשו ברחבי העיר', location: 'ח\'אן יונס', urgency: 4 },
        { text: 'פינוי פצועים ממזרח אל-קררה', location: 'אל-קררה', urgency: 5 },
        { text: 'חזרה של תנועת אזרחים ברחובות המרכזיים', location: 'ח\'אן יונס', urgency: 1 },
    ]},
    { name: 'חדשות אלקרארה', messages: [
        { text: 'כניסת כלים הנדסיים לצפון אל-קררה', location: 'אל-קררה', urgency: 4 },
        { text: 'תושבים נמלטים דרומה מאל-קררה', location: 'אל-קררה', urgency: 3 },
        { text: 'שקט יחסי באזור מאז הבוקר', location: 'אל-קררה', urgency: 1 },
    ]},
    { name: 'דיווי חדשות הסיוע - עזה', messages: [
        { text: 'שיירת סיוע של UNRWA נכנסה דרך כרם שלום', location: 'כרם אבו סאלם', urgency: 2 },
        { text: 'חלוקת מזון במחנה הפליטים אל-אמל', location: 'ח\'אן יונס', urgency: 1 },
        { text: 'עיכוב בכניסת ציוד רפואי - מחסום צבאי', location: 'ציר פילדלפי', urgency: 3 },
    ]},
];

const TG_KEYWORDS = ['שיירה', 'ירי', 'רקטות', 'שיגור', 'מטען', 'חמושים', 'רחפן', 'הפצצה', 'סריקה', 'מנהרה', 'הברחה', 'צלפים', 'נ"ט'];

let tgFeedTimer = null;

function findLocationCoords(locationName) {
    if (!locationName) return null;
    const allLocs = [...KEY_VILLAGES, ...P1_LOCATIONS, ...P2_LOCATIONS, ...ISRAELI_LOCATIONS];
    const match = allLocs.find(l => l.he === locationName || l.name === locationName);
    return match ? { lat: match.lat, lng: match.lng } : null;
}

function pulseMapMarker(lat, lng) {
    if (!map) return;
    const pulse = L.circleMarker([lat, lng], {
        radius: 25, color: '#ffd000', fillColor: '#ffd000',
        fillOpacity: 0.4, weight: 3, className: 'tg-pulse-marker'
    }).addTo(map);
    let r = 25;
    const anim = setInterval(() => {
        r += 2;
        pulse.setRadius(r);
        pulse.setStyle({ fillOpacity: Math.max(0, 0.4 - (r - 25) * 0.02), opacity: Math.max(0, 1 - (r - 25) * 0.03) });
        if (r > 50) { clearInterval(anim); map.removeLayer(pulse); }
    }, 50);
}

function flashSidebar() {
    const leftPanel = document.querySelector('.left-panel');
    if (!leftPanel) return;
    leftPanel.style.transition = 'box-shadow 0.3s ease';
    leftPanel.style.boxShadow = '0 0 20px rgba(255,208,0,0.4), inset 0 0 10px rgba(255,208,0,0.1)';
    setTimeout(() => { leftPanel.style.boxShadow = ''; }, 1500);
}

function addTelegramLog(msg, channelName) {
    const hasKeyword = TG_KEYWORDS.some(kw => msg.text.includes(kw));
    const coords = findLocationCoords(msg.location);
    const id = 'tg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);

    const report = {
        title: msg.text,
        fullText: msg.text,
        snippet: msg.text,
        source: channelName,
        sourceUrl: '',
        urgencyScore: msg.urgency,
        urgency: msg.urgency,
        locationHe: msg.location || '',
        coordinates: coords,
        publishedAt: Date.now(),
        fetchedAt: Date.now(),
        timestamp: Date.now(),
        isAnarchist: msg.text.includes('אנרכיסט') || msg.text.includes('ISM') || msg.text.includes('בצלם'),
        isTelegram: true,
        keywordHit: hasKeyword,
    };

    newsData[id] = report;
    allNewsData[id] = report;
    renderAll();

    if (hasKeyword) flashSidebar();
    if (coords) pulseMapMarker(coords.lat, coords.lng);
}

function simulateTelegramFeed() {
    if (tgFeedTimer) { clearInterval(tgFeedTimer); tgFeedTimer = null; return; }
    tgFeedTimer = setInterval(() => {
        const ch = mockTelegramChannels[Math.floor(Math.random() * mockTelegramChannels.length)];
        const msg = ch.messages[Math.floor(Math.random() * ch.messages.length)];
        addTelegramLog(msg, ch.name);
    }, 5000 + Math.random() * 5000);
}

function toggleTgFeed() {
    const btn = document.getElementById('tgFeedBtn');
    // Allow turning off if already running
    if (tgFeedTimer) {
        clearInterval(tgFeedTimer); tgFeedTimer = null;
        btn.style.color = 'var(--cyan)'; btn.style.borderColor = 'var(--cyan)';
        btn.innerHTML = '<span class="btn-icon">&#9889;</span><span>פיד טלגרם</span>';
    } else if (isDemoMode) {
        simulateTelegramFeed();
        btn.style.color = 'var(--green)'; btn.style.borderColor = 'var(--green)';
        btn.innerHTML = '<span class="btn-icon">&#9889;</span><span>פיד פעיל...</span>';
    } else {
        // Not in demo mode — show message
        btn.style.color = 'var(--text-dim)'; btn.style.borderColor = 'var(--text-dim)';
        btn.innerHTML = '<span class="btn-icon">&#9889;</span><span>הדגמה בלבד</span>';
        setTimeout(() => {
            btn.style.color = 'var(--cyan)'; btn.style.borderColor = 'var(--cyan)';
            btn.innerHTML = '<span class="btn-icon">&#9889;</span><span>פיד טלגרם</span>';
        }, 2000);
    }
}

// ═══════ SECTOR HISTORY ═══════
const SECTOR_ZONES = [
    { id: 'center', name: 'מרכז חאן יונס', color: '#ff0040',
      locations: ['חאן יונס','חמד (חאן יונס)','תל אל-הווא'] },
    { id: 'east', name: 'מזרח (בני סוהילה-עבסאן)', color: '#ff8800',
      locations: ['בני סוהילה','עבסאן אל-כביר','עבסאן א-סגירה','חוזעה',"ח'וזאעה",'חוזאעה'] },
    { id: 'northeast', name: 'צפון-מזרח (אל-קררה)', color: '#ffd000',
      locations: ['אל-קררה','קררה',"ג'וחר א-דיכ"] },
    { id: 'south', name: 'דרום', color: '#a855f7',
      locations: ['מען',"אל-פוח'ארי",'פוח\'ארי','רפיח','רפיח צפון'] },
    { id: 'west', name: 'מערב / חוף', color: '#4488ff',
      locations: ['אל-מוואסי','מוואסי'] },
    { id: 'corridors', name: 'צירים ומעברים', color: '#00ff88',
      locations: ['ציר נצרים','ציר פילדלפי','כביש סלאח א-דין','מעבר כרם אבו סאלם','כרם שלום','כרם אבו סאלם'] },
    { id: 'north', name: 'צפון הרצועה', color: '#00d4ff',
      locations: ['עיר עזה','עזה','בית חאנון','בית לאהיא',"ג'באליה",'שג\'אעיה','זייתון'] },
    { id: 'middle', name: 'מרכז הרצועה', color: '#ff44aa',
      locations: ['דיר אל-בלח','א-נוצייראת','נוסייראת',"אל-בורייג'",'בורייג\'','מע\'אזי','א-זוואידה'] },
];

let shAllHistory = {};
let shSelectedMonth = null;

function toggleSectorHistory() {
    const overlay = document.getElementById('sectorHistoryOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        document.body.style.overflow = 'hidden';
        loadSectorHistory();
    } else {
        document.body.style.overflow = '';
    }
}

async function loadSectorHistory() {
    try {
        const res = await fetch(`${FIREBASE_URL}/auto-news.json`);
        const data = await res.json();
        if (data && !data.error) {
            // Normalize
            Object.values(data).forEach(item => {
                if (!item.urgency && item.urgencyScore) item.urgency = item.urgencyScore;
                if (!item.timestamp) {
                    if (item.publishedAt) item.timestamp = typeof item.publishedAt === 'number' ? item.publishedAt : new Date(item.publishedAt).getTime();
                    else if (item.date) item.timestamp = new Date(item.date).getTime();
                    else if (item.fetchedAt) item.timestamp = typeof item.fetchedAt === 'number' ? item.fetchedAt : new Date(item.fetchedAt).getTime();
                }
                if (item.timestamp && item.timestamp < 1000000000000) item.timestamp = item.timestamp * 1000;
                if (!item.locationHe && item.matchedLocations) item.locationHe = item.matchedLocations.join(', ');
            });
            shAllHistory = data;
            renderShLocations();
            renderShZones();
            renderShTimeline();
        }
    } catch (e) {
        console.error('Sector history load error:', e);
    }
}

function getItemLocation(item) {
    if (item.locationHe) return item.locationHe.split(',')[0].trim();
    if (item.matchedLocations && item.matchedLocations.length) return item.matchedLocations[0];
    // Try to detect from text
    const text = [item.title, item.snippet, item.fullText].filter(Boolean).join(' ');
    const allLocs = [...IN_SECTOR, ...KEY_VILLAGES.map(v => v.he)];
    for (const loc of allLocs) {
        if (text.includes(loc)) return loc;
    }
    return null;
}

function switchShTab(tab, btn) {
    document.querySelectorAll('.sh-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('shTabLocations').style.display = tab === 'locations' ? '' : 'none';
    document.getElementById('shTabZones').style.display = tab === 'zones' ? '' : 'none';
    document.getElementById('shTabTimeline').style.display = tab === 'timeline' ? '' : 'none';
}

// ── TAB 1: LOCATIONS ──
function renderShLocations() {
    const items = Object.values(shAllHistory);
    const locMap = {};

    items.forEach(item => {
        const loc = getItemLocation(item);
        if (!loc) return;
        if (!locMap[loc]) locMap[loc] = { count: 0, urgencies: [], lastEvent: null, lastTimestamp: 0 };
        locMap[loc].count++;
        locMap[loc].urgencies.push(item.urgency || 2);
        if ((item.timestamp || 0) > locMap[loc].lastTimestamp) {
            locMap[loc].lastTimestamp = item.timestamp || 0;
            locMap[loc].lastEvent = item;
        }
    });

    const sorted = Object.entries(locMap).sort((a, b) => b[1].count - a[1].count);
    const maxCount = sorted.length > 0 ? sorted[0][1].count : 1;
    const totalEvents = sorted.reduce((s, [, d]) => s + d.count, 0);

    // Summary bar
    const summaryEl = document.getElementById('shLocationSummary');
    summaryEl.innerHTML = `
        <div class="sh-summary-stat"><strong>${totalEvents}</strong> אירועים</div>
        <div class="sh-summary-stat"><strong>${sorted.length}</strong> מיקומים</div>
        <div class="sh-summary-stat"><strong>${sorted.length > 0 ? sorted[0][0] : '-'}</strong> הכי פעיל</div>
    `;

    // Grid
    const grid = document.getElementById('shLocationsGrid');
    const urgColors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#6880a0' };

    grid.innerHTML = sorted.map(([loc, data]) => {
        const avgUrg = data.urgencies.reduce((s, u) => s + u, 0) / data.urgencies.length;
        const barColor = avgUrg >= 4.5 ? '#ff0040' : avgUrg >= 3.5 ? '#ff8800' : avgUrg >= 2.5 ? '#ffd000' : '#4488ff';
        const barWidth = Math.max(5, (data.count / maxCount) * 100);
        const countColor = avgUrg >= 4.5 ? '#ff0040' : avgUrg >= 3.5 ? '#ff8800' : avgUrg >= 2.5 ? '#ffd000' : '#4488ff';
        const lastDate = data.lastTimestamp ? new Date(data.lastTimestamp).toLocaleDateString('he-IL') : '';

        // Urgency distribution dots
        const urgCounts = {};
        data.urgencies.forEach(u => { urgCounts[u] = (urgCounts[u] || 0) + 1; });

        const urgDots = Object.entries(urgCounts)
            .sort((a, b) => b[0] - a[0])
            .map(([u, c]) => `<span style="display:flex;align-items:center;gap:2px;"><span class="sh-loc-urgency-dot" style="background:${urgColors[u] || '#888'};"></span><span style="font-size:9px;color:var(--text-dim);">${c}</span></span>`)
            .join('');

        const lastTitle = data.lastEvent ? escapeHtml((data.lastEvent.title || '').substring(0, 80)) : '';

        return `<div class="sh-loc-card">
            <div class="sh-loc-card-header">
                <span class="sh-loc-name">${escapeHtml(loc)}</span>
                <span class="sh-loc-count" style="color:${countColor};background:${countColor}22;">${data.count}</span>
            </div>
            <div class="sh-loc-bar"><div class="sh-loc-bar-fill" style="width:${barWidth}%;background:${barColor};"></div></div>
            <div class="sh-loc-meta">
                <span>אחרון: ${lastDate}</span>
                <div class="sh-loc-urgency-dots">${urgDots}</div>
            </div>
            ${lastTitle ? `<div class="sh-loc-last-event">${lastTitle}</div>` : ''}
        </div>`;
    }).join('');
}

// ── TAB 2: ZONES ──
function renderShZones() {
    const items = Object.values(shAllHistory);
    const zoneData = SECTOR_ZONES.map(zone => {
        const zoneItems = items.filter(item => {
            const loc = getItemLocation(item);
            return loc && zone.locations.some(zl => loc.includes(zl));
        });
        const urgCounts = { 5: 0, 4: 0, 3: 0, 2: 0 };
        const locCounts = {};
        zoneItems.forEach(item => {
            const u = item.urgency || 2;
            urgCounts[Math.min(5, Math.max(2, u))] = (urgCounts[Math.min(5, Math.max(2, u))] || 0) + 1;
            const loc = getItemLocation(item);
            if (loc) locCounts[loc] = (locCounts[loc] || 0) + 1;
        });
        return { ...zone, total: zoneItems.length, urgCounts, locCounts };
    });

    zoneData.sort((a, b) => b.total - a.total);
    const maxTotal = zoneData.length > 0 ? Math.max(1, zoneData[0].total) : 1;

    const container = document.getElementById('shZonesContainer');
    container.innerHTML = zoneData.map(zone => {
        if (zone.total === 0) return '';
        const totalUrg = zone.urgCounts[5] + zone.urgCounts[4] + zone.urgCounts[3] + zone.urgCounts[2];
        const barSegs = [
            { u: 5, c: zone.urgCounts[5], color: '#ff0040', label: 'ודאי' },
            { u: 4, c: zone.urgCounts[4], color: '#ff8800', label: 'חזק' },
            { u: 3, c: zone.urgCounts[3], color: '#ffd000', label: 'בינוני' },
            { u: 2, c: zone.urgCounts[2], color: '#4488ff', label: 'חלש' },
        ].filter(s => s.c > 0).map(s => `<div class="sh-zone-bar-seg" style="width:${(s.c/totalUrg)*100}%;background:${s.color};" title="${s.label}: ${s.c}">${s.c}</div>`).join('');

        const locTags = Object.entries(zone.locCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 6)
            .map(([loc, c]) => `<span class="sh-zone-loc-tag">${escapeHtml(loc)} (${c})</span>`)
            .join('');

        return `<div class="sh-zone-card">
            <div class="sh-zone-header" style="border-right:4px solid ${zone.color};">
                <span class="sh-zone-name">${zone.name}</span>
                <span class="sh-zone-count" style="color:${zone.color};">${zone.total}</span>
            </div>
            <div class="sh-zone-body">
                <div class="sh-zone-bar">${barSegs}</div>
                <div class="sh-zone-locations">${locTags}</div>
            </div>
        </div>`;
    }).join('');
}

// ── TAB 3: TIMELINE (daily view) ──
function renderShTimeline() {
    const items = Object.values(shAllHistory);
    const dayMap = {};

    items.forEach(item => {
        if (!item.timestamp) return;
        const d = new Date(item.timestamp);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        if (!dayMap[key]) dayMap[key] = { total: 0, urgCounts: { 5: 0, 4: 0, 3: 0, 2: 0 }, items: [] };
        dayMap[key].total++;
        const u = Math.min(5, Math.max(2, item.urgency || 2));
        dayMap[key].urgCounts[u]++;
        dayMap[key].items.push(item);
    });

    // Ensure we show at least 7 days even if some have no data
    const now = new Date();
    for (let i = 0; i < 7; i++) {
        const d = new Date(now.getTime() - i * 86400000);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        if (!dayMap[key]) dayMap[key] = { total: 0, urgCounts: { 5: 0, 4: 0, 3: 0, 2: 0 }, items: [] };
    }

    const days = Object.keys(dayMap).sort();
    const maxDay = days.reduce((m, k) => Math.max(m, dayMap[k].total), 1);
    const heDays = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

    const chart = document.getElementById('shTimelineChart');
    chart.innerHTML = `<div class="sh-timeline-months">${days.map(key => {
        const md = dayMap[key];
        const height = md.total === 0 ? 4 : Math.max(8, (md.total / maxDay) * 180);
        const segs = md.total === 0 ? '<div class="sh-month-seg" style="height:4px;background:#1a2a40;"></div>' :
            [
                { u: 5, c: md.urgCounts[5], color: '#ff0040' },
                { u: 4, c: md.urgCounts[4], color: '#ff8800' },
                { u: 3, c: md.urgCounts[3], color: '#ffd000' },
                { u: 2, c: md.urgCounts[2], color: '#4488ff' },
            ].filter(s => s.c > 0).map(s => {
                const segH = (s.c / md.total) * height;
                return `<div class="sh-month-seg" style="height:${segH}px;background:${s.color};"></div>`;
            }).join('');
        const d = new Date(key + 'T00:00:00');
        const dayName = heDays[d.getDay()];
        const dayNum = d.getDate();
        const monthNum = d.getMonth() + 1;
        const label = `${dayNum}/${monthNum}`;
        const sublabel = dayName;
        return `<div class="sh-month-col${shSelectedMonth === key ? ' selected' : ''}" onclick="selectShMonth('${key}')">
            <span class="sh-month-count">${md.total || ''}</span>
            <div class="sh-month-bar-stack" style="height:${height}px;">${segs}</div>
            <span class="sh-month-label">${label}<br><span style="font-size:8px;opacity:0.6;">${sublabel}</span></span>
        </div>`;
    }).join('')}</div>`;

    // Show latest day with data by default
    if (!shSelectedMonth) {
        const daysWithData = days.filter(k => dayMap[k].total > 0);
        if (daysWithData.length > 0) shSelectedMonth = daysWithData[daysWithData.length - 1];
        else if (days.length > 0) shSelectedMonth = days[days.length - 1];
    }
    if (shSelectedMonth) renderShDayDetails(shSelectedMonth);
}

function selectShMonth(key) {
    shSelectedMonth = key;
    renderShTimeline();
}

function renderShDayDetails(key) {
    const dayData = shAllHistory ? Object.values(shAllHistory).filter(item => {
        if (!item.timestamp) return false;
        const d = new Date(item.timestamp);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}` === key;
    }) : [];

    dayData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    const d = new Date(key + 'T00:00:00');
    const heDays = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
    const label = `יום ${heDays[d.getDay()]} ${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    const urgColors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#6880a0' };

    const details = document.getElementById('shTimelineDetails');
    if (dayData.length === 0) {
        details.innerHTML = `
            <div class="sh-timeline-detail-header">${label} - אין אירועים</div>
            <div style="padding:20px;text-align:center;color:var(--text-dim);font-size:12px;">לא נרשמו אירועים ביום זה</div>
        `;
        return;
    }
    details.innerHTML = `
        <div class="sh-timeline-detail-header">${label} - ${dayData.length} אירועים</div>
        <div class="sh-timeline-events">
            ${dayData.slice(0, 50).map(item => {
                const dt = new Date(item.timestamp || 0);
                const time = dt.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                const loc = getItemLocation(item) || '';
                const urg = item.urgency || 2;
                return `<div class="sh-timeline-event" style="border-color:${urgColors[urg] || '#888'};">
                    <span class="sh-timeline-event-date">${time}</span>
                    <span class="sh-timeline-event-loc">${escapeHtml(loc)}</span>
                    <span>${escapeHtml((item.title || '').substring(0, 100))}</span>
                </div>`;
            }).join('')}
        </div>
    `;
}

// ═══════ WHATSAPP GREEN API INTEGRATION ═══════
const WA_STORAGE_KEY = 'mabat188-wa-config';
let waConfig = JSON.parse(localStorage.getItem(WA_STORAGE_KEY) || 'null') || { instanceId: '', apiToken: '', monitoredGroups: [], isMonitoring: false };
let waPollingTimer = null;
let waMessageCount = 0;
let waLastNotificationId = null;

function getWaBaseUrl() {
    return `https://api.green-api.com/waInstance${waConfig.instanceId}`;
}

function toggleWhatsApp() {
    const overlay = document.getElementById('waOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        // Restore saved settings
        if (waConfig.instanceId) document.getElementById('waInstanceId').value = waConfig.instanceId;
        if (waConfig.apiToken) document.getElementById('waApiToken').value = waConfig.apiToken;
        if (waConfig.instanceId && waConfig.apiToken) {
            checkWaStatus();
        }
    }
}

async function checkWaStatus() {
    const instanceId = document.getElementById('waInstanceId').value.trim();
    const apiToken = document.getElementById('waApiToken').value.trim();
    if (!instanceId || !apiToken) return;

    waConfig.instanceId = instanceId;
    waConfig.apiToken = apiToken;

    const dot = document.getElementById('waStatusDot');
    const text = document.getElementById('waStatusText');
    text.textContent = 'בודק...';

    try {
        const res = await fetch(`${getWaBaseUrl()}/getStateInstance/${apiToken}`);
        const data = await res.json();

        if (data.stateInstance === 'authorized') {
            dot.classList.add('connected');
            text.textContent = 'מחובר';
            text.style.color = '#25D366';
            document.getElementById('waGroupsSection').style.display = 'block';
            document.getElementById('waQrContainer').style.display = 'none';
            updateWaButton(true);

            // Auto-load groups
            loadWaGroups();

            // If was monitoring, restart
            if (waConfig.isMonitoring && waConfig.monitoredGroups.length > 0) {
                startWaMonitoring();
            }
        } else if (data.stateInstance === 'notAuthorized' || data.stateInstance === 'sleepMode') {
            dot.classList.remove('connected');
            text.textContent = 'לא מאומת - יש לסרוק QR';
            text.style.color = 'var(--orange)';
            getWaQrCode();
        } else {
            dot.classList.remove('connected');
            text.textContent = `סטטוס: ${data.stateInstance || 'לא ידוע'}`;
            text.style.color = 'var(--red)';
        }
    } catch (e) {
        dot.classList.remove('connected');
        text.textContent = 'שגיאת חיבור';
        text.style.color = 'var(--red)';
        console.error('WA status error:', e);
    }
}

async function getWaQrCode() {
    try {
        const res = await fetch(`${getWaBaseUrl()}/qr/${waConfig.apiToken}`);
        const data = await res.json();
        if (data.message && data.message.startsWith('data:image')) {
            document.getElementById('waQrImg').src = data.message;
            document.getElementById('waQrContainer').style.display = 'block';
        }
    } catch (e) {
        console.error('WA QR error:', e);
    }
}

async function connectWhatsApp() {
    const instanceId = document.getElementById('waInstanceId').value.trim();
    const apiToken = document.getElementById('waApiToken').value.trim();
    if (!instanceId || !apiToken) {
        alert('יש להזין Instance ID ו-API Token');
        return;
    }
    waConfig.instanceId = instanceId;
    waConfig.apiToken = apiToken;
    saveWaConfig();
    await checkWaStatus();
}

async function loadWaGroups() {
    const list = document.getElementById('waGroupsList');
    const count = document.getElementById('waGroupCount');
    list.innerHTML = '<div style="color:var(--text-dim);font-size:11px;padding:8px;">טוען קבוצות...</div>';

    try {
        const res = await fetch(`${getWaBaseUrl()}/getContacts/${waConfig.apiToken}`);
        const contacts = await res.json();
        const groups = contacts.filter(c => c.id && c.id.endsWith('@g.us') && c.name);

        count.textContent = `${groups.length} קבוצות נמצאו`;

        if (groups.length === 0) {
            list.innerHTML = '<div style="color:var(--text-dim);font-size:11px;padding:8px;">לא נמצאו קבוצות</div>';
            return;
        }

        list.innerHTML = groups.map(g => {
            const isSelected = waConfig.monitoredGroups.includes(g.id);
            return `<label class="wa-group-item${isSelected ? ' selected' : ''}" data-gid="${g.id}">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleWaGroup('${g.id}', this)">
                <span>${escapeHtml(g.name)}</span>
            </label>`;
        }).join('');
    } catch (e) {
        list.innerHTML = '<div style="color:var(--red);font-size:11px;padding:8px;">שגיאה בטעינת קבוצות</div>';
        console.error('WA groups error:', e);
    }
}

function toggleWaGroup(groupId, checkbox) {
    const item = checkbox.closest('.wa-group-item');
    if (checkbox.checked) {
        if (!waConfig.monitoredGroups.includes(groupId)) {
            waConfig.monitoredGroups.push(groupId);
        }
        item.classList.add('selected');
    } else {
        waConfig.monitoredGroups = waConfig.monitoredGroups.filter(id => id !== groupId);
        item.classList.remove('selected');
    }
}

function saveWaSettings() {
    saveWaConfig();
    if (waConfig.monitoredGroups.length === 0) {
        alert('יש לבחור לפחות קבוצה אחת');
        return;
    }
    startWaMonitoring();
}

function startWaMonitoring() {
    waConfig.isMonitoring = true;
    saveWaConfig();

    document.getElementById('waMonitorSection').style.display = 'block';
    updateWaButton(true);
    updateWaMonitorStats();

    // Start polling for new messages
    if (waPollingTimer) clearInterval(waPollingTimer);
    pollWaMessages();
    waPollingTimer = setInterval(pollWaMessages, 10000); // Every 10 seconds
}

function stopWaMonitoring() {
    waConfig.isMonitoring = false;
    saveWaConfig();

    if (waPollingTimer) {
        clearInterval(waPollingTimer);
        waPollingTimer = null;
    }

    document.getElementById('waMonitorSection').style.display = 'none';
    updateWaButton(false);
}

async function pollWaMessages() {
    try {
        const res = await fetch(`${getWaBaseUrl()}/receiveNotification/${waConfig.apiToken}`);
        const data = await res.json();

        if (!data || !data.body) return;

        const receiptId = data.receiptId;
        const body = data.body;

        // Process incoming group messages
        if (body.typeWebhook === 'incomingMessageReceived' && body.senderData) {
            const chatId = body.senderData.chatId || '';
            const isGroup = chatId.endsWith('@g.us');

            if (isGroup && waConfig.monitoredGroups.includes(chatId)) {
                const msgData = body.messageData;
                let messageText = '';

                if (msgData.typeMessage === 'textMessage') {
                    messageText = msgData.textMessageData?.textMessage || '';
                } else if (msgData.typeMessage === 'extendedTextMessage') {
                    messageText = msgData.extendedTextMessageData?.text || '';
                } else if (msgData.typeMessage === 'imageMessage' || msgData.typeMessage === 'videoMessage') {
                    messageText = msgData.fileMessageData?.caption || `[${msgData.typeMessage === 'imageMessage' ? 'תמונה' : 'וידאו'}]`;
                } else if (msgData.typeMessage === 'documentMessage') {
                    messageText = `[מסמך: ${msgData.fileMessageData?.fileName || ''}]`;
                }

                if (messageText) {
                    await processWaMessage({
                        text: messageText,
                        groupName: body.senderData.senderName || body.senderData.chatName || chatId,
                        chatId: chatId,
                        sender: body.senderData.senderContactName || body.senderData.senderName || '',
                        timestamp: body.timestamp * 1000 || Date.now()
                    });
                }
            }
        }

        // Delete notification after processing
        await fetch(`${getWaBaseUrl()}/deleteNotification/${waConfig.apiToken}/${receiptId}`, { method: 'DELETE' });

        // Continue polling if there are more notifications
        pollWaMessages();

    } catch (e) {
        // Silent - will retry on next interval
    }
}

async function processWaMessage(msg) {
    waMessageCount++;
    updateWaMonitorStats();
    addWaRecentMessage(msg);

    // Build alert object in same format as existing alerts
    const alertId = `wa-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const alertData = {
        title: msg.text.length > 120 ? msg.text.substring(0, 120) + '...' : msg.text,
        fullText: msg.text,
        snippet: msg.text.substring(0, 200),
        source: `WhatsApp: ${msg.groupName}`,
        sourceType: 'whatsapp',
        timestamp: msg.timestamp,
        urgency: 2,
        locationHe: '',
        isWhatsApp: true,
        sender: msg.sender
    };

    // Auto-detect urgency from keywords
    const urgentKeywords = ['ירי','פיצוץ','פגיעה','רקטה','חדירה','מטען','אזעקה','פצועים','הרוגים','חיסול','תקיפה','הפצצה'];
    const highKeywords = ['חשוד','רחפן','תצפית','תנועה חשודה','כוחות','טנק','שיגור','חילוץ'];
    const textLower = msg.text;

    for (const kw of urgentKeywords) {
        if (textLower.includes(kw)) { alertData.urgency = 5; break; }
    }
    if (alertData.urgency < 5) {
        for (const kw of highKeywords) {
            if (textLower.includes(kw)) { alertData.urgency = 4; break; }
        }
    }

    // Try to detect location
    const allLocs = [...IN_SECTOR, ...P1_LOCATIONS.map(l => l.he), ...P2_LOCATIONS.map(l => l.he)];
    for (const loc of allLocs) {
        if (textLower.includes(loc)) {
            alertData.locationHe = loc;
            break;
        }
    }

    // Save to Firebase
    try {
        await fetch(`${FIREBASE_URL}/auto-news/${alertId}.json`, {
            method: 'PUT',
            body: JSON.stringify(alertData)
        });

        // Update local data and re-render
        if (isInSector(alertData) || alertData.isWhatsApp) {
            newsData[alertId] = alertData;
            allNewsData[alertId] = alertData;
            knownIds.add(alertId);

            if (alertData.urgency >= 5) triggerRedAlert();
            renderAll();
        }
    } catch (e) {
        console.error('WA save to Firebase error:', e);
    }
}

function addWaRecentMessage(msg) {
    const container = document.getElementById('waRecentMessages');
    if (!container) return;
    const time = new Date(msg.timestamp).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
    const msgEl = document.createElement('div');
    msgEl.className = 'wa-msg-item';
    msgEl.innerHTML = `<span class="wa-msg-group">${escapeHtml(msg.groupName)}</span> <span class="wa-msg-time">${time}</span><br>${escapeHtml(msg.text.substring(0, 80))}${msg.text.length > 80 ? '...' : ''}`;
    container.insertBefore(msgEl, container.firstChild);

    // Keep only last 20
    while (container.children.length > 20) container.removeChild(container.lastChild);
}

function updateWaMonitorStats() {
    const stats = document.getElementById('waMonitorStats');
    if (!stats) return;
    stats.innerHTML = `
        <div class="wa-stat-card"><div class="wa-stat-num">${waConfig.monitoredGroups.length}</div><div class="wa-stat-label">קבוצות</div></div>
        <div class="wa-stat-card"><div class="wa-stat-num">${waMessageCount}</div><div class="wa-stat-label">הודעות נקלטו</div></div>
    `;
}

function updateWaButton(active) {
    const btn = document.getElementById('waBtn');
    const configStatus = document.getElementById('waConfigStatus');
    if (btn) {
        if (active) {
            btn.style.color = '#000';
            btn.style.background = '#25D366';
            btn.style.borderColor = '#25D366';
            btn.innerHTML = '<span class="btn-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align:middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></span><span>WA פעיל</span>';
        } else {
            btn.style.color = '#25D366';
            btn.style.background = 'transparent';
            btn.style.borderColor = '#25D366';
            btn.innerHTML = '<span class="btn-icon"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align:middle;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></span><span>WhatsApp</span>';
        }
    }
    if (configStatus) {
        configStatus.textContent = active ? `פעיל (${waConfig.monitoredGroups.length} קבוצות)` : 'לא פעיל';
        configStatus.style.color = active ? '#25D366' : 'var(--text-dim)';
    }
}

function saveWaConfig() {
    localStorage.setItem(WA_STORAGE_KEY, JSON.stringify(waConfig));
}

// Add WhatsApp as source in מקורות
מקורות.push({ id: 'whatsapp', name: 'WhatsApp', type: 'local', icon: '&#128172;' });

// ═══════ NASA FIRMS - REAL SATELLITE FIRE/EXPLOSION DETECTION ═══════
let firmsMarkers = [];

async function fetchFirmsFromFirebase() {
    try {
        const res = await fetch(`${FIREBASE_URL}/firms.json`);
        const data = await res.json();
        if (!data || !data.points || data.points.length === 0) return;
        clearFirmsMarkers();
        data.points.forEach(p => {
            const size = p.confidence === 'high' || p.confidence === 'h' ? 16 : p.confidence === 'nominal' || p.confidence === 'n' ? 12 : 8;
            const icon = L.divIcon({
                className: '',
                html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:radial-gradient(circle,#ff4400 30%,rgba(255,68,0,0.3) 70%);border:1px solid #ff6600;box-shadow:0 0 8px rgba(255,68,0,0.6);animation:firmsPulse 2s ease-in-out infinite;"></div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
            const marker = L.marker([p.lat, p.lng], { icon }).bindPopup(
                `<div style="direction:rtl;font-family:Heebo;font-size:12px;">
                    <b style="color:#ff4400;">NASA FIRMS ${p.sensor || 'VIIRS'}</b><br>
                    ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}<br>
                    עוצמה: <b>${p.confidence}</b>
                    ${p.brightness ? `<br>בהירות: ${p.brightness}K` : ''}
                    ${p.frp ? `<br>FRP: ${p.frp} MW` : ''}
                    ${p.date ? `<br>${p.date} ${p.time}` : ''}
                </div>`, { className: 'firms-popup' }
            );
            firmsMarkers.push(marker);
            if (firmsVisible) marker.addTo(map);
        });
        console.log(`FIRMS: ${data.points.length} points loaded from Firebase (${data.fetchedAtISO || ''})`);
    } catch (e) {
        console.log('FIRMS fetch error:', e.message);
    }
}

function clearFirmsMarkers() {
    firmsMarkers.forEach(m => m.remove());
    firmsMarkers = [];
}

function toggleFirmsLayer() {
    firmsVisible = !firmsVisible;
    const btn = document.getElementById('firmsToggle');
    if (firmsVisible) {
        btn.classList.add('active');
        btn.textContent = 'FIRMS ON';
        firmsMarkers.forEach(m => m.addTo(map));
        if (firmsMarkers.length === 0) fetchFirmsFromFirebase();
    } else {
        btn.classList.remove('active');
        btn.textContent = 'FIRMS';
        firmsMarkers.forEach(m => m.remove());
    }
}

// ═══════ WHATSAPP INTELLIGENCE ═══════
async function fetchWhatsAppData() {
    try {
        const res = await fetch(`${FIREBASE_URL}/whatsapp-intel.json`);
        const data = await res.json();
        if (data && !data.error) {
            waData = data;
            renderWhatsApp();
            return;
        }
    } catch (e) {}
    // Show empty state if Firebase endpoint not yet configured (demo data only via הדגמה button)
    const waContainer = document.getElementById('waFeed');
    if (waContainer) {
        waContainer.innerHTML = '<div style="padding:20px 15px;text-align:center;color:var(--text-dim);font-family:var(--font-he);font-size:11px;">אין נתוני WhatsApp.<br>הגדר חיבור Green API או לחץ על \'הדגמה\'.</div>';
    }
}

function renderWhatsAppDemo() {
    const demoGroups = [
        {
            name: 'اهالي خان يونس الأحرار',
            members: 847,
            activity: 'hot',
            messages: [
                { text: 'قصف عنيف في المنطقة الشرقية', time: Date.now() - 120000, urgency: 4 },
                { text: 'انقطاع الاتصالات في حي الأمل', time: Date.now() - 300000, urgency: 3 },
                { text: 'حركة مركبات عسكرية على شارع صلاح الدين', time: Date.now() - 600000, urgency: 5 },
            ]
        },
        {
            name: 'اخبار رفح العاجلة',
            members: 1253,
            activity: 'active',
            messages: [
                { text: 'طائرات استطلاع تحلق فوق تل السلطان', time: Date.now() - 180000, urgency: 3 },
                { text: 'وصول مساعدات إنسانية عبر معبر كرم أبو سالم', time: Date.now() - 900000, urgency: 1 },
            ]
        },
        {
            name: 'تنسيق الإغاثة - جنوب غزة',
            members: 534,
            activity: 'normal',
            messages: [
                { text: 'توزيع طرود غذائية في مدرسة UNRWA بخان يونس', time: Date.now() - 480000, urgency: 1 },
                { text: 'نقص حاد في الأدوية بمستشفى ناصر', time: Date.now() - 1200000, urgency: 3 },
            ]
        },
        {
            name: 'شبكة الانذار المبكر',
            members: 2100,
            activity: 'hot',
            messages: [
                { text: 'تحذير: تحركات مشبوهة شرق عبسان الكبيرة', time: Date.now() - 60000, urgency: 5 },
                { text: 'إنذار بإخلاء حي المنارة', time: Date.now() - 240000, urgency: 5 },
                { text: 'سماع أصوات انفجارات قرب مفترق المحطة', time: Date.now() - 420000, urgency: 4 },
            ]
        },
        {
            name: 'صحفيي غزة الميدانيين',
            members: 376,
            activity: 'active',
            messages: [
                { text: 'تغطية مباشرة: آثار القصف على حي الأمل', time: Date.now() - 360000, urgency: 3 },
                { text: 'بيان من وزارة الصحة: ارتفاع عدد الشهداء', time: Date.now() - 720000, urgency: 4 },
            ]
        }
    ];
    waData = { groups: demoGroups };
    renderWhatsApp();
}

function renderWhatsApp() {
    const container = document.getElementById('waFeed');
    const groups = waData.groups || [];
    document.getElementById('waCount').textContent = `${groups.length} קבוצות`;

    if (groups.length === 0) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:11px;">אין נתונים</div>';
        return;
    }

    let html = '';
    groups.forEach(group => {
        const badgeClass = group.activity === 'hot' ? 'hot' : group.activity === 'active' ? 'active' : 'normal';
        const badgeText = group.activity === 'hot' ? 'חם' : group.activity === 'active' ? 'פעיל' : 'רגיל';
        html += `<div class="wa-group-header" style="background:rgba(37,211,102,0.03);">
            <span style="font-weight:600;">${group.name}</span>
            <span><span class="wa-badge ${badgeClass}">${badgeText}</span> ${group.members} חברים</span>
        </div>`;
        (group.messages || []).forEach(msg => {
            const urgColor = msg.urgency >= 5 ? 'var(--red)' : msg.urgency >= 4 ? 'var(--orange)' : msg.urgency >= 3 ? 'var(--yellow)' : 'var(--text-secondary)';
            const timeStr = formatTimeAgo(msg.time);
            html += `<div class="wa-status-item">
                <div class="wa-avatar" style="border-color:${urgColor};background:${urgColor}15;">
                    <span style="color:${urgColor};">${msg.urgency}</span>
                </div>
                <div class="wa-info">
                    <div class="wa-msg" style="white-space:normal;direction:rtl;">${escapeHtml(msg.text)}</div>
                </div>
                <div class="wa-time">${timeStr}</div>
            </div>`;
        });
    });
    container.innerHTML = html;
}

function formatTimeAgo(ts) {
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'עכשיו';
    if (mins < 60) return `${mins}ד'`;
    const hours = Math.floor(mins / 60);
    if (hours < 24) return `${hours}ש'`;
    return `${Math.floor(hours / 24)}י'`;
}

// ═══════ TARGET SEARCH ═══════
function searchTarget() {
    const input = document.getElementById('targetSearchInput').value.trim();
    if (!input) return;
    const container = document.getElementById('targetResults');

    if (!isDemoMode) {
        container.innerHTML = '<div style="padding:30px 15px;text-align:center;color:var(--text-dim);font-family:var(--font-he);font-size:11px;">חיפוש OSINT דורש חיבור API חיצוני.<br>לחץ על \'הדגמה\' לצפייה בדוגמה.</div>';
        return;
    }

    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--cyan);font-size:11px;">סורק 400+ פלטפורמות...</div>';

    // Simulate search with realistic results (demo mode only)
    setTimeout(() => {
        const isPhone = /^[\+0-9\s()-]+$/.test(input);
        const isEmail = /@/.test(input);
        const platforms = generateTargetResults(input, isPhone, isEmail);
        renderTargetResults(input, platforms, isPhone, isEmail);
        addTargetToGraph(input, platforms);
    }, 1500);
}

function generateTargetResults(query, isPhone, isEmail) {
    const allPlatforms = isPhone ? [
        { name: 'WhatsApp', found: true, info: 'פרופיל פעיל, תמונה זמינה' },
        { name: 'Telegram', found: Math.random() > 0.3, info: 'משתמש רשום' },
        { name: 'Viber', found: Math.random() > 0.5, info: 'חשבון פעיל' },
        { name: 'Signal', found: false, info: '' },
        { name: 'Truecaller', found: true, info: 'שם: محمد / מוחמד' },
        { name: 'GetContact', found: Math.random() > 0.4, info: 'נמצאו 3 תגיות' },
        { name: 'Facebook', found: Math.random() > 0.5, info: 'חשבון משויך' },
        { name: 'Instagram', found: false, info: '' },
    ] : isEmail ? [
        { name: 'Google', found: true, info: 'חשבון פעיל' },
        { name: 'Facebook', found: Math.random() > 0.3, info: 'פרופיל נמצא' },
        { name: 'Twitter/X', found: Math.random() > 0.5, info: '@user' },
        { name: 'LinkedIn', found: Math.random() > 0.5, info: 'פרופיל מקצועי' },
        { name: 'Instagram', found: Math.random() > 0.6, info: 'חשבון פעיל' },
        { name: 'TikTok', found: false, info: '' },
        { name: 'Telegram', found: Math.random() > 0.5, info: 'חשבון משויך' },
        { name: 'Gravatar', found: Math.random() > 0.5, info: 'תמונה זמינה' },
    ] : [
        { name: 'Telegram', found: true, info: 'ערוץ / משתמש פעיל' },
        { name: 'Twitter/X', found: Math.random() > 0.3, info: `@${query}` },
        { name: 'Instagram', found: Math.random() > 0.4, info: `${Math.floor(Math.random() * 5000)} עוקבים` },
        { name: 'Facebook', found: Math.random() > 0.3, info: 'פרופיל ציבורי' },
        { name: 'TikTok', found: Math.random() > 0.5, info: 'חשבון נמצא' },
        { name: 'YouTube', found: Math.random() > 0.6, info: 'ערוץ פעיל' },
        { name: 'Reddit', found: Math.random() > 0.7, info: `u/${query}` },
        { name: 'GitHub', found: Math.random() > 0.7, info: 'חשבון מפתח' },
        { name: 'LinkedIn', found: Math.random() > 0.6, info: 'פרופיל מקצועי' },
        { name: 'WhatsApp', found: false, info: '' },
        { name: 'Pinterest', found: Math.random() > 0.8, info: '' },
        { name: 'Snapchat', found: Math.random() > 0.8, info: '' },
    ];
    return allPlatforms;
}

function renderTargetResults(query, platforms, isPhone, isEmail) {
    const container = document.getElementById('targetResults');
    const found = platforms.filter(p => p.found).length;
    const total = platforms.length;
    const icon = isPhone ? '&#128222;' : isEmail ? '&#9993;' : '&#128100;';
    const typeLabel = isPhone ? 'מספר טלפון' : isEmail ? 'אימייל' : 'שם משתמש';

    let html = `<div class="target-result">
        <div class="target-header">
            <div class="target-avatar">${icon}</div>
            <div>
                <div class="target-name">${escapeHtml(query)}</div>
                <div class="target-username">${typeLabel} | נמצא ב-${found}/${total} פלטפורמות</div>
            </div>
        </div>
        <div class="target-stats">
            <div><span class="target-stat-num" style="color:var(--green);">${found}</span>נמצא</div>
            <div><span class="target-stat-num" style="color:var(--red);">${total - found}</span>לא נמצא</div>
            <div><span class="target-stat-num" style="color:var(--cyan);">${total}</span>נסרקו</div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;">`;

    platforms.sort((a, b) => b.found - a.found).forEach(p => {
        const cls = p.found ? 'found' : 'not-found';
        const check = p.found ? '&#10003; ' : '';
        html += `<div class="target-platform ${cls}" title="${p.info}">${check}${p.name}</div>`;
    });

    html += '</div>';

    // Show found platform details
    const foundPlatforms = platforms.filter(p => p.found && p.info);
    if (foundPlatforms.length > 0) {
        html += '<div style="margin-top:10px;border-top:1px solid var(--border-primary);padding-top:8px;">';
        foundPlatforms.forEach(p => {
            html += `<div style="font-family:var(--font-he);font-size:10px;color:var(--text-secondary);padding:2px 0;">
                <span style="color:var(--green);">${p.name}</span>: ${p.info}
            </div>`;
        });
        html += '</div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

// ═══════ NETWORK GRAPH (vis.js) ═══════
function initNetworkGraph() {
    if (typeof vis === 'undefined') {
        console.log('vis.js not loaded');
        document.getElementById('networkGraph').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:11px;">טוען ספריית גרף...</div>';
        return;
    }

    networkNodes = new vis.DataSet();
    networkEdges = new vis.DataSet();

    // Build initial graph from sources + known relationships
    buildInitialGraph();

    const container = document.getElementById('networkGraph');
    const data = { nodes: networkNodes, edges: networkEdges };
    const options = {
        nodes: {
            shape: 'dot',
            font: { color: '#e0e8f0', face: 'Heebo', size: 10 },
            borderWidth: 2,
            shadow: { enabled: true, color: 'rgba(0,0,0,0.5)', size: 5 }
        },
        edges: {
            color: { color: '#0f3460', highlight: '#00d4ff', opacity: 0.6 },
            width: 1,
            smooth: { type: 'continuous' }
        },
        physics: {
            solver: 'forceAtlas2Based',
            forceAtlas2Based: { gravitationalConstant: -30, centralGravity: 0.005, springLength: 120 },
            stabilization: { iterations: 100 }
        },
        interaction: { hover: true, tooltipDelay: 100 },
        layout: { improvedLayout: true }
    };

    networkGraph = new vis.Network(container, data, options);
    networkGraph.once('stabilizationIterationsDone', function() {
        networkGraph.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
    });
    document.getElementById('graphNodeCount').textContent = `${networkNodes.length} צמתים`;
}

function buildInitialGraph() {
    // Central node - Khan Younis Sector
    networkNodes.add({ id: 'sector', label: 'גזרת חאן יונס', color: { background: '#00d4ff', border: '#00a0cc' }, size: 25, group: 'center' });

    // Telegram channels
    const tgChannels = מקורות.filter(s => s.tg);
    tgChannels.forEach((ch, i) => {
        networkNodes.add({
            id: `tg_${ch.id}`,
            label: ch.name,
            color: { background: '#0088cc', border: '#006699' },
            size: ch.type === 'local' ? 15 : 10,
            group: 'telegram',
            title: `Telegram: @${ch.tg}`
        });
        networkEdges.add({ from: 'sector', to: `tg_${ch.id}`, color: { color: '#0088cc44' } });
    });

    // WhatsApp groups (demo mode only — real groups come from Green API)
    if (isDemoMode) {
        const waGroups = [
            { id: 'wa_khan', name: 'اهالي خان يونس' },
            { id: 'wa_rafah', name: 'اخبار رفح' },
            { id: 'wa_relief', name: 'تنسيق الإغاثة' },
            { id: 'wa_alert', name: 'شبكة الانذار' },
            { id: 'wa_press', name: 'صحفيي غزة' },
        ];
        waGroups.forEach(g => {
            networkNodes.add({
                id: g.id,
                label: g.name,
                color: { background: '#25d366', border: '#128c46' },
                size: 12,
                group: 'whatsapp',
                title: `WhatsApp Group`
            });
            networkEdges.add({ from: 'sector', to: g.id, color: { color: '#25d36644' } });
        });
    }

    // Key figures and cross-links (demo mode only)
    if (isDemoMode) {
        const figures = [
            { id: 'fig_1', name: 'דמות מפתח A', connections: ['tg_QudsN', 'wa_alert', 'tg_palinfo'] },
            { id: 'fig_2', name: 'דמות מפתח B', connections: ['tg_SarayaAlQuds', 'wa_khan', 'tg_qaboranews'] },
            { id: 'fig_3', name: 'דמות מפתח C', connections: ['wa_press', 'tg_eyeonpal', 'tg_AJABreaking'] },
        ];
        figures.forEach(f => {
            networkNodes.add({
                id: f.id,
                label: f.name,
                color: { background: '#ff8800', border: '#cc6600' },
                size: 14,
                group: 'figure',
                shape: 'diamond'
            });
            f.connections.forEach(c => {
                if (networkNodes.get(c)) {
                    networkEdges.add({ from: f.id, to: c, color: { color: '#ff880044' }, dashes: true });
                }
            });
        });

        const crossLinks = [
            ['tg_QudsN', 'tg_palinfo'],
            ['tg_PalestineResist', 'tg_SarayaAlQuds'],
            ['tg_gazaalannet', 'tg_GazaNewsNow'],
            ['wa_khan', 'wa_alert'],
        ];
        crossLinks.forEach(([a, b]) => {
            if (networkNodes.get(a) && networkNodes.get(b)) {
                networkEdges.add({ from: a, to: b, color: { color: '#ffffff10' }, width: 0.5 });
            }
        });
    }
}

function setGraphView(view) {
    currentGraphView = view;
    document.querySelectorAll('.net-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    if (!networkNodes) return;
    const allNodes = networkNodes.get();
    const updates = allNodes.map(node => {
        let hidden = false;
        if (view === 'telegram') hidden = node.group && !['telegram', 'center', 'figure'].includes(node.group);
        if (view === 'whatsapp') hidden = node.group && !['whatsapp', 'center', 'figure'].includes(node.group);
        if (view === 'social') hidden = node.group && !['social', 'center', 'figure'].includes(node.group);
        return { id: node.id, hidden };
    });
    networkNodes.update(updates);
}

function addTargetToGraph(query, platforms) {
    if (!networkNodes) return;
    const nodeId = `target_${query}`;
    if (networkNodes.get(nodeId)) return; // Already exists

    networkNodes.add({
        id: nodeId,
        label: query,
        color: { background: '#a855f7', border: '#7c3aed' },
        size: 14,
        group: 'social',
        shape: 'star',
        title: `חיפוש: ${query}`
    });

    // Connect to found platforms
    platforms.filter(p => p.found).forEach(p => {
        const platformNodeId = `platform_${p.name}_${query}`;
        if (!networkNodes.get(platformNodeId)) {
            networkNodes.add({
                id: platformNodeId,
                label: p.name,
                color: { background: '#a855f744', border: '#a855f7' },
                size: 8,
                group: 'social',
                title: p.info
            });
        }
        networkEdges.add({ from: nodeId, to: platformNodeId, color: { color: '#a855f744' } });
    });

    // Connect to sector
    networkEdges.add({ from: 'sector', to: nodeId, color: { color: '#a855f722' }, dashes: true });
    document.getElementById('graphNodeCount').textContent = `${networkNodes.length} צמתים`;
}

// ═══════ INIT ═══════
document.addEventListener('DOMContentLoaded', () => {
    try { updateClock(); } catch(e) { console.error('Clock init error:', e); }
    setInterval(() => { try { updateClock(); } catch(e) {} }, 1000);

    try {
        if (typeof L !== 'undefined') {
            initMap();
        } else {
            console.error('Leaflet not loaded');
            document.getElementById('map').innerHTML = '<div style="color:#ff0040;padding:20px;text-align:center;">MAP: Leaflet loading...</div>';
            // Retry after 2 seconds
            setTimeout(() => {
                try { if (typeof L !== 'undefined') initMap(); } catch(e) { console.error('Map retry error:', e); }
            }, 2000);
        }
    } catch(e) { console.error('Map init error:', e); }

    try { fetchData(); } catch(e) { console.error('Fetch init error:', e); }
    try { loadJournalNotes(); } catch(e) { console.error('Notes init error:', e); }
    try { loadAlertVotes(); } catch(e) { console.error('Votes init error:', e); }
    try { loadPublisherProfiles(); } catch(e) { console.error('Profiles init error:', e); }
    try { startRefreshCycle(); } catch(e) { console.error('Refresh init error:', e); }
    try { fetchWeatherDirect(); } catch(e) {}
    try { checkCalendarLocal(); } catch(e) {}

    // Auto-resume WhatsApp monitoring if was active
    if (waConfig.instanceId && waConfig.apiToken && waConfig.isMonitoring) {
        setTimeout(() => { try { checkWaStatus(); } catch(e) {} }, 3000);
    }

    // OSINT Panels init
    try { initFirmsLayer(); } catch(e) { console.error('FIRMS init error:', e); }
    try { fetchWhatsAppData(); } catch(e) { console.error('WhatsApp init error:', e); }
    try { setTimeout(() => initNetworkGraph(), 500); } catch(e) { console.error('Graph init error:', e); }
});
</script>
</body>
</html>
